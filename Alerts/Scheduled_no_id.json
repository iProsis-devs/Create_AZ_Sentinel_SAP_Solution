[
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/f1056f8d-f3b0-49e2-a50f-94b9ea26f0b9')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - High - Activation or Deactivation of ICF Service",
            "description": "Identifies activation or deactivation of ICF Services.\nSource Action: Activate or deactivate a service using SICF.\n*Data Sources: SAPcon - Table Data Log*",
            "severity": "High",
            "enabled": true,
            "query": "let ActivatedICF =\r\nABAPTableDataLog_CL\r\n| where TableName_s == \"ICFSERVLOC\"\r\n| lookup ABAPTableDataLog_CL on TimeGenerated, LogKey_s, DBLogID_s // Lookup for combining the data\r\n| where TableField_s == \"ICF_NAME\" // Service name\r\n| where TableField_s1 == \"ICFACTIVE\" // Active status\r\n| where OldValue_s == NewValue_s and OldValue_s != \"\" \r\n| where NewValue_s1 == \"X\" // Status is activated\r\n| project TimeGenerated, Service = NewValue_s, ICFServiceStatus = \"Activated\";\r\nABAPTableDataLog_CL\r\n| where TableName_s == \"ICFSERVLOC\"\r\n| lookup ABAPTableDataLog_CL on TimeGenerated, LogKey_s, DBLogID_s // Lookup for combining the data\r\n| where TableField_s == \"ICF_NAME\" // Service name\r\n| where TableField_s1 == \"ICFACTIVE\" // Active status\r\n| where OldValue_s1 == \"X\" // Was activated\r\n| where NewValue_s1 == \"\" // Not activated now\r\n| where OldValue_s == NewValue_s and OldValue_s != \"\"\r\n| project TimeGenerated, Service = NewValue_s, ICFServiceStatus = \"Deactivated\"\r\n| union ActivatedICF\r\n",
            "queryFrequency": "PT2H",
            "queryPeriod": "PT2H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "CommandAndControl",
                "LateralMovement",
                "Persistence"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": null,
                    "groupByCustomDetails": null
                }
            },
            "eventGroupingSettings": null,
            "alertDetailsOverride": null,
            "customDetails": null,
            "entityMappings": null
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/0a7f972b-55b9-492c-8fe4-ac04a8dc3aec')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - High - Change in Sensitive privileged user",
            "description": "Identifies changes  of sensitive privileged users. \n\nSource Action: Change user details / authorizations using SU01.\n\nPriveleged users should be maintained in \"SAP - Privileged Users\" Watchlist\n\n*Data Sources: SAPcon -  Audit Log*",
            "severity": "High",
            "enabled": true,
            "query": "// Audit Log Classes - User Master Changes\r\nlet AuditClasses = dynamic(['AU7', 'BUV', 'BUW', 'AU8', 'AU9', 'AUA', 'AUB', 'AUD', 'DUH', 'BU2']);\r\n// Get Relevant User from WatchList\r\nlet PrivelegedUsers = _GetWatchlist('SAP - Privileged Users');\r\nlet fixedUsers = datatable(User: string)\r\n    // Maintain these if WatchList is not available    \r\n    [\"SAP*\", \"DDIC\"]\r\n;\r\nlet SensProfiles = _GetWatchlist('SAP - Sensitive Profiles') | summarize  by Profile;\r\nlet SensRoles = _GetWatchlist('SAP - Sensitive Roles') | summarize  by Role;\r\n// Maintain these if System doesn't have CR's\r\nlet FixedUserMD = datatable(TimeGenerated : datetime, UserName_s : string, RoleMembership_s : string)[];\r\nlet ABAPUserMd = \r\nunion isfuzzy=true table(\"ABAPUserMD_CL\"), FixedUserMD;\r\n// Priveleged Users by sensitive role/profile based on user master data\r\nlet PrivUserdByMD = ABAPUserMd\r\n| extend Roles = parse_json(RoleMembership_s)[\"SapRole\"], Profiles = parse_json(RoleMembership_s)[\"SapProfile\"]\r\n| mv-expand Roles, Profiles\r\n| where Roles in (SensRoles) or Profiles in (SensProfiles)\r\n| summarize by User = UserName_s;\r\nlet UnitedPrivleged = union PrivelegedUsers, fixedUsers, PrivUserdByMD\r\n| summarize by User;\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| where Variable1_s in (UnitedPrivleged) // The user that we are making change in is a sensitive privileged user\r\n| project TimeGenerated, Instance_s,  SystemID_s, ClientID_s, User_s, MessageText_s, MessageID_s, Email_s,  TerminalIPv6_s, Host_s\r\n",
            "queryFrequency": "PT1H",
            "queryPeriod": "PT1H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "PrivilegeEscalation",
                "CredentialAccess"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_System_I_D": "SystemID_s",
                "SAP_Client": "ClientID_s",
                "SAP_Instance": "Instance_s",
                "SAP_User": "User_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/9f26d131-a227-4ad2-b4d9-b1e9cf402939')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - High - Client Configuration Change",
            "description": "Identifies changes for client configuration such as: Client role, Changes recording mode. \n\nSource Action:  Perofrm client configurations changes using SCC4 transaction code. \n\n*Data Sources: SAPcon -  Audit Log*",
            "severity": "High",
            "enabled": true,
            "query": "// Audit Log Classes - Client Change Configuration\r\nlet AuditClasses = dynamic(['EU2']); // Relevent message\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| project-rename  ClientID = Variable1_s \r\n| parse Variable2_s with Currency \"|\" ClientRole \"|\" RecordingChanges \"|\" CrossClientObjectChanges \"|\" ClientCopyProtectionLevel \"|\" ProtectionSAPUpgrade \"|\" CATTeCATT \"|\"  LockedforCopy // Parse every object before the | char \r\n| project TimeGenerated, Instance_s, SystemID_s, User_s, ClientID, \r\nCurrency,ClientRole,RecordingChanges,CrossClientObjectChanges,ClientCopyProtectionLevel,CATTeCATT,LockedforCopy,ProtectionSAPUpgrade,\r\nMessageText_s, Email_s, TerminalIPv6_s,  Host_s\r\n",
            "queryFrequency": "PT5H",
            "queryPeriod": "PT5H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "DefenseEvasion",
                "Exfiltration",
                "Persistence"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_User": "User_s",
                "SAP_Client": "ClientID",
                "SAP_Instance": "Instance_s",
                "SAP_System_I_D": "SystemID_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/907f4978-7b8d-4d1b-a2d6-3bf5b06438b8')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - High - Data has Changed during Debugging Activity",
            "description": "Identifies changes for runtime data during a debugging activity.\nSource Action: Activate Debug (\"/h\"), Select a field for change and update it's value.\n\n**Recommended for Production only**\n\n*Data Sources: SAPcon -  Audit Log*",
            "severity": "High",
            "enabled": true,
            "query": "let Role = 'Production';\r\nlet AuditClasses = dynamic(['CUL']); // Audit Log Classes - Debug Change\r\nlet allSystemRoles = dynamic(['Sandbox','Developement','QualityAssurance','Training','Production']); // Available System Roles\r\nlet allSystemUsage = dynamic (['ERP','CRM','BW','Solman','Gateway','Enterprise Portal']); // Available System Usages\r\n// Get Relevant Systems from WatchList\r\nlet systemID = _GetWatchlist('SAP - Systems');\r\nlet fixedSID = datatable(SystemID:string, SystemRole:string, SystemUsage:string)\r\n// Maintain these if WatchList is not available    \r\n    [\"S4H\",\"Production\",\"ERP\",\r\n    \"XXX\",\"Sandbox\",\"BW\"]\r\n;\r\nlet UnitedSystem = \r\nunion systemID, fixedSID\r\n| summarize by SystemID, SystemRole, SystemUsage\r\n| where SystemRole == Role; // Recommended  is Production only\r\n//| where SystemRole in (allSystemRoles); // Use this for all system roles\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| project-rename SystemID = SystemID_s\r\n| lookup kind = inner (UnitedSystem) on SystemID\r\n| project TimeGenerated,ClientID_s, Instance_s, User_s, MessageText_s, ABAPProgramName_s, TransactionCode_s, SystemID, SystemRole, SystemUsage, Email_s,TerminalIPv6_s, Host_s\r\n",
            "queryFrequency": "PT1H",
            "queryPeriod": "PT1H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "Execution",
                "LateralMovement"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_Instance": "Instance_s",
                "SAP_System_I_D": "SystemID",
                "SAP_Client": "ClientID_s",
                "SAP_User": "User_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/0b85a077-8ba5-4cb5-90f7-1e882afe10c1')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - High - Deactivation of Security Audit Log",
            "description": "Identifies deactivation of Security Audit Log\n\nSource Action: Disable secruity Audit Log using SM19/RSAU_CONFIG.\n\n*Data Sources: SAPcon -  Audit Log*",
            "severity": "High",
            "enabled": true,
            "query": "// Audit Log Classes - Audit Log Active Status Events\r\nlet AuditClasses = dynamic(['AUJ']);\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| where Variable1_s == '0' // Audit Active Status = 0\r\n| project \r\n// Details\r\nTimeGenerated, Instance_s ,SystemID_s, ClientID_s, User_s, MessageText_s, Email_s, TerminalIPv6_s, Host_s",
            "queryFrequency": "PT1H",
            "queryPeriod": "PT1H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "Exfiltration",
                "DefenseEvasion",
                "Persistence"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_User": "User_s",
                "SAP_Client": "ClientID_s",
                "SAP_System_I_D": "SystemID_s",
                "SAP_Instance": "Instance_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/dc40a634-49ef-4df3-a860-fa791937be79')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - High - Execution of a Sensitive ABAP Program",
            "description": "Identifies direct execution of a sensitive ABAP program. \n\nSource Action: Execute a program directly using SE38/SA38/SE80.\n\n**Recommended for Production only**\n\nABAP Programs should be maintained in watchlist \"SAP - Sensitive ABAP Programs\"\n\n*Data Sources: SAPcon -  Audit Log*",
            "severity": "High",
            "enabled": true,
            "query": "// Define Variables\r\nlet Role = \"Production\";\r\nlet AuditClasses = dynamic(['AUW']); // Audit Log Classes - Report Started\r\nlet allSystemRoles = dynamic(['Sandbox','Developement','QualityAssurance','Training','Production']); // Available System Roles\r\nlet allSystemUsage = dynamic (['ERP','CRM','BW','Solman','Gateway','Enterprise Portal']); // Available System Usages\r\n// Get Relevant Systems from WatchList\r\nlet systemID = _GetWatchlist('SAP - Systems');\r\nlet fixedSID = datatable(SystemID:string, SystemRole:string, SystemUsage:string)\r\n// Maintain these if WatchList is not available    \r\n    [\"S4H\",\"Production\",\"ERP\",\r\n    \"XXX\",\"Sandbox\",\"BW\"]\r\n; \r\n// Get Relevant ABAP Programs\r\nlet SensitiveABAPReports = _GetWatchlist('SAP - Sensitive ABAP Programs');\r\nlet fixedABAPReports = datatable(ABAPProgram:string)\r\n// Maintain these if WatchList is not available    \r\n    [\"RSPFLDOC\"]\r\n; \r\nlet UnionAbap = \r\n    union SensitiveABAPReports, fixedABAPReports\r\n    | summarize by ABAPProgram;\r\nlet UnitedSystem =\r\nunion systemID, fixedSID\r\n| summarize by SystemID, SystemRole, SystemUsage\r\n| where SystemRole == Role; // Reccommended is Production only\r\n//| where SystemRole in (allSystemRoles); // Use this for all system roles\r\n// Query logic\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| where ABAPProgramName_s in (UnionAbap)\r\n| project-rename SystemID = SystemID_s\r\n| lookup kind = inner (UnitedSystem) on SystemID\r\n| order by TimeGenerated asc\r\n| project TimeGenerated, Instance_s , SystemID, ClientID_s, User_s, ABAPProgramName_s, MessageText_s, TransactionCode_s, MessageID_s, Email_s, TerminalIPv6_s, Host_s",
            "queryFrequency": "PT1H",
            "queryPeriod": "PT1H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "Exfiltration",
                "LateralMovement",
                "Execution"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_System_I_D": "SystemID",
                "SAP_Client": "ClientID_s",
                "SAP_Instance": "Instance_s",
                "SAP_User": "User_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/1fb2a21f-14e5-4e3d-9180-ad9ef6854924')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - High - Execution of a Sensitive Transaction Code",
            "description": "Identifies execution of a sensitive Transaction Code.\n\nSource Action: Execute a sensitive Transaction Code.\n\n**Recommended for Production only**\n\nTransaction Codes should be maintained in watchlist \"\"SAP - Sensitive Transaction Codes\"\"\n\n*Data Sources: SAPcon -  Audit Log*",
            "severity": "High",
            "enabled": true,
            "query": "// Define Variables\r\nlet Role = 'Production';\r\nlet AuditClasses = dynamic(['AU3']); // Audit Log Classes - Transaction Started\r\nlet allSystemRoles = dynamic(['Sandbox','Developement','QualityAssurance','Training','Production']); // Available System Roles\r\nlet allSystemUsage = dynamic (['ERP','CRM','BW','Solman','Gateway','Enterprise Portal']); // Available System Usages\r\n// Get Relevant Systems from WatchList\r\nlet systemID = _GetWatchlist('SAP - Systems');\r\nlet fixedSID = datatable(SystemID:string, SystemRole:string, SystemUsage:string)\r\n// Maintain these if WatchList is not available    \r\n    [\"S4H\",\"Production\",\"ERP\",\r\n    \"XXX\",\"Sandbox\",\"BW\"]\r\n; \r\n// Get Relevant Transaction Codes\r\nlet SensitiveTcode = _GetWatchlist('SAP - Sensitive Transactions');\r\nlet fixedTcode = datatable(TransactionCode:string)\r\n// Maintain these if WatchList is not available    \r\n    [\"RSAU_CONFIG\",\"RZ11\",\"SM19\"]\r\n; \r\nlet UnitedCodes = \r\n    union SensitiveTcode, fixedTcode\r\n    | summarize by TransactionCode;\r\nlet UnitedSystem =\r\nunion systemID, fixedSID\r\n| summarize by SystemID, SystemRole, SystemUsage\r\n| where SystemRole == Role; // Recommended  is Production only\r\n//| where SystemRole in (allSystemRoles); // Use this for all system roles\r\n// Query logic\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| where TransactionCode_s in (UnitedCodes)\r\n| project-rename SystemID = SystemID_s\r\n| lookup kind = inner (UnitedSystem) on SystemID\r\n| order by TimeGenerated asc\r\n| project TimeGenerated,Instance_s ,SystemID, ClientID_s, User_s, TransactionCode_s, MessageText_s, MessageID_s, Email_s, TerminalIPv6_s, Host_s",
            "queryFrequency": "PT1H",
            "queryPeriod": "PT1H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "Discovery",
                "Execution"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_User": "User_s",
                "SAP_Client": "ClientID_s",
                "SAP_Instance": "Instance_s",
                "SAP_System_I_D": "SystemID"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/fc618e81-94f2-49b4-aefc-010b30dcc56a')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - High - Execution of Sensitive Function Module",
            "description": "Identifies execution of a sensitive ABAP Function Module.\n\nSource Action: Execute a sensitive function module directly using SE37.\n\n**Recommended for Production only**\n\nSensitive functions should be maintained in \"SAP - Sensitive Function Modules\" Watchlist.\nTable logging changes should be activated for table \"EUFUNC\" in backend. (SE13)\n\n*Data Sources: SAPcon -  Table Data Log*",
            "severity": "High",
            "enabled": true,
            "query": "// Define variables\r\nlet RelTable = \"EUFUNC\"; // Relevant table\r\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user\r\nlet SenseModules =  _GetWatchlist('SAP - Sensitive Function Modules');\r\nlet fixedModules = datatable(FunctionModule:string)['RSAU_CLEAR_AUDIT_LOG','BAPI_USER_CREATE', 'RFC_GET_TABLE_ENTRIES']; \r\nlet UnitedModules =\r\ntoscalar(union fixedModules, SenseModules\r\n| summarize FunctionModules =  make_set(FunctionModule));\r\n// Query logic\r\nlet LastLogin = \r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditLogIn)\r\n| summarize TimeGenerated = arg_max(TimeGenerated, *) by SystemID_s, ClientID_s, User_s; // Get last connection date for user\r\nABAPTableDataLog_CL\r\n| where TableName_s == RelTable \r\n| extend Module = extract(@\"\\s+(.{1,}\\b)\\s+\", 1, LogKey_s, typeof(string)) // Extract Function Module\r\n| extend FunctionGroup = extract(@\"^FL([^\\s]*)\\s\", 1, LogKey_s, typeof(string)) // Extract Function Group\r\n| extend ExecutionVariant = extract(@\"\\b(\\w+)$\", 1, LogKey_s, typeof(string)) // Extract Execution Varient\r\n| where Module in (UnitedModules) // Module is sensitive\r\n| lookup kind=inner LastLogin on $left.UserName_s == $right.User_s\r\n| project TimeGenerated, Instance_s ,SystemID_s, UserName_s, ClientID_s, Email_s, TerminalIPv6_s, Host_s, Module, FunctionGroup, ExecutionVariant",
            "queryFrequency": "PT2H",
            "queryPeriod": "PT2H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "Discovery",
                "CommandAndControl"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_Client": "ClientID_s",
                "SAP_System_I_D": "SystemID_s",
                "SAP_Instance": "Instance_s",
                "SAP_User": "UserName_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/520713e4-a72e-4cfd-9b12-ca5049a71df4')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - High - Function Module tested",
            "description": "Identifies testing of a function module.\n\nSource Action: Test a function module using  SE37 / SE80.\n\n**Recommended for Production only**\n\n*Data Sources: SAPcon -  Audit Log*",
            "severity": "High",
            "enabled": true,
            "query": "let Role = 'Production';\r\nlet ProgramName = 'RS_TESTFRAME_CALL';\r\nlet AuditClasses = dynamic(['AUW']); // Audit Log Classes - Report Started\r\nlet allSystemRoles = dynamic(['Sandbox', 'Developement', 'QualityAssurance', 'Training', 'Production']); // Available System Roles\r\nlet allSystemUsage = dynamic (['ERP', 'CRM', 'BW', 'Solman', 'Gateway', 'Enterprise Portal']); // Available System Usages\r\n// Get Relevant Systems from WatchList\r\nlet systemID = _GetWatchlist('SAP - Systems');\r\nlet fixedSID = datatable(SystemID: string, SystemRole: string, SystemUsage: string)\r\n    // Maintain these if WatchList is not available    \r\n    [\"S4H\", \"Production\", \"ERP\",\r\n    \"XXX\", \"Sandbox\", \"BW\"]\r\n; \r\nlet UnitedSystem = \r\nunion systemID, fixedSID\r\n| summarize by SystemID, SystemRole, SystemUsage\r\n| where SystemRole == Role; // Reccommended is Production only\r\n//| where SystemRole in (allSystemRoles); // Use this for all system roles\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| where ABAPProgramName_s == ProgramName\r\n| project-rename SystemID = SystemID_s\r\n| lookup kind = inner (UnitedSystem) on SystemID\r\n| order by TimeGenerated asc\r\n| project TimeGenerated, Instance_s ,User_s, SystemID, ClientID_s, MessageText_s, MessageID_s,\r\nEmail_s, TerminalIPv6_s, Host_s ",
            "queryFrequency": "PT6H",
            "queryPeriod": "PT6H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "Collection",
                "DefenseEvasion",
                "LateralMovement"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_User": "User_s",
                "SAP_Client": "ClientID_s",
                "SAP_Instance": "Instance_s",
                "SAP_System_I_D": "SystemID"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/03c0f7bf-45d5-4102-a1bb-d47d14338ba2')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - High - HANA DB - Assign Admin Authorizations",
            "description": "Identifies admin privileges/roles assignment.\n\nSource Action: Assign a user with any Admin role / privileges.\n\n*Data Sources: Linux Agent - Syslog*",
            "severity": "High",
            "enabled": true,
            "query": "Syslog \r\n| where ProcessName startswith \"HDB\"\r\n| where SyslogMessage contains \"ADMIN\" and (SyslogMessage contains \"GRANT PRIVILEGE\" or SyslogMessage contains \"GRANT ROLE\")",
            "queryFrequency": "PT3H",
            "queryPeriod": "PT3H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "PrivilegeEscalation"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": null,
                    "groupByCustomDetails": null
                }
            },
            "eventGroupingSettings": null,
            "alertDetailsOverride": null,
            "customDetails": null,
            "entityMappings": null
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/15959eb6-7350-42bc-acd2-d2aace805da1')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - High - HANA DB - Audit Trail Policy Changes",
            "description": "Identifies changes for HANA DB audit trail policies.\n\nSource Action: Create / update existing audit policy in security definitions.\n\n*Data Sources: Linux Agent - Syslog*",
            "severity": "High",
            "enabled": true,
            "query": "Syslog \r\n| where ProcessName startswith \"HDB\"\r\n| where SyslogMessage contains \"AUDIT POLICY\" ",
            "queryFrequency": "PT1H",
            "queryPeriod": "PT1H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "LateralMovement",
                "DefenseEvasion",
                "Persistence"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": null,
                    "groupByCustomDetails": null
                }
            },
            "eventGroupingSettings": null,
            "alertDetailsOverride": null,
            "customDetails": null,
            "entityMappings": null
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/5b160a76-3cbf-4fad-a510-d0a095e08c16')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - High - HANA DB - Deactivation of Audit Trail",
            "description": "Identifies deactivation of HANA DB audit log.\n\nSource Action: Deactivate Audit Log in HANA DB security defnitions.\n\n*Data Sources: Linux Agent - Syslog*",
            "severity": "High",
            "enabled": true,
            "query": "Syslog \r\n| where ProcessName startswith \"HDB\"\r\n| where SyslogMessage contains \"AUDIT CONFIGURATION\" and \r\n    SyslogMessage contains 'global_auditing_state' and \r\n    SyslogMessage contains 'False'",
            "queryFrequency": "PT1H",
            "queryPeriod": "PT1H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "Persistence",
                "LateralMovement",
                "DefenseEvasion"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": null,
                    "groupByCustomDetails": null
                }
            },
            "eventGroupingSettings": null,
            "alertDetailsOverride": null,
            "customDetails": null,
            "entityMappings": null
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/491fb852-b8c4-4eca-828c-af4f714557c4')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - High - HANA DB - User Admin actions",
            "description": "Identifies user administration actions.\n\nSouirce Action: Create/Update/Delete a DB User.\n\n*Data Sources: Linux Agent - Syslog*",
            "severity": "High",
            "enabled": true,
            "query": "Syslog \r\n| where ProcessName startswith \"HDB\"\r\n| where SyslogMessage contains \"CREATE USER\" or \r\n    SyslogMessage contains 'ALTER USER' or \r\n    SyslogMessage contains 'DROP USER' or \r\n    SyslogMessage contains 'DROP SCHEMA'",
            "queryFrequency": "PT3H",
            "queryPeriod": "PT3H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "PrivilegeEscalation"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": null,
                    "groupByCustomDetails": null
                }
            },
            "eventGroupingSettings": null,
            "alertDetailsOverride": null,
            "customDetails": null,
            "entityMappings": null
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/6cd58183-51a9-4585-9929-e5380f8c38ad')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - High - Login from unexpected network",
            "description": "Identifies logons from an unexpected network.\n\nSource Action: Logon to the backend system from an IP address which is not assigned to one of the netwroks.\n\nNetworks should be maintained in watchlist \"SAP - Networks\"\n\n*Data Sources: SAPcon -  Audit Log*",
            "severity": "High",
            "enabled": true,
            "query": "let AuditClasses = dynamic(['AU1','AU5']); // Audit Log Classes - Dialog Logon Successful, RFC Logon Successful\r\n// Dialog / CPIC / RFC Int / RFC Ext / SRFC / User Switch / HTTP / Restore Session / API Call\r\nlet DialogLogonTypes = dynamic(['A', 'C', 'F', 'R', 'S', 'U', 'H', 'u', ' ']);\r\nlet Networks = _GetWatchlist('SAP - Networks'); \r\nlet fixedNetworks = datatable(Network: string)['111.68.128.0/17']; // Maintain these if watchlist is not available\r\nlet allNetworks = union Networks, fixedNetworks\r\n    | summarize by Network;\r\nABAPAuditLog_CL\r\n// Add audit classes\r\n| where MessageID_s in (AuditClasses)\r\n| where Variable1_s in (DialogLogonTypes) // Is a dialog logon type from the list\r\n| where isnotempty(TerminalIPv6_s) // There is a Ipv6 address\r\n| evaluate ipv4_lookup(allNetworks, TerminalIPv6_s, Network, return_unmatched = true)\r\n// Similar to regular lookup, by ipv4 address, unmatched is like left join\r\n| where isempty(Network) // Network is not familiar\r\n// Details\r\n| project TimeGenerated, SystemID_s, ClientID_s, User_s, TransactionCode_s, MessageText_s, Email_s , TerminalIPv6_s, Host_s",
            "queryFrequency": "PT1H",
            "queryPeriod": "PT1H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "InitialAccess"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_Client": "ClientID_s",
                "SAP_System_I_D": "SystemID_s",
                "SAP_User": "User_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/db0fe39e-4e2c-4452-bbd7-f3d836f296d7')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - High - New ICF Service Handlers",
            "description": "Identifies creation of ICF Handlers.\nSource Action: Assign a new handler to a service using SICF.\n*Data Sources: SAPcon - Table Data Log*",
            "severity": "High",
            "enabled": true,
            "query": "ABAPTableDataLog_CL\r\n| where TableName_s == \"ICFHANDLER\"\r\n| where TableField_s == \"ICF_NAME\" // Service name\r\n| where OldValue_s == \"\" and NewValue_s != \"\" // New value is inserted in name -> new service\r\n| order by TimeGenerated desc\r\n| project TimeGenerated, Service = NewValue_s",
            "queryFrequency": "PT2H",
            "queryPeriod": "PT2H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "Persistence",
                "LateralMovement",
                "CommandAndControl"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": null,
                    "groupByCustomDetails": null
                }
            },
            "eventGroupingSettings": null,
            "alertDetailsOverride": null,
            "customDetails": null,
            "entityMappings": null
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/6e8dee6b-d018-4298-bbd1-27a4eb435a8b')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - High - New ICF Services",
            "description": "Identifies creation of ICF Services.\nSource Action: Create a service using SICF.\n*Data Sources: SAPcon - Table Data Log*",
            "severity": "High",
            "enabled": true,
            "query": "ABAPTableDataLog_CL\r\n| where TableName_s == \"ICFSERVLOC\"\r\n| where TableField_s == \"ICF_NAME\" // Service name\r\n| where OldValue_s == \"\" and NewValue_s != \"\" // New value is inserted in name -> new service\r\n| order by TimeGenerated desc\r\n| project TimeGenerated, Service = NewValue_s",
            "queryFrequency": "PT2H",
            "queryPeriod": "PT2H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "CommandAndControl",
                "Persistence",
                "LateralMovement"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": null,
                    "groupByCustomDetails": null
                }
            },
            "eventGroupingSettings": null,
            "alertDetailsOverride": null,
            "customDetails": null,
            "entityMappings": null
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/5eba5b1a-b105-470d-b80b-0aafd440bf32')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - High - RFC Execution of a Sensitive Function Module",
            "description": "Identifies execution of a sensitive function module using RFC.\n\nSource Action: Execute a function module using RFC.\n\n**Recommended for Production only**\n\nFunction Modules should be maintained in watchlist \"SAP - Sensitive Function Modules\"\n\n*Data Sources: SAPcon -  Audit Log*",
            "severity": "High",
            "enabled": true,
            "query": "let Role = \"Production\";\r\nlet AuditClasses = dynamic(['AUK']); // Audit Log Classes - Successful RFC call &C (function group = &A)\r\nlet allSystemRoles = dynamic(['Sandbox', 'Developement', 'QualityAssurance', 'Training', 'Production']); // Available System Roles\r\nlet allSystemUsage = dynamic (['ERP', 'CRM', 'BW', 'Solman', 'Gateway', 'Enterprise Portal']); // Available System Usages\r\n// Get Relevant Systems from WatchList\r\nlet systemID = _GetWatchlist('SAP - Systems');\r\nlet fixedSID = datatable(SystemID: string, SystemRole: string, SystemUsage: string)\r\n    // Maintain these if WatchList is not available    \r\n    [\"S4H\", \"Production\", \"ERP\",\r\n    \"XXX\", \"Sandbox\", \"BW\"]\r\n; \r\n// Get Relevant Function Modules\r\nlet SensitiveFM = _GetWatchlist('SAP - Sensitive Function Modules');\r\nlet fixedFM = datatable(FunctionModule: string)\r\n    // Maintain these if WatchList is not available    \r\n    [\"RSAU_CLEAR_AUDIT_LOG\"]\r\n; \r\nlet UnitedSystems = union systemID, fixedSID\r\n| where SystemRole == Role // Recommended  is Production only\r\n| summarize by SystemID;\r\n//| where SystemRole in (allSystemRoles); // Use this for all system roles\r\nlet UnitedSensitive =  union SensitiveFM, fixedFM\r\n| summarize by FunctionModule;\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| project-rename FunctionModule = Variable3_s, FunctionGroup = Variable1_s\r\n| where SystemID_s in (UnitedSystems) // The systemID is in this list\r\n| where FunctionModule in (UnitedSensitive) // Function module is sensitive\r\n| order by TimeGenerated asc\r\n| project TimeGenerated,Instance_s ,User_s, SystemID_s, ClientID_s, MessageText_s, FunctionGroup, FunctionModule, MessageID_s, Email_s, TerminalIPv6_s, Host_s",
            "queryFrequency": "PT2H",
            "queryPeriod": "PT2H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "Execution",
                "LateralMovement",
                "Discovery"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_User": "User_s",
                "SAP_Client": "ClientID_s",
                "SAP_System_I_D": "SystemID_s",
                "SAP_Instance": "Instance_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/38a4fbde-c84d-4497-968a-159d07b6df9c')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - High - Sensitive privileged user logged in",
            "description": "Identifies Dialog logon of a sensitive privileged user. \n\nSource Action: Logon to the backend system using SAP* or anoter privileged user.\n\nPriveleged users should be maintained in \"SAP - Privileged Users\" Watchlist\n\n*Data Sources: SAPcon -  Audit Log*",
            "severity": "High",
            "enabled": true,
            "query": "// Define Variables\r\n// Audit Log Classes - Dialog Logon Successful\r\nlet AuditClassesSuccess = dynamic(['AU1']);\r\nlet AuditClassesFail = dynamic(['BU1']);\r\nlet AuditRFCSuccess = dynamic(['AU5']);\r\nlet AuditRFCFail = dynamic(['AU6']);\r\nlet LogonTypes = dynamic(['A','H', 'R', 'S']); // Dialog / HTTP\r\n// Get Relevant User from WatchList\r\nlet PrivelegedUsers = _GetWatchlist('SAP - Privileged Users');\r\nlet fixedUsers = datatable(User:string)\r\n// Maintain these if WatchList is not available    \r\n    [\"SAP*\",\"DDIC\"]\r\n;\r\nlet SensProfiles = _GetWatchlist('SAP - Sensitive Profiles') | summarize  by Profile;\r\nlet SensRoles = _GetWatchlist('SAP - Sensitive Roles') | summarize  by Role;\r\n// Maintain these if System doesn't have CR's\r\nlet FixedUserMD = datatable(TimeGenerated : datetime, UserName_s : string, RoleMembership_s : string)[];\r\n// Priveleged Users by sensitive role/profile based on user master data\r\nlet ABAPUserMd = \r\nunion isfuzzy=true table(\"ABAPUserMD_CL\"), FixedUserMD;\r\nlet PrivUserdByMD = ABAPUserMd\r\n| extend Roles = parse_json(RoleMembership_s)[\"SapRole\"], Profiles = parse_json(RoleMembership_s)[\"SapProfile\"]\r\n| mv-expand Roles, Profiles\r\n| where Roles in (SensRoles) or Profiles in (SensProfiles)\r\n| summarize by User = UserName_s;\r\nlet UnitedPrivileged = union PrivelegedUsers, fixedUsers, PrivUserdByMD\r\n| summarize by User;\r\n// Query logic\r\nABAPAuditLog_CL \r\n| where (MessageID_s in (AuditClassesSuccess) and Variable1_s in (LogonTypes)) or // Success login\r\nMessageID_s in (AuditClassesFail) or // Failed login\r\n(MessageID_s in (AuditRFCSuccess) and Variable1_s in (LogonTypes)) or // Success RFC login\r\nMessageID_s in (AuditRFCFail) // Failed RFC login\r\n| where User_s in (UnitedPrivileged)\r\n| project-rename LogonType = Variable1_s\r\n| project TimeGenerated, Instance_s ,SystemID_s, ClientID_s, LogonType, User_s, MessageText_s, \r\nEmail_s, TerminalIPv6_s, Host_s\r\n",
            "queryFrequency": "PT1H",
            "queryPeriod": "PT1H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "InitialAccess",
                "CredentialAccess"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_Client": "ClientID_s",
                "SAP_Instance": "Instance_s",
                "SAP_System_I_D": "SystemID_s",
                "SAP_User": "User_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/d766e2b9-c836-423f-9fe7-d63c2ae135dc')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - High - Sensitive privileged user makes a change in other user",
            "description": "Identifies changes  of sensitive privileged users in other users.\n\nSource Action: Change user details / authorizations using SU01.\n\nPriveleged users should be maintained in \"SAP - Privileged Users\" Watchlist\n\n*Data Sources: SAPcon -  Audit Log*",
            "severity": "High",
            "enabled": true,
            "query": "// Audit Log Classes - User Master Changes\r\nlet AuditClasses = dynamic(['AU7', 'BUV', 'BUW', 'AU8', 'AU9', 'AUA', 'AUB', 'AUD', 'DUH', 'BU2']);\r\n// Get Relevant User from WatchList\r\nlet PrivelegedUsers = _GetWatchlist('SAP - Privileged Users');\r\nlet fixedUsers = datatable(User: string)\r\n    // Maintain these if WatchList is not available    \r\n    [\"SAP*\", \"DDIC\"]\r\n;\r\nlet SensProfiles = _GetWatchlist('SAP - Sensitive Profiles') | summarize  by Profile;\r\nlet SensRoles = _GetWatchlist('SAP - Sensitive Roles') | summarize  by Role;\r\n// Maintain these if System doesn't have CR's\r\nlet FixedUserMD = datatable(TimeGenerated : datetime, UserName_s : string, RoleMembership_s : string)[];\r\n// Priveleged Users by sensitive role/profile based on user master data\r\nlet ABAPUserMd = \r\nunion isfuzzy=true table(\"ABAPUserMD_CL\"), FixedUserMD;\r\nlet PrivUserdByMD = ABAPUserMd\r\n| extend Roles = parse_json(RoleMembership_s)[\"SapRole\"], Profiles = parse_json(RoleMembership_s)[\"SapProfile\"]\r\n| mv-expand Roles, Profiles\r\n| where Roles in (SensRoles) or Profiles in (SensProfiles)\r\n| summarize by User = UserName_s;\r\nlet UnitedPrivleged = union PrivelegedUsers, fixedUsers, PrivUserdByMD\r\n| summarize by User;\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| where User_s in (UnitedPrivleged) // The user that makes a change is a sensitive privileged user\r\n| project TimeGenerated, Instance_s ,SystemID_s, ClientID_s, User_s, MessageText_s, MessageID_s,\r\n     Email_s, TerminalIPv6_s, Host_s\r\n",
            "queryFrequency": "PT1H",
            "queryPeriod": "PT1H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "PrivilegeEscalation",
                "CredentialAccess"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_User": "User_s",
                "SAP_Instance": "Instance_s",
                "SAP_Client": "ClientID_s",
                "SAP_System_I_D": "SystemID_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/ff24daf5-2b40-4e76-aea5-96c36b4a6cc9')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - High - Sensitive Users Password Change and Login",
            "description": "Identifies password changes for privileged users.\n\nSource Action: Change Password for a user and login to the system.\n\nPriveleged users should be maintained in \"SAP - Privileged Users\" Watchlist\n\n*Data Sources: SAPcon -  Audit Log*",
            "severity": "High",
            "enabled": true,
            "query": "// Define variables\r\nlet ChangeAndLoginThreshold = 5; // Difference by minutes between Change in user to connect\r\nlet LoginAndRestThreshold = 3; // Difference by minutes between Connect and password reset\r\nlet AuditUserChange = dynamic(['AUD']); // Message of change in user\r\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user\r\nlet AuditUserPassReset = dynamic(['BU2']); // Message of user password change\r\nlet PrivUsers = _GetWatchlist(\"SAP - Privileged Users\");\r\nlet fixedUsers = datatable(User: string)\r\n    // Maintain these if WatchList is not available    \r\n    [\"SAP*\", \"DDIC\"]\r\n;\r\nlet SensProfiles = _GetWatchlist('SAP - Sensitive Profiles') | summarize  by Profile;\r\nlet SensRoles = _GetWatchlist('SAP - Sensitive Roles') | summarize  by Role;\r\n// Maintain these if System doesn't have CR's\r\nlet FixedUserMD = datatable(TimeGenerated : datetime, UserName_s : string, RoleMembership_s : string)[];\r\n// Priveleged Users by sensitive role/profile based on user master data\r\nlet ABAPUserMd = \r\nunion isfuzzy=true table(\"ABAPUserMD_CL\"), FixedUserMD;\r\nlet PrivUserdByMD = ABAPUserMd\r\n| extend Roles = parse_json(RoleMembership_s)[\"SapRole\"], Profiles = parse_json(RoleMembership_s)[\"SapProfile\"]\r\n| mv-expand Roles, Profiles\r\n| where Roles in (SensRoles) or Profiles in (SensProfiles)\r\n| summarize by User = UserName_s;\r\nlet UnitedPrivleged = toscalar(union PrivUsers, fixedUsers, PrivUserdByMD\r\n| summarize Users = make_set(User));\r\n// Query Logic\r\nlet UserChange = // Get users change activity\r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditUserChange)\r\n| where Variable1_s in (UnitedPrivleged) // The user with the changed password is privileged user\r\n| project-rename UserChangeTimeGenerated = TimeGenerated, UserPassChanged = Variable1_s;\r\nlet UserLogIn = // Get users connections\r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditLogIn)\r\n| project-rename UserLogInTimeGenerated = TimeGenerated;\r\nABAPAuditLog_CL // Get users password reset\r\n| where MessageID_s in (AuditUserPassReset)\r\n| where User_s in (UnitedPrivleged) // The user with the changed password is privileged user\r\n| lookup kind=inner UserLogIn on TerminalIPv6_s, User_s // Lookup of user reset to user login\r\n| lookup kind=inner UserChange on TerminalIPv6_s, $left.User_s == $right.UserPassChanged // Lookup of user reset to user change\r\n| where abs(datetime_diff('Minute', UserChangeTimeGenerated, UserLogInTimeGenerated)) <= ChangeAndLoginThreshold // Connect after a change in user\r\n| where abs(datetime_diff('Minute', TimeGenerated, UserLogInTimeGenerated)) <= LoginAndRestThreshold // Change password after connection\r\n| summarize by TimeGenerated, Instance_s ,SystemID_s, ClientID_s, UserAction = User_s1, PrivUserPassChanged = User_s, Email_s, TerminalIPv6_s, Host_s\r\n",
            "queryFrequency": "PT1H",
            "queryPeriod": "PT1H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "Impact",
                "CommandAndControl",
                "PrivilegeEscalation"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_Instance": "Instance_s",
                "SAP_Client": "ClientID_s",
                "SAP_System_I_D": "SystemID_s",
                "SAP_User": "UserAction"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/da6cbab6-0928-4674-bebd-47acbb8ec309')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - High - SPNego Attack",
            "description": "Identifies SPNego Replay Attack.\n\n*Data Sources: SAPcon -  Audit Log*",
            "severity": "High",
            "enabled": true,
            "query": "// Define variables\r\nlet AuditClasses = dynamic(['BUI']); // Message of SPNego\r\n// Query logic\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| project TimeGenerated, Instance_s , SystemID_s, ClientID_s, User_s ,  Email_s, TerminalIPv6_s, Host_s",
            "queryFrequency": "PT1H",
            "queryPeriod": "PT1H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "Impact",
                "LateralMovement"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_Client": "ClientID_s",
                "SAP_System_I_D": "SystemID_s",
                "SAP_User": "User_s",
                "SAP_Instance": "Instance_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/1a760847-14b0-45bc-876e-2fa47bdccbd6')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - High - System Configuration Change",
            "description": "Identifies changes for system configuration. \n\nSource Action:  Adapt system change options or software components modifcation using SE06 transaction code.\n\n*Data Sources: SAPcon -  Audit Log*",
            "severity": "High",
            "enabled": true,
            "query": "// Audit Log Classes - System Change Configuration\r\nlet AuditClasses = dynamic(['EU1']); // Relevant message\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| project \r\n// Details\r\nTimeGenerated,Instance_s, ClientID_s ,SystemID_s, User_s, TransactionCode_s, SoftwareComponent = Variable1_s, NewModifiabilityStatus = Variable2_s, MessageText_s,\r\nEmail_s, TerminalIPv6_s, Host_s\r\n",
            "queryFrequency": "PT1H",
            "queryPeriod": "PT1H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "Exfiltration",
                "DefenseEvasion",
                "Persistence"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_System_I_D": "SystemID_s",
                "SAP_User": "User_s",
                "SAP_Instance": "Instance_s",
                "SAP_Client": "ClientID_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/a49025ef-df61-48fc-8817-716c29a7d718')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - High - User Creates and uses new user",
            "description": "Identifies a user creating and using other users.\n\nSource Action: Create a user using SU01. Login using the newly created user from the same IP.\n\n*Data Sources: SAPcon -  Audit Log*",
            "severity": "High",
            "enabled": true,
            "query": "// Define Variables\r\nlet MinutesThreshold = 15; // Difference by minutes between Create and Connect\r\nlet AuditUserCreated = dynamic(['AU7']); // Message of create user\r\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user\r\n// Query Logic\r\nlet UserCreated = // Get users created\r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditUserCreated)\r\n| project-rename UserCreationTimeGenerated = TimeGenerated, UserCreated = Variable1_s;\r\nABAPAuditLog_CL // Get users connections\r\n| where MessageID_s in (AuditLogIn)\r\n| lookup kind=inner UserCreated on TerminalIPv6_s,$left.User_s == $right.UserCreated // Lookup of user created to user log in\r\n| where abs(datetime_diff('Minute', TimeGenerated, UserCreationTimeGenerated)) <= MinutesThreshold // Connect after creation\r\n| summarize by TimeGenerated, Instance_s ,SystemID_s, ClientID_s, UserAction = User_s1, UserCreated = User_s, Email_s, TerminalIPv6_s,  Host_s",
            "queryFrequency": "PT1H",
            "queryPeriod": "PT1H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "Discovery",
                "PreAttack",
                "InitialAccess"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_User": "UserAction",
                "SAP_Client": "ClientID_s",
                "SAP_Instance": "Instance_s",
                "SAP_System_I_D": "SystemID_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/a81fcdca-3e80-4c9d-9ea5-4a6172aaeb47')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - High - User Unlocks and uses other users",
            "description": "Identifies a user unlock and usage by other users.\n\nSource Action: Unlock a user using SU01. Login using the unlocked user from the same IP.\n\n*Data Sources: SAPcon -  Audit Log*\n*Data Sources: SAPcon -  Change Documents Log*",
            "severity": "High",
            "enabled": true,
            "query": "// Define variables\r\nlet MinutesThreshold = 15; // Difference by minutes between Unlock and Connect\r\nlet AuditUserUnlocked = dynamic(['AUA']); // Message of unlock user\r\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user\r\n// Query Logic\r\nlet UserUnlocked = // Get users unlocked\r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditUserUnlocked)\r\n| project-rename UserUnlockTimeGenerated = TimeGenerated, UserUnlocked = Variable1_s;\r\nABAPAuditLog_CL // Get users connections\r\n| where MessageID_s in (AuditLogIn)\r\n| lookup kind=inner UserUnlocked on TerminalIPv6_s, $left.User_s == $right.UserUnlocked // Lookup of user unlocked to user log in\r\n| where abs(datetime_diff('Minute', TimeGenerated, UserUnlockTimeGenerated)) <= MinutesThreshold // Connect after unlock\r\n| summarize by TimeGenerated, Instance_s ,SystemID_s, ClientID_s, UserAction = User_s1, UserUnlocked = User_s, Email_s,  TerminalIPv6_s, Host_s",
            "queryFrequency": "PT1H",
            "queryPeriod": "PT1H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "PreAttack",
                "InitialAccess",
                "Discovery",
                "LateralMovement"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_Instance": "Instance_s",
                "SAP_Client": "ClientID_s",
                "SAP_System_I_D": "SystemID_s",
                "SAP_User": "UserAction"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/ab207396-7e9b-4075-8402-68e4275659f2')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - Medium - Assignment of a sensitive profile",
            "description": "Identifies new assignments of a sensitive profile to a user.\n\nSource Action: Assign a profile to a User using SU01.\n\nSensitive profiles should be maintained in watchlist \"SAP - Sensitive Profiles\"\n\n*Data Sources: SAPcon -  Change Documents Log*\n",
            "severity": "Medium",
            "enabled": true,
            "query": "// Define Variables\r\n// Audit Log Classes - Authorizations for user changed\r\nlet Identity = 'IDENTITY';\r\nlet ProfileChangeDoc = 'SUSR_UST04';\r\nlet Insert = \"I\";\r\nlet logsThreshold = 10; // 10 seconds\r\nlet AuditClasses = dynamic(['AUB']); // Authorizations for user &A changed.\r\n// Maintain these if WatchList is not available\r\nlet SensitiveProfiles =  _GetWatchlist('SAP - Sensitive Profiles');\r\nlet fixedProfile = datatable(Profile:string)['SAP_ALL','SAP_NEW'];\r\n// Maintain these if System doesn't have CR's\r\nlet fixedChangeDocs = datatable(User_s : string, ObjectClass_s : string, TableName_s : string, TypeofChange_Item_s : string , ChangedTableKey_s : string, ObjectID_s : string, TimeGenerated : datetime, ValueNew_s : string, SystemID_s : string)[];\r\nlet ChangeDocs = \r\nunion isfuzzy=true table(\"ABAPChangeDocsLog_CL\"), fixedChangeDocs;\r\nlet IdentityChangeDocuments =\r\n// Identity Change documents which represents profiles assignment\r\n    ChangeDocs  \r\n    | where ObjectClass_s == Identity // Identity\r\n    and TableName_s == ProfileChangeDoc // Profile Change Doc\r\n    and TypeofChange_Item_s == Insert // Insert \r\n    | extend Profile = ChangedTableKey_s\r\n    | extend UserAssigned = ObjectID_s;\r\nlet UnitedProfiles =\r\ntoscalar(union fixedProfile, SensitiveProfiles\r\n| summarize Profiles = make_list(Profile));\r\n// Query logic\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| summarize by TimeGenerated, TerminalIPv6_s, User_s, Host_s, Email_s\r\n| lookup kind = leftouter (IdentityChangeDocuments) on User_s\r\n| where Profile in (UnitedProfiles)\r\n| project-rename  TimeGenAudit = TimeGenerated1    \r\n| where abs(datetime_diff('second',TimeGenerated,TimeGenAudit)) <= logsThreshold\r\nor isnull(TimeGenAudit)\r\n| project \r\n// Details\r\nTimeGenerated, Instance_s , SystemID_s, ClientID_s, Profile, User_s,  UserAssigned,\r\nEmail_s, TerminalIPv6_s, Host_s",
            "queryFrequency": "PT12H",
            "queryPeriod": "PT12H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "PrivilegeEscalation"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_User": "User_s",
                "SAP_Client": "Email_s",
                "SAP_System_I_D": "SystemID_s",
                "SAP_Instance": "Instance_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/c7df7fa6-306b-46bd-b850-69421c8158a7')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - Medium - Assignment of a sensitive role",
            "description": "Identifies new assignments for a sensitive role to a user.\n\nSource Action: Assign a role to a User using SU01 / PFCG.\n\nSensitive roles should be maintained in watchlist \"SAP -  Sensitive Roles\"\n\n*Data Sources: SAPcon -  Change Documents Log, Audit Log*",
            "severity": "Medium",
            "enabled": true,
            "query": "// Define Variables\r\nlet Roles = 'PFCG';\r\nlet UsersRoles = 'AGR_USERS';\r\nlet Insert = \"I\";\r\nlet logsThreshold = 10; // 10 seconds\r\n// Audit Log Classes - Authorizations for user changed\r\nlet AuditClasses = dynamic(['AUB', 'AUD']); // Authorizations for user &A changed.\r\n// Maintain these if WatchList is not available\r\nlet SensitiveRoles =  _GetWatchlist('SAP - Sensitive Roles');\r\nlet fixedRoles = datatable(Role: string)['SAP_BC_BASIS_ADMIN', 'SAP_BC_AUTH_PROFILE_ADMIN'];\r\n// Maintain these if System doesn't have CR's\r\nlet fixedChangeDocs = datatable(User_s : string, ObjectClass_s : string, TableName_s : string, TypeofChange_Item_s : string ,\r\nChangedTableKey_s : string, ObjectID_s : string, TimeGenerated : datetime, ValueNew_s : string, SystemID_s : string)[];\r\nlet ChangeDocs = \r\nunion isfuzzy=true table(\"ABAPChangeDocsLog_CL\"), fixedChangeDocs;\r\nlet ChangeCheck =\r\nChangeDocs  \r\n| where ObjectClass_s == Roles // Roles\r\n    and TableName_s == UsersRoles // Users Roles\r\n    and TypeofChange_Item_s == Insert // Insert \r\n| extend UserAssigned = extract(@\"^.{1,33}\\s*?(.{1,12})\\s*?\\d{16}\", 1, ChangedTableKey_s)\r\n| extend Role = ObjectID_s;\r\nlet UnitedRoles =\r\ntoscalar(union fixedRoles, SensitiveRoles\r\n| summarize Roles = make_list(Role));\r\n// Query logic\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| summarize by TimeGenerated, TerminalIPv6_s, User_s, Host_s, Email_s\r\n| lookup kind = leftouter (ChangeCheck) on User_s\r\n| where Role in (UnitedRoles)\r\n| project-rename TimeGenAudit = TimeGenerated1\r\n| where abs(datetime_diff('second', TimeGenerated, TimeGenAudit)) <= logsThreshold\r\nor isnull(TimeGenAudit)\r\n| project \r\n    // Details\r\n    TimeGenerated, Instance_s , SystemID_s, ClientID_s, Role, User_s, UserAssigned,\r\n    Email_s, TerminalIPv6_s, Host_s",
            "queryFrequency": "PT12H",
            "queryPeriod": "PT12H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "PrivilegeEscalation"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_Client": "ClientID_s",
                "SAP_Instance": "Instance_s",
                "SAP_System_I_D": "SystemID_s",
                "SAP_User": "User_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "HostName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/e9b38331-0b37-4428-988d-b5c07fa617f0')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - Medium - Brute force attacks",
            "description": "Identifies brute force attacks on SAP system according to failed logon attempts for the backend system.\n\nSource Action: Attempt to login from the same IP to several systems/clients within the scheduled time interval.\n\n*Data Sources: SAPcon -  Audit Log*",
            "severity": "Medium",
            "enabled": true,
            "query": "// Define variables\r\n// Audit Log Classes - Failed Logons / Password Check\r\nlet AuditClasses = dynamic(['AUO', 'AU2', 'AU6', 'BU1']);\r\nlet perIPLimit = 6;\r\n// Query logic\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| extend DetailsBy = pack(\"User\", User_s, \"Email\", Email_s, \"SystemID\", SystemID_s, \"ClientID\", ClientID_s)\r\n| summarize LoginbyIPAttempts = count(), Details = make_set(DetailsBy), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) \r\n    by TerminalIPv6_s\r\n// Check if number of login attempts per IP is higher than limit\r\n| where LoginbyIPAttempts > perIPLimit \r\n| mv-expand Details\r\n| evaluate bag_unpack(Details, \"Details_\")\r\n| project \r\n    StartTime, EndTime,  TerminalIPv6_s,\r\n    Email = column_ifexists(\"Details_Email\", \"\"), User = column_ifexists(\"Details_User\", \"\"),\r\n    SysetmID = column_ifexists(\"Details_SystemID\", \"\"),\r\n   ClientID = column_ifexists(\"Details_ClientID\", \"\")",
            "queryFrequency": "PT6H",
            "queryPeriod": "PT6H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "CredentialAccess"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_User": "User",
                "SAP_Client": "ClientID",
                "SAP_System_I_D": "SysetmID"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/013468cd-89ec-4074-b1d7-71d00655274d')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - Medium - Critical authorizations assignment - New Authorization Value",
            "description": "Identifies assignment of a critical authorization object value to a new user.\n\nSource Action: Assign a new authorization object / update existing one in a role using PFCG.\n\nCritical authorization objects should be maintained in watchlist \"\"SAP - Critical Authorization Objects\"\"\n\n*Data Sources: SAPcon -  Change Documents Log*",
            "severity": "Medium",
            "enabled": true,
            "query": "// New Assigned Objects\r\nlet ObjectClassRoles = 'PFCG';\r\nlet TableName = 'CD1251';\r\nlet UsersRoles = 'AGR_USERS';\r\nlet Insert = \"I\";\r\nlet NotInUse = 'NOT_IN_USE';\r\nlet logsThreshold = 3; // 3 seconds\r\n// Audit Log Classes - Authorizations for user changed\r\nlet AuditClasses = dynamic(['AUR','AUT']); // Authorization/Authorization Profile &B created / changed.\r\n// Roles Change Documents - Extract Auth Object and Obj Field\r\nlet allHistory = ago(0d);\r\nlet alertSched = ago(6h); // Please maintain according to schedule\r\n// Maintain these if System doesn't have CR's\r\nlet fixedChangeDocs = datatable(User_s : string, ObjectClass_s : string, TableName_s : string, TypeofChange_Item_s : string , ChangedTableKey_s : string, ObjectID_s : string, TimeGenerated : datetime, ValueNew_s : string, SystemID_s : string)[];\r\nlet ChangeDocs = \r\nunion isfuzzy=true table(\"ABAPChangeDocsLog_CL\"), fixedChangeDocs;\r\nlet RolesAuthObject = ChangeDocs  \r\n    | where TimeGenerated >= alertSched\r\n    | where ObjectClass_s == ObjectClassRoles and TableName_s == TableName // Role-Obj-Profile-ObjField\r\n    | where TypeofChange_Item_s in ('J', 'I', 'U') //  Insert\r\n    | extend RoleObjProfileObjFieldVer = ChangedTableKey_s, Role = ObjectID_s\r\n    | extend ObjFieldValue = ValueNew_s    \r\n    | extend ObjField = trim(@\"\\s*?\", extract(@\"(^.{1,30})\\s*?(.{1,10})\\s*?(.{1,12})\\s*?(.{1,10})\\s*?\\d{6}\", 4, RoleObjProfileObjFieldVer, typeof(string)))\r\n    | extend AuthObject = trim(@\"\\s*?\", extract(@\"(^.{1,30})\\s*?(.{1,10})\\s*?(.{1,12})\\s*?(.{1,10})\\s*?\\d{6}\", 2, RoleObjProfileObjFieldVer, typeof(string)))\r\n    | extend TimeGenRoleAuth = TimeGenerated;\r\nlet ComplexAuth = _GetWatchlist('SAP - Critical Authorizations');\r\nlet SimpleAuth = _GetWatchlist('SAP - Critical Authorizations');\r\nlet fixedComplexAuth = datatable(AuthorizationObject: string, AuthorizationField: string, AuthorizationValue: string, ActivityField: string, Activity: string)\r\n    ['S_DEVELOP', 'OBJTYPE', 'DEBUG', 'ACTVT', '*',\r\n    'S_DEVELOP', 'OBJTYPE', 'DEBUG', 'ACTVT', '02']; // Maintain these if WatchList is not available\r\nlet fixedSimpleAuth = datatable(AuthorizationObject: string, AuthorizationField: string, AuthorizationValue: string, ActivityField: string, Activity: string)\r\n    ['S_TCODE', 'TCD', '*', 'NOT_IN_USE', '',\r\n    'S_TZONE', 'ACTVT', '*', 'NOT_IN_USE', '']; // Maintain these if WatchList is not available\r\nlet usersinRole = \r\n    ChangeDocs  \r\n    | where TimeGenerated <= allHistory\r\n    | where ObjectClass_s == ObjectClassRoles // Roles\r\n        and TableName_s == UsersRoles // Users Roles\r\n        and TypeofChange_Item_s == Insert // Insert \r\n    | extend UserAssigned = extract(@\"^.{1,33}\\s*?(.{1,12})\\s*?\\d{16}\", 1, ChangedTableKey_s)\r\n    | extend Role = ObjectID_s\r\n    | summarize by SystemID_s, Role, UserAssigned;\r\nlet RolesAuthObjectCheck =     \r\n        RolesAuthObject     \r\n        | extend ObjFieldVal = ObjFieldValue\r\n        | lookup kind = leftouter \r\n            (RolesAuthObject \r\n            | extend ActivityVal = ObjFieldValue)\r\n            on Role, AuthObject;\r\nlet complexScenario = union ComplexAuth, fixedComplexAuth\r\n    | where ActivityField != NotInUse\r\n    | summarize by AuthorizationObject, AuthorizationField, AuthorizationValue, ActivityField, Activity\r\n    | lookup kind = inner (RolesAuthObjectCheck)\r\n        on $left.AuthorizationObject == $right.AuthObject \r\n        and $left.AuthorizationField == $right.ObjField \r\n        and $left.AuthorizationValue == $right.ObjFieldValue\r\n        and $left.ActivityField == $right.ObjField1\r\n        and $left.Activity == $right.ActivityVal;\r\nlet simpleScenario = \r\n    union SimpleAuth, fixedSimpleAuth\r\n    | where ActivityField == NotInUse\r\n    | summarize by AuthorizationObject, AuthorizationField, AuthorizationValue, ActivityField, Activity \r\n    | lookup  kind = inner (RolesAuthObject)\r\n        on $left.AuthorizationObject == $right.AuthObject \r\n        and $left.AuthorizationField == $right.ObjField \r\n        and $left.AuthorizationValue == $right.ObjFieldValue;\r\nlet GetEntities =\r\n    ABAPAuditLog_CL \r\n    | where MessageID_s in (AuditClasses)\r\n    | summarize by TimeGenerated, ClientID_s, TerminalIPv6_s, User_s, Host_s, Email_s\r\n    | extend TimeGenAudit = TimeGenerated;\r\nunion complexScenario, simpleScenario\r\n| lookup kind = inner (usersinRole) on SystemID_s, Role\r\n| lookup kind = leftouter (GetEntities) on User_s\r\n| where abs(datetime_diff('second', TimeGenRoleAuth, TimeGenAudit)) <= logsThreshold or\r\nisnull(TimeGenAudit)\r\n| project \r\n    // Details\r\nTimeGenRoleAuth, SystemID_s, ClientID_s, Role, User_s, UserAssigned, AuthorizationObject, AuthorizationField, AuthorizationValue, ActivityField, Activity, Email_s, TerminalIPv6_s, Host_s",
            "queryFrequency": "PT6H",
            "queryPeriod": "PT6H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "PrivilegeEscalation"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_System_I_D": "SystemID_s",
                "SAP_Client": "ClientID_s",
                "SAP_User": "User_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/a75221fb-0a3c-4754-8202-cd11785116d1')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - Medium - Critical authorizations assignment - New User Assignment",
            "description": "Identifies assignment of a critical authorization object value to a new user.\n\nSource Action: Assign a new user to a role which holds critical authorization values using SU01/PFCG.\n\nCritical authorization objects should be maintained in watchlist \"\"SAP - Critical Authorization Objects\"\"\n\n*Data Sources: SAPcon -  Change Documents Log*",
            "severity": "Medium",
            "enabled": true,
            "query": "// New Assigned Users\r\nlet ObjectClassRoles = 'PFCG';\r\nlet TableName = 'CD1251';\r\nlet UsersRoles = 'AGR_USERS';\r\nlet Insert = \"I\";\r\nlet NotInUse = 'NOT_IN_USE';\r\nlet logsThreshold = 3; // 3 seconds\r\n// Audit Log Classes - Authorizations for user changed\r\nlet AuditClasses = dynamic(['AUB','AUD']); // Authorizations for user &A changed. User Master Record Changed\r\n// Roles Change Documents - Extract Auth Object and Obj Field\r\nlet allHistory = ago(0d);\r\nlet alertSched = ago(6h); // Please maintain according to schedule\r\n// Maintain these if System doesn't have CR's\r\nlet fixedChangeDocs = datatable(User_s : string, ObjectClass_s : string, TableName_s : string, TypeofChange_Item_s : string , ChangedTableKey_s : string, ObjectID_s : string, TimeGenerated : datetime, ValueNew_s : string, SystemID_s : string)[];\r\nlet ChangeDocs = \r\nunion isfuzzy=true table(\"ABAPChangeDocsLog_CL\"), fixedChangeDocs;\r\nlet RolesAuthObject = ChangeDocs  \r\n    | where TimeGenerated <= allHistory\r\n    | where ObjectClass_s == ObjectClassRoles and TableName_s == TableName // Role-Obj-Profile-ObjField\r\n    | where TypeofChange_Item_s in ('J', 'I', 'U') //  Insert\r\n    | extend RoleObjProfileObjFieldVer = ChangedTableKey_s, Role = ObjectID_s\r\n    | extend ObjFieldValue = ValueNew_s    \r\n    | extend ObjField = trim(@\"\\s*?\", extract(@\"(^.{1,30})\\s*?(.{1,10})\\s*?(.{1,12})\\s*?(.{1,10})\\s*?\\d{6}\", 4, RoleObjProfileObjFieldVer, typeof(string)))\r\n    | extend AuthObject = trim(@\"\\s*?\", extract(@\"(^.{1,30})\\s*?(.{1,10})\\s*?(.{1,12})\\s*?(.{1,10})\\s*?\\d{6}\", 2, RoleObjProfileObjFieldVer, typeof(string)))\r\n    | summarize by SystemID_s, Role, AuthObject, ObjField, ObjFieldValue;\r\nlet ComplexAuth = _GetWatchlist('SAP - Critical Authorizations');\r\nlet SimpleAuth = _GetWatchlist('SAP - Critical Authorizations');\r\nlet fixedComplexAuth = datatable(AuthorizationObject: string, AuthorizationField: string, AuthorizationValue: string, ActivityField: string, Activity: string)\r\n    ['S_DEVELOP', 'OBJTYPE', 'DEBUG', 'ACTVT', '*',\r\n    'S_DEVELOP', 'OBJTYPE', 'DEBUG', 'ACTVT', '02']; // Maintain these if WatchList is not available\r\nlet fixedSimpleAuth = datatable(AuthorizationObject: string, AuthorizationField: string, AuthorizationValue: string, ActivityField: string, Activity: string)\r\n    ['S_TCODE', 'TCD', '*', 'NOT_IN_USE', '',\r\n    'S_TZONE', 'ACTVT', '*', 'NOT_IN_USE', '']; // Maintain these if WatchList is not available\r\nlet usersinRole = \r\n    ChangeDocs  \r\n    | where TimeGenerated >= alertSched\r\n    | where ObjectClass_s == ObjectClassRoles // Roles\r\n        and TableName_s == UsersRoles // Users Roles\r\n        and TypeofChange_Item_s == Insert // Insert \r\n    | extend UserAssigned = extract(@\"^.{1,33}\\s*?(.{1,12})\\s*?\\d{16}\", 1, ChangedTableKey_s)\r\n    | extend Role = ObjectID_s\r\n    | extend TimeGenUserinRole = TimeGenerated;\r\n    //| summarize by TimeGenerated, SystemID_s, ClientID_s, Role, UserAssigned, User_s\r\nlet RolesAuthObjectCheck =     \r\n        RolesAuthObject     \r\n        | extend ObjFieldVal = ObjFieldValue\r\n        | lookup kind = leftouter \r\n            (RolesAuthObject \r\n            | extend ActivityVal = ObjFieldValue)\r\n            on Role, AuthObject;\r\nlet complexScenario = \r\n    union ComplexAuth, fixedComplexAuth\r\n    | where ActivityField != NotInUse\r\n    | summarize by AuthorizationObject, AuthorizationField, AuthorizationValue, ActivityField, Activity\r\n    | lookup kind = inner (RolesAuthObjectCheck)\r\n        on $left.AuthorizationObject == $right.AuthObject \r\n        and $left.AuthorizationField == $right.ObjField \r\n        and $left.AuthorizationValue == $right.ObjFieldValue\r\n        and $left.ActivityField == $right.ObjField1\r\n        and $left.Activity == $right.ActivityVal;\r\nlet simpleScenario = \r\n    union SimpleAuth, fixedSimpleAuth\r\n    | where ActivityField == NotInUse\r\n    | summarize by AuthorizationObject, AuthorizationField, AuthorizationValue, ActivityField, Activity \r\n    | lookup kind = inner (RolesAuthObject)\r\n        on $left.AuthorizationObject == $right.AuthObject \r\n        and $left.AuthorizationField == $right.ObjField \r\n        and $left.AuthorizationValue == $right.ObjFieldValue;\r\nlet GetEntites =     \r\n    ABAPAuditLog_CL \r\n    | where TimeGenerated >= alertSched\r\n    | where MessageID_s in (AuditClasses)\r\n    | summarize by TimeGenerated, TerminalIPv6_s, ClientID_s, User_s, Host_s, Email_s\r\n    | extend TimeGenAudit = TimeGenerated;  \r\nunion complexScenario, simpleScenario\r\n| lookup kind = inner (usersinRole) on SystemID_s, Role\r\n| lookup kind = leftouter (GetEntites) on User_s\r\n| where abs(datetime_diff('second', TimeGenUserinRole, TimeGenAudit)) <= logsThreshold or\r\nisnull(TimeGenAudit)\r\n| project \r\n    // Details\r\nTimeGenUserinRole , SystemID_s, ClientID_s, Role, User_s, UserAssigned, AuthorizationObject, AuthorizationField, AuthorizationValue, ActivityField, Activity, Email_s, TerminalIPv6_s, Host_s",
            "queryFrequency": "PT6H",
            "queryPeriod": "PT6H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "PrivilegeEscalation"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_Client": "ClientID_s",
                "SAP_User": "User_s",
                "SAP_System_I_D": "SystemID_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/1afd36e2-379e-4002-8642-41a3e0a161ee')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - Medium - Debugging Activities",
            "description": "Identifies all debugging related activities.\n\nSource Action: Activate Debug (\"/h\") in system, debug an active process, add breakpoint to source code etc.\n\n**Recommended for Production only**\n\n*Data Sources: SAPcon -  Audit Log*",
            "severity": "Medium",
            "enabled": true,
            "query": "let Role = 'Production';\r\nlet DebuggerProgram = 'RSTPDAMAIN';\r\nlet AuditClasses = dynamic(['CUK','CUL','CUM','CUN','CUO','CUP']); // Audit Log Classes - Debug Activities\r\nlet allSystemRoles = dynamic(['Sandbox','Developement','QualityAssurance','Training','Production']); // Available System Roles\r\nlet allSystemUsage = dynamic (['ERP','CRM','BW','Solman','Gateway','Enterprise Portal']); // Available System Usages\r\n// Get Relevant Systems from WatchList\r\nlet systemID = _GetWatchlist('SAP - Systems')\r\n| where SystemRole == Role; // Reccommended is Production only\r\nlet fixedSID = datatable(SystemID:string, SystemRole:string, SystemUsage:string)\r\n// Maintain these if WatchList is not available    \r\n    [\"S4H\",\"Production\",\"ERP\",\r\n    \"XXX\",\"Sandbox\",\"BW\"]\r\n    | where SystemRole == Role // Reccommended is Production only\r\n; \r\nlet SystemUnited = union systemID, fixedSID\r\n| summarize by SystemID, SystemRole, SystemUsage;\r\n//| where SystemRole in (allSystemRoles); // Use this for all system roles\r\nABAPAuditLog_CL \r\n    | where MessageID_s in (AuditClasses) or ABAPProgramName_s == DebuggerProgram // Get logs by messege ID or program name\r\n    | extend Object = extract(@\":\\s\\(?(\\w{1,}\\s?-?\\w{1,})\", 1, MessageText_s, typeof(string)) // Extract Object\r\n    | extend Action = extract(@\":\\s\\(?(\\w{1,}\\s?-?\\w{1,}.{1,}?)\\)?\\(\", 1, MessageText_s, typeof(string)) // Extract Action\r\n    | extend Program = extract(@\"Prgm:(\\w{1,})\", 1, MessageText_s, typeof(string)) // Extract Program\r\n    | extend Function = extract(@\"Funct:(\\w{1,})\", 1, MessageText_s, typeof(string)) // Extract Function\r\n    | extend Include = extract(@\"Incl:(\\w{1,})\", 1, MessageText_s, typeof(string)) // Extract Include\r\n    | extend Line = extract(@\"Line:(\\w{1,})\", 1, MessageText_s, typeof(string)) // Extract Line\r\n    | project-rename SystemID = SystemID_s\r\n    | lookup kind=inner (SystemUnited) on SystemID\r\n    | order by TimeGenerated asc\r\n    | project TimeGenerated, Instance_s, ClientID_s ,User_s, MessageText_s, ABAPProgramName_s, TransactionCode_s, SystemID, SystemRole, SystemUsage,MessageID_s, Email_s, TerminalIPv6_s, Host_s, Object , Action, Program, Function, Include, Line",
            "queryFrequency": "PT3H",
            "queryPeriod": "PT3H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "Discovery"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_User": "User_s",
                "SAP_System_I_D": "SystemID",
                "SAP_Instance": "Instance_s",
                "SAP_Client": "ClientID_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/25183b6a-5340-44a8-8830-b5b2ecd75d57')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - Medium - Execution of Obsolete or Insecure Function Module",
            "description": "Identifies execution of an obsolete/insecure ABAP Function Module.\n\nSource Action: Execute an obsolete/insecure function module directly using SE37.\n\n**Recommended for Production only**\n\nObsolete functions should be maintained in \"SAP - Obsolete Function Modules\" Watchlist.\nTable logging changes should be activated for table \"EUFUNC\" in backend. (SE13)\n\n*Data Sources: SAPcon -  Table Data Log*",
            "severity": "Medium",
            "enabled": true,
            "query": "// Define variables\r\nlet RelTable = \"EUFUNC\"; // Relevant table\r\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user\r\nlet ObsoleteModules =  _GetWatchlist('SAP - Obsolete Function Modules');\r\n// Maintain if watchlist is not available\r\nlet fixedModules = datatable(FunctionModule:string)['TH_SAPREL','TH_SAPREL2', 'TH_SAPREL3','SUSR_RFC_USER_INTERFACE','RFC_ABAP_INSTALL_AND_RUN']; \r\nlet UnitedModules =\r\ntoscalar(union fixedModules, ObsoleteModules\r\n| summarize FunctionModules =  make_set(FunctionModule));\r\n// Query logic\r\nlet LastLogin = \r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditLogIn)\r\n| summarize TimeGenerated = arg_max(TimeGenerated, *) by SystemID_s, ClientID_s, User_s; // Get last connection date for user\r\nABAPTableDataLog_CL\r\n| where TableName_s == RelTable\r\n| extend Module = extract(@\"\\s+(.{1,}\\b)\\s+\", 1, LogKey_s, typeof(string)) // Extract Function Module\r\n| extend FunctionGroup = extract(@\"^FL([^\\s]*)\\s\", 1, LogKey_s, typeof(string)) // Extract Function Group\r\n| extend ExecutionVariant = extract(@\"\\b(\\w+)$\", 1, LogKey_s, typeof(string)) // Extract Execution Varient\r\n| where Module in (UnitedModules) // Module is obsolete\r\n| lookup kind=inner LastLogin on $left.UserName_s == $right.User_s\r\n| project TimeGenerated, SystemID_s, ClientID_s, UserName_s, Email_s, TerminalIPv6_s, Host_s, Module, FunctionGroup, ExecutionVariant",
            "queryFrequency": "PT2H",
            "queryPeriod": "PT2H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "Discovery",
                "CommandAndControl"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_System_I_D": "SystemID_s",
                "SAP_Client": "ClientID_s",
                "SAP_User": "UserName_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/bea62349-d449-4a26-b523-c7d3fb17fb08')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - Medium - Execution of Obsolete/Insecure Program",
            "description": "Identifies execution of an obsolete/insecure ABAP program.\nSource Action: Execute a program directly using SE38/SA38/SE80 or by using a background job.\n**Recommended for Production only**\nObsolete programs should be maintained in \"SAP - Obsolete Programs\" Watchlist\n*Data Sources: SAPcon -  Audit Log*",
            "severity": "Medium",
            "enabled": true,
            "query": "// Define Variables\r\nlet AuditClasses = dynamic(['AUW']); // Audit Log Classes - Report Started\r\nlet ObsoletePrograms = _GetWatchlist(\"SAP - Obsolete Programs\");\r\n// Maintain if watchlist is not available\r\nlet fixedObPrograms = datatable(ABAPProgram:string)['RSAU_READ_LOG'];\r\nlet UnitedPrograms =\r\ntoscalar(union fixedObPrograms, ObsoletePrograms\r\n| summarize Programs = make_set(ABAPProgram));\r\n// Query logic\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| where ABAPProgramName_s in (UnitedPrograms) // The program is obsolete\r\n| project TimeGenerated, Instance_s,SystemID_s, ClientID_s, User_s, ABAPProgramName_s, MessageText_s, TransactionCode_s, MessageID_s, Email_s, TerminalIPv6_s, Host_s",
            "queryFrequency": "PT2H",
            "queryPeriod": "PT2H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "Discovery",
                "CommandAndControl"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_System_I_D": "SystemID_s",
                "SAP_Client": "ClientID_s",
                "SAP_User": "User_s",
                "SAP_Instance": "Instance_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/a29e4080-08c4-4815-80d1-156e452931ae')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - Medium - FTP for non authorized servers",
            "description": "Identifies FTP connection for non authorized server.\nMaintain new Watchlist, similar to SAPFTP_SERVERS \nSource Action: Create a new FTP connection e.g. by using Function Module FTP_CONNECT.\n\n*Data Sources: SAPcon -  Audit Log*",
            "severity": "Medium",
            "enabled": true,
            "query": "// Define variables\r\nlet AuditClasses = dynamic(['DU8']); // Message of Successfull FTP Connection\r\nlet FTPSafeConnections = _GetWatchlist(\"SAP - FTP Servers\");\r\nlet fixedConnections = datatable(Client: string, Description: string,\r\nFTP_Server_Name: string, FTP_Server_Port: string)\r\n    // Maintain these if WatchList is not available    \r\n    [100, \"description\", \"http://ourorgftpserver.com/\", 22]\r\n;\r\nlet UnitedConnections = toscalar(union kind=inner FTPSafeConnections, fixedConnections | summarize Connections = make_set(FTP_Server_Name));\r\n// Query logic\r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditClasses)\r\n| where TerminalIPv6_s !in (UnitedConnections) // The IP is unknown\r\n| project TimeGenerated, Instance_s ,User_s, SystemID_s, ClientID_s, Email_s, TerminalIPv6_s, Host_s",
            "queryFrequency": "PT6H",
            "queryPeriod": "PT6H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "Discovery",
                "InitialAccess",
                "CommandAndControl"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_Client": "ClientID_s",
                "SAP_User": "User_s",
                "SAP_Instance": "Instance_s",
                "SAP_System_I_D": "SystemID_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/ff5a6a0a-aabb-49b0-b78b-51bc1cc749c6')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - Medium - Insecure FTP servers configuration",
            "description": " Identifies Insecure FTP servers configuration - FTP Whitelist is empty / Contains Placeholders.\n\nSource Action: Do not maintain / maintain values which contains placeholders in table SAPFTP_SERVERS using maintenance view SAPFTP_SERVERS_V. (SM30)\n\n*Data Sources: SAPcon -  Audit Log*",
            "severity": "Medium",
            "enabled": true,
            "query": "// Define variables\r\nlet AuditClasses = dynamic(['DU1', 'DU2']); // Messages of FTP Whitelist is empty / Contains Placeholders\r\n// Query logic\r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditClasses)\r\n| project TimeGenerated, Instance_s, SystemID_s, ClientID_s, User_s, Email_s, TerminalIPv6_s, Host_s, Reason = MessageText_s",
            "queryFrequency": "PT6H",
            "queryPeriod": "PT6H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "InitialAccess",
                "CommandAndControl"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_System_I_D": "SystemID_s",
                "SAP_Client": "ClientID_s",
                "SAP_Instance": "Instance_s",
                "SAP_User": "User_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/208a4a87-75b5-4e67-bc0a-41f3f3a8bcb2')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - Medium - Multiple Files Download",
            "description": "Identifies multiple files downloads for a user within a specific timerange.\n\nSource Action: Download multiple files while using SAPGui to Excel/Lists etc.\n\n*Data Sources: SAPcon -  Audit Log*",
            "severity": "Medium",
            "enabled": true,
            "query": "// Define variables\r\nlet NumberOfDownloads = 10; // Number of downloads of user as threshold\r\nlet HoursBucket = 2h; // How much time between buckets\r\nlet AuditClasses = dynamic([\"AUY\"]); // Relevant message\r\n// Query logic\r\nABAPAuditLog_CL // Get all downloads\r\n| where MessageID_s in (AuditClasses)\r\n| summarize DownloadsByUser = count() by bin(TimeGenerated, HoursBucket), SystemID_s, ClientID_s, User_s, TerminalIPv6_s, Email_s, Host_s\r\n| where DownloadsByUser >= NumberOfDownloads // User downloaded more than threshold\r\n| project SystemID_s, ClientID_s, User_s, Email_s, TerminalIPv6_s, Host_s,DownloadsByUser",
            "queryFrequency": "PT12H",
            "queryPeriod": "PT12H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "Collection",
                "Exfiltration",
                "CredentialAccess"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_User": "User_s",
                "SAP_Client": "ClientID_s",
                "SAP_System_I_D": "SystemID_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/fa36840a-afb3-413c-a18f-b5f49fdb9264')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - Medium - Multiple Logons by IP",
            "description": "Identifies logon of several users from same IP within scheduled time interval.\n\nSource Action: Logon using several users thorugh the same IP.\n\n*Data Sources: SAPcon -  Audit Log*",
            "severity": "Medium",
            "enabled": true,
            "query": "// Define variables\r\nlet AuditClasses = dynamic(['AU1', 'AU5']); // Audit Log Classes - Dialog Logon Successful, RFC Logon Successful\r\nlet DialogLogonTypes = dynamic(['A', 'C', 'F', 'R', 'S', 'U', 'H', 'u', ' ']); // Dialog / CPIC / RFC Int / RFC Ext / SRFC / User Switch / HTTP / Restore Session / API Call\r\nlet excNetworks = _GetWatchlist('SAP - Excluded Networks'); // Networks that should be removed from query\r\nlet fixedNetworks =\r\ndatatable(Network:string)\r\n// Maintain these if WatchList is not available    \r\n    [\"111.68.128.0/1\", \"123.68.128.0/1\", \"\"]\r\n; \r\nlet UnitedNetworks =\r\ntoscalar(union excNetworks, fixedNetworks\r\n| summarize Networks = make_set(Network));\r\nlet UsersperIP = 1;\r\n// Query logic\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| where Variable1_s in (DialogLogonTypes)\r\n| where TerminalIPv6_s !in (UnitedNetworks)\r\n| extend UserandEmail = pack(\"ID\", User_s, \"Email\", Email_s)\r\n| summarize CountUsers = dcount(strcat(User_s, \"_&_\", Email_s)), Users = make_set(UserandEmail), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) \r\n    by SystemID_s, ClientID_s, TerminalIPv6_s\r\n| where CountUsers > UsersperIP\r\n| mv-expand Users \r\n| evaluate bag_unpack(Users, \"User_\")\r\n| project SystemID_s , ClientID_s, TerminalIPv6_s, StartTime, EndTime,\r\n    User = column_ifexists(\"User_ID\", \"\"),    \r\n    Email = column_ifexists(\"User_Email\", \"\")\r\n",
            "queryFrequency": "PT1H",
            "queryPeriod": "PT1H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "InitialAccess"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_Client": "ClientID_s",
                "SAP_System_I_D": "SystemID_s",
                "SAP_User": "User"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/b89e8260-1e81-4edb-b8dd-5011d92e4d50')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - Medium - Multiple Logons by User",
            "description": "Identifies logon of the same user from several terminals within scheduled time interval.\n\nSource Action: Logon using the same user thorugh different IP's.\n\n*Data Sources: SAPcon -  Audit Log*",
            "severity": "Medium",
            "enabled": true,
            "query": "// Define variables\r\n// Audit Log Classes - Dialog Logon Successful, RFC Logon Successful\r\nlet AuditClasses = dynamic(['AU1','AU5']);\r\n// Dialog / CPIC / RFC Int / RFC Ext / SRFC / User Switch / HTTP / Restore Session / API Call\r\nlet DialogLogonTypes = dynamic(['A', 'C', 'F', 'R', 'S', 'U', 'H', 'u', ' ']);\r\nlet excUsers = _GetWatchlist('SAP - Excluded Users'); // Users that should be removed from query\r\nlet fixedExcUsers = datatable(User:string)\r\n// Maintain these if WatchList is not available    \r\n    [\"SYSWF\"]\r\n; \r\nlet UnitedExcUsers =\r\ntoscalar(union excUsers, fixedExcUsers\r\n| summarize Users = make_set(User));\r\nlet IPThreshold = 1;\r\n// Query Logic\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| where Variable1_s in (DialogLogonTypes)\r\n| where User_s !in (UnitedExcUsers)\r\n| summarize CountIP = dcount(TerminalIPv6_s), IPs = make_set(TerminalIPv6_s), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by SystemID_s, ClientID_s, User_s, Email_s\r\n| where CountIP > IPThreshold // Count of IP logins from the user is higher than threshold\r\n| mv-expand IPs to typeof(string ) // Show for each IP\r\n| project SystemID_s, ClientID_s, User_s, StartTime, EndTime,\r\n    Email_s, IPs",
            "queryFrequency": "PT1H",
            "queryPeriod": "PT1H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "PreAttack",
                "CredentialAccess",
                "InitialAccess",
                "Collection"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_Client": "ClientID_s",
                "SAP_System_I_D": "SystemID_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "IPs"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/7b450b18-4279-461c-9193-e8d95a76cdd0')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - Medium - Multiple Spool Executions",
            "description": "Identifies multiple spools for a user within a specific timerange.\n\nSource Action: Create and execute multiple Spool Jobs from any type by a user. (SP01)\n\n*Data Sources: SAPcon -  Spool Log*",
            "severity": "Medium",
            "enabled": true,
            "query": "// Define variables\r\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user\r\nlet NumberOfRequests = 3; // Number of requests as threshold\r\nlet HoursBucket = 2h; // // How much time between buckets\r\n// Query logic\r\nlet LastLogin = \r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditLogIn)\r\n| summarize TimeGenerated = arg_max(TimeGenerated, *) by SystemID_s, ClientID_s, User_s, Instance_s; // Get last connection date for user\r\nABAPSpoolLog_CL // Get all spool requests\r\n| summarize UserRequests = count() by bin(TimeGenerated, HoursBucket), SystemID_s, ClientID_s, User_s, Instance_s\r\n| where UserRequests >= NumberOfRequests // User requested to print more than threshold\r\n| lookup kind=inner LastLogin on User_s // Check IP of last login\r\n| project TimeGenerated, Instance_s, SystemID_s, ClientID_s, User_s, Email_s, TerminalIPv6_s, Host_s, UserRequests",
            "queryFrequency": "PT12H",
            "queryPeriod": "PT12H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "CredentialAccess",
                "Collection",
                "Exfiltration"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_User": "User_s",
                "SAP_Instance": "Instance_s",
                "SAP_System_I_D": "SystemID_s",
                "SAP_Client": "ClientID_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/e4e6a5ff-d25c-46b6-a3c9-b82212f741e3')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - Medium - Multiple Spool Output Executions",
            "description": "Identifies multiple spools for a user within a specific timerange.\n\nSource Action: Create and execute multiple Spool Jobs from any type by a user. (SP01)\n\n*Data Sources: SAPcon -  Spool Log*",
            "severity": "Medium",
            "enabled": true,
            "query": "// Define variables\r\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messeges of connect with user\r\nlet NumberOfPrints = 3; // Number of prints as threshold\r\nlet HoursBucket = 2h; // // How much time between buckets\r\n// Query logic\r\nlet LastLogin =\r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditLogIn)\r\n| summarize arg_max(TimeGenerated, *) by SystemID_s, ClientID_s, User_s, Instance_s; // Get last connection date for user\r\nABAPSpoolOutputLog_CL // Get all spool outputs\r\n| summarize UserPrints = count() by bin(TimeGenerated, HoursBucket), SystemID_s, ClientID_s, User_s, Instance_s\r\n| where UserPrints >= NumberOfPrints // User requested to print more than threshold\r\n| lookup kind=inner LastLogin on User_s // Get IP of last login\r\n| project TimeGenerated, Instance_s, SystemID_s, ClientID_s, User_s, Email_s, TerminalIPv6_s,  Host_s, UserPrints",
            "queryFrequency": "PT12H",
            "queryPeriod": "PT12H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "CredentialAccess",
                "Collection",
                "Exfiltration"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_Instance": "Instance_s",
                "SAP_Client": "ClientID_s",
                "SAP_System_I_D": "SystemID_s",
                "SAP_User": "User_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/20c0dc12-e228-4caf-bbac-1ce5f9ab54da')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - Medium - Security Audit Log Configuration Change",
            "description": "Idenitifes changes for configuration in Securiy Audit Log\n\nSource Action: change any  Security Audit Log Configuration using SM19/RSAU_CONFIG. (Filters/Status/Recording mode etc..)\n\n*Data Sources: SAPcon -  Audit Log*",
            "severity": "Medium",
            "enabled": true,
            "query": "// Audit Log Classes - Audit Log Configuration Events\r\nlet AuditClasses = dynamic(['AUE','AUF','AUI','AUJ','FU0','E05']); // Relevant messages\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| project \r\n// Details\r\nTimeGenerated, Instance_s, SystemID_s, User_s, MessageText_s,\r\nEmail_s, TerminalIPv6_s, Host_s",
            "queryFrequency": "PT6H",
            "queryPeriod": "PT6H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "Persistence",
                "Exfiltration",
                "DefenseEvasion"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_User": "User_s",
                "SAP_System_I_D": "SystemID_s",
                "SAP_Instance": "Instance_s"
            },
            "entityMappings": [
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/5b090f0e-1a9e-409a-9478-d9db88876420')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - Medium - Sensitive Roles Changes",
            "description": "Identifies changes in sensitive roles. \nSource Action: Change a role using PFCG.\nSensitive roles should be maintained in \"SAP - Sensitive Roles\" Watchlist\n\n*Data Sources: SAPcon - Change Documents Log*",
            "severity": "Medium",
            "enabled": true,
            "query": "// Define variables\r\nlet RoleObjectClass = \"PFCG\";\r\nlet ChangeType = \"U\";\r\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user\r\nlet SensitiveRoles = _GetWatchlist(\"SAP - Sensitive Roles\");\r\n// Maintain if watchlist is not available\r\nlet fixedRoles = datatable(Role: string)['SAP_BC_BASIS_ADMIN', 'SAP_BC_AUTH_PROFILE_ADMIN'];\r\nlet UnitedRoles =\r\ntoscalar(union fixedRoles, SensitiveRoles\r\n| summarize Roles = make_list(Role));\r\n// Query logic\r\nlet LastLogin = \r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditLogIn)\r\n| summarize TimeGenerated = arg_max(TimeGenerated, *) by SystemID_s, ClientID_s, User_s; // Get last connection date for user\r\nABAPChangeDocsLog_CL\r\n| where ObjectClass_s == RoleObjectClass // Relevant role object class\r\n| where ObjectID_s in (UnitedRoles) // Role is sensitive\r\n| where TypeofChange_Item_s == ChangeType\r\n| extend AuthorizationObj = extract(@\"\\S+\\s+(\\S+)\\s+\", 1, ChangedTableKey_s, typeof(string)) // Extract Authorization Object\r\n| extend Authorization = extract(@\"\\S+\\s+\\S+\\s+(\\S+\\d+)\", 1, ChangedTableKey_s, typeof(string)) // Extract Authorization\r\n| lookup kind=inner LastLogin on User_s // Get IP\r\n| project TimeGenerated, Instance_s, SystemID_s, ClientID_s, Email_s, User_s, TerminalIPv6_s, Host_s, Role = ObjectID_s, FieldName_s , AuthorizationObj, Authorization, OldValue = ValueOld_s, NewValue = ValueNew_s",
            "queryFrequency": "PT12H",
            "queryPeriod": "PT12H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "Impact",
                "PrivilegeEscalation",
                "Persistence"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_Instance": "Instance_s",
                "SAP_Client": "ClientID_s",
                "SAP_System_I_D": "SystemID_s",
                "SAP_User": "User_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/5bc6037b-c775-4d22-b6cb-bb03aeed04ad')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - Medium - Sensitive Tables Direct Access By RFC Logon",
            "description": "Identifies generic table access by RFC logon\n\nSource Action: Open table contents using SE11/SE16/SE16N.\n\n**Recommended for Production only**\n\nTables should be maintained in \"SAP - Sensitive Tables\" Watchlist.\n\n*Data Sources: SAPcon -  Audit Log*",
            "severity": "Medium",
            "enabled": true,
            "query": "// Define variables\r\nlet Role = \"Production\";\r\nlet AuditClasses = dynamic(['CUZ']); // RFC, Audit Log Classes - Generic Table Access \r\nlet allSystemRoles = dynamic(['Sandbox','Developement','QualityAssurance','Training','Production']); // Available System Roles\r\nlet allSystemUsage = dynamic (['ERP','CRM','BW','Solman','Gateway','Enterprise Portal']); // Available System Usages\r\n// Get Relevant Systems from WatchList\r\nlet systemID = _GetWatchlist('SAP - Systems');\r\nlet fixedSID = datatable(SystemID:string, SystemRole:string, SystemUsage:string)\r\n// Maintain these if WatchList is not available    \r\n    [\"S4H\",\"Production\",\"ERP\",\r\n    \"XXX\",\"Sandbox\",\"BW\"]\r\n; \r\n// Get Relevant Tables\r\nlet SensitiveTables = _GetWatchlist('SAP - Sensitive Tables');\r\nlet fixedTables = datatable(Table:string)\r\n// Maintain these if WatchList is not available    \r\n    [\"USR02\"]\r\n; \r\nlet RelSystemID = union systemID, fixedSID // Create a variable that stores relevent Systems\r\n| where SystemRole == Role // Reccommended is Production only\r\n//| where SystemRole in (allSystemRoles); // Use this for all system roles\r\n| summarize by SystemID;\r\nlet SensitiveUnionTables = union SensitiveTables, fixedTables // Create a variable that stores relevent sensitive tables\r\n    | summarize by Table;\r\n// Query logic\r\nABAPAuditLog_CL \r\n    | project-rename Table = Variable1_s, Activity = Variable2_s\r\n    | where MessageID_s in (AuditClasses)\r\n    | where SystemID_s in (RelSystemID)\r\n    | where Table in (SensitiveUnionTables)\r\n    | order by TimeGenerated asc\r\n    | project TimeGenerated,Instance_s, SystemID_s, ClientID_s, User_s, TransactionCode_s, ABAPProgramName_s, Table,   Activity, MessageText_s, MessageID_s,\r\nEmail_s, TerminalIPv6_s, Host_s",
            "queryFrequency": "PT12H",
            "queryPeriod": "PT12H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "Collection",
                "Exfiltration",
                "CredentialAccess"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_User": "User_s",
                "SAP_Client": "ClientID_s",
                "SAP_System_I_D": "SystemID_s",
                "SAP_Instance": "Instance_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/06d1cd5b-0b5e-4043-9f11-bc6f62267fbd')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - Medium - Spool Takeover",
            "description": "Identifies a user printing a spool request which was created by someone else.\n\nSource Action: Create a Spool Request using one user, Output it in using another user.\n\n*Data Sources: SAPcon -  Spool Log*\n*Data Sources: SAPcon -  Spool Output Log*",
            "severity": "Medium",
            "enabled": true,
            "query": "// Define variables\r\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user\r\n// Query logic\r\nlet LastLogin = \r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditLogIn)\r\n| summarize TimeGenerated = arg_max(TimeGenerated, *) by SystemID_s, ClientID_s, User_s; // Get last connection date for user\r\n// Query Logic\r\nABAPSpoolOutputLog_CL // Get all spool outputs\r\n| lookup kind=inner ABAPSpoolLog_CL on SpoolRequestNumber_d\r\n| lookup kind=inner LastLogin on User_s\r\n| where User_s != User_s1 // The user that created the request is not the one that printed it\r\n| project TimeGenerated, Instance_s, SystemID_s, ClientID_s, UserCreated = User_s1, UserPrinted = User_s, SpoolRequestNumber_d, Email_s, TerminalIPv6_s, Host_s",
            "queryFrequency": "PT12H",
            "queryPeriod": "PT12H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "Collection",
                "Exfiltration",
                "CommandAndControl"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_Client": "ClientID_s",
                "SAP_Instance": "Instance_s",
                "SAP_System_I_D": "SystemID_s",
                "SAP_User": "UserPrinted"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/d9cbe2ba-7fe4-47b7-8e07-3903fb296951')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - Medium - Transaction is unlocked",
            "description": "Identifies unlocking of a transaction. \n\nSource Action: Unlock a transaction code using SM01/SM01_DEV/SM01_CUS.\n\n*Data Sources: SAPcon -  Audit Log*\n",
            "severity": "Medium",
            "enabled": true,
            "query": "// Audit Log Classes - Transaction UnLock Events\r\n// AUP - Transaction Locked\r\nlet AuditClasses = dynamic(['AUQ']); // AUQ - Transaction Unlocked\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| project-rename TransactionCode = Variable1_s\r\n| parse TransactionCode with \"( TR ) \" _TCODE \" - \" ClientTR // Parse to _TCODE and ClientTR\r\n// Specific Client Action (SM01_CUS) / Cross Client (SM01_DEV)\r\n| extend TransactionCode = iif(_TCODE != \"\",_TCODE, TransactionCode) // Check if _TCODE is not empty\r\n| extend ClientTR = iif(ClientTR != \"\",ClientTR, \"CrossClient\") // Check if ClientTR is not empty\r\n| project \r\n// Details\r\nTimeGenerated, Instance_s, SystemID_s, User_s, MessageText_s,TransactionCode, ClientTR,\r\nEmail_s, TerminalIPv6_s, Host_s\r\n\r\n",
            "queryFrequency": "P1D",
            "queryPeriod": "P1D",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "Persistence",
                "Execution"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_Client": "ClientTR",
                "SAP_System_I_D": "SystemID_s",
                "SAP_User": "User_s",
                "SAP_Instance": "Instance_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/a5995af7-9d04-4665-892c-81b16b9f0d03')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - Low - Dynamic ABAP Program",
            "description": "Identifies execution of dynamic ABAP programming. For example, ABAP code was dynamically created/changed/deleted. Source Action: Create an ABAP Report which uses ABAP program generation commands such as \"INSERT REPORT\" and execute it. Excluded Transaction Codes can be maintained in \"SAP - Transactions for ABAP Generations\" watchlist. *Data Sources: SAPcon - Audit Log*",
            "severity": "Low",
            "enabled": true,
            "query": "// Define variables\r\nlet AuditClasses = dynamic(['BU4']); // Message of dynamic ABAP program\r\nlet TranForABAPGen = _GetWatchlist(\"SAP - Transactions for ABAP Generations\"); // Transactions to exclude\r\n// Maintain if watchlist is not available\r\nlet fixedTran = datatable(TransactionCode:string)['SE11','SE12', \"SE16\", \"SE16N\"];\r\nlet UnitedTransactions =\r\ntoscalar(union TranForABAPGen, fixedTran\r\n| summarize Transactions = make_set(TransactionCode));\r\n// Query logic\r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditClasses)\r\n| where TransactionCode_s !in (UnitedTransactions) // Exclude transactions\r\n| project TimeGenerated, Instance_s, User_s, SystemID_s, ClientID_s, Email_s, TerminalIPv6_s, Host_s, ABAPProgramName_s",
            "queryFrequency": "PT6H",
            "queryPeriod": "PT6H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "Discovery",
                "CommandAndControl",
                "Impact"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_Client": "ClientID_s",
                "SAP_Instance": "Instance_s",
                "SAP_User": "User_s",
                "SAP_System_I_D": "SystemID_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "HostName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/8ce3473d-5e4b-4590-a86e-7770f0de42f5')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - Low - Dynamic RFC Destination",
            "description": "Identifies execution of RFC using dynamic destinations. Source Action: Execute an ABAP report which is using dynamic destinations (cl_dynamic_destination). Sample report: DEMO_RFC_DYNAMIC_DEST. *Data Sources: SAPcon - Audit Log*",
            "severity": "Low",
            "enabled": true,
            "query": "// Define variables\r\nlet AuditClasses = dynamic(['FU1']); // Message of dynamic RFC execution using dynamic destination\r\n// Query logic\r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditClasses)\r\n| parse Variable3_s with \"id=\" Created_RFC_Name\r\n| project TimeGenerated,Instance_s, SystemID_s, ClientID_s, User_s, Email_s, TerminalIPv6_s, Host_s, ABAPProgramName_s, ExecutedProgram = Variable2_s, Created_RFC_Name",
            "queryFrequency": "PT6H",
            "queryPeriod": "PT6H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "Collection",
                "Exfiltration"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_Client": "ClientID_s",
                "SAP_User": "User_s",
                "SAP_System_I_D": "SystemID_s",
                "SAP_Instance": "Instance_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/9e159c93-4c1f-4b40-9a78-8a562fde7dbc')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - Low - Multiple Password Changes by User",
            "description": "Identifies multiple password changes by user.\n\nSource Action: Change user password\n\n*Data Sources: SAPcon -  Audit Log*",
            "severity": "Low",
            "enabled": true,
            "query": "// Define variables\r\nlet systemsPerUser = 3; // Systems Clients per User\r\nlet AuditClasses = dynamic(['BU2']); // Audit Log Classes - Password Changed\r\n// Query logic\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| project-rename UserReset = Variable2_s\r\n| extend DetailsBy = pack(\"SystemID\", SystemID_s, \"ClientID\", ClientID_s)\r\n| summarize CountSysClient = dcount(strcat(SystemID_s, ClientID_s)), Details = make_set(DetailsBy), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) \r\n    by UserReset, User_s, Email_s, TerminalIPv6_s\r\n| where CountSysClient > systemsPerUser // Number of passwords changed by user\r\n| mv-expand Details\r\n| evaluate bag_unpack(Details, \"Details_\") // Unpack the details to a couple of fields\r\n| project \r\n    StartTime, EndTime, UserReset, User_s, Email_s, TerminalIPv6_s,\r\n    SystemID = column_ifexists(\"Details_SystemID\", \"\"),\r\n    ClientID = column_ifexists(\"Details_ClientID\", \"\")",
            "queryFrequency": "PT3H",
            "queryPeriod": "PT3H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "CredentialAccess"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_Client": "ClientID",
                "SAP_System_I_D": "SystemID",
                "SAP_User": "User_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/34179973-7a7a-42c9-88d0-7f12c82cbd29')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - Low - Sensitive Tables Direct Access By Dialog Logon",
            "description": "Identifies generic table access by dialog logon\n\nSource Action: Open table contents using SE11/SE16/SE16N.\n\n**Recommended for Production only**\n\nTables should be maintained in \"\"SAP - Sensitive Tables\"\" Watchlist.\n\n*Data Sources: SAPcon -  Audit Log*",
            "severity": "Low",
            "enabled": true,
            "query": "// Define variables\r\nlet Role = \"Production\";\r\nlet AuditClasses = dynamic(['DU9']); // Dialog, Audit Log Classes - Generic Table Access \r\nlet allSystemRoles = dynamic(['Sandbox','Developement','QualityAssurance','Training','Production']); // Available System Roles\r\nlet allSystemUsage = dynamic (['ERP','CRM','BW','Solman','Gateway','Enterprise Portal']); // Available System Usages\r\n// Get Relevant Systems from WatchList\r\nlet systemID = _GetWatchlist('SAP - Systems');\r\nlet fixedSID = datatable(SystemID:string, SystemRole:string, SystemUsage:string)\r\n// Maintain these if WatchList is not available    \r\n    [\"S4H\",\"Production\",\"ERP\",\r\n    \"XXX\",\"Sandbox\",\"BW\"]\r\n; \r\n// Get Relevant Tables\r\nlet SensitiveTables = _GetWatchlist('SAP - Sensitive Tables');\r\nlet fixedTables = datatable(Table:string)\r\n// Maintain these if WatchList is not available    \r\n    [\"USR02\"]\r\n; \r\nlet RelSystemID = union systemID, fixedSID // Create a variable that stores relevant Systems\r\n| where SystemRole == Role // Recommended  is Production only\r\n//| where SystemRole in (allSystemRoles); // Use this for all system roles\r\n| summarize by SystemID;\r\nlet SensitiveUnionTables = union SensitiveTables, fixedTables // Create a variable that stores relevant sensitive tables\r\n    | summarize by Table;\r\n// Query logic\r\nABAPAuditLog_CL \r\n    | project-rename Table = Variable1_s, Activity = Variable2_s\r\n    | where MessageID_s in (AuditClasses)\r\n    | where SystemID_s in (RelSystemID)\r\n    | where Table in (SensitiveUnionTables)\r\n    | order by TimeGenerated asc\r\n    | project TimeGenerated, Instance_s, SystemID_s, ClientID_s, User_s, TransactionCode_s, ABAPProgramName_s, Table,   Activity, MessageText_s, MessageID_s,\r\nEmail_s, TerminalIPv6_s, Host_s",
            "queryFrequency": "PT12H",
            "queryPeriod": "PT12H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [
                "Discovery"
            ],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_Client": "ClientID_s",
                "SAP_System_I_D": "SystemID_s",
                "SAP_Instance": "Instance_s",
                "SAP_User": "User_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    },
    {
        "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/b868a034-5ec1-44ba-8ad7-6dfde186221d')]",
        "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
        "kind": "Scheduled",
        "apiVersion": "2021-03-01-preview",
        "properties": {
            "displayName": "(Preview) SAP - Informational - Lifecycle - SAP Notes were implemented in system",
            "description": "Identifies SAP Notes implementation in the system.\n\nSource Action: Implement SAP Note using SNOTE/TCI.\n\n*Data Sources: SAPcon -  Change Requests*",
            "severity": "Informational",
            "enabled": true,
            "query": "// Define variables\r\nlet VarNote = \"NOTE\";\r\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user\r\n// Query logic\r\nlet LastLogin = \r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditLogIn)\r\n| summarize TimeGenerated = arg_max(TimeGenerated, *) by SystemID_s, ClientID_s, User_s; // Get last connection date for user\r\nABAPCRLog_CL \r\n| where ObjectType_s == VarNote // Type is NOTE\r\n| lookup kind=inner LastLogin on $left.Owner_s == $right.User_s // Get last login details\r\n| summarize by TimeGenerated, Instance_s, SystemID_s, SystemNumber_s, ClientID_s, Owner_s, Request_s, Description_s, ObjectName_s, Category, Status_s, Email_s, TerminalIPv6_s, Host_s",
            "queryFrequency": "PT1H",
            "queryPeriod": "PT1H",
            "triggerOperator": "GreaterThan",
            "triggerThreshold": 0,
            "suppressionDuration": "PT1H",
            "suppressionEnabled": false,
            "tactics": [],
            "alertRuleTemplateName": null,
            "incidentConfiguration": {
                "createIncident": true,
                "groupingConfiguration": {
                    "enabled": false,
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5M",
                    "matchingMethod": "AllEntities",
                    "groupByEntities": [],
                    "groupByAlertDetails": [],
                    "groupByCustomDetails": []
                }
            },
            "eventGroupingSettings": {
                "aggregationKind": "SingleAlert"
            },
            "alertDetailsOverride": null,
            "customDetails": {
                "SAP_Client": "ClientID_s",
                "SAP_System_I_D": "SystemID_s",
                "SAP_User": "Owner_s",
                "SAP_Instance": "Instance_s"
            },
            "entityMappings": [
                {
                    "entityType": "Account",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Email_s"
                        }
                    ]
                },
                {
                    "entityType": "IP",
                    "fieldMappings": [
                        {
                            "identifier": "Address",
                            "columnName": "TerminalIPv6_s"
                        }
                    ]
                },
                {
                    "entityType": "Host",
                    "fieldMappings": [
                        {
                            "identifier": "FullName",
                            "columnName": "Host_s"
                        }
                    ]
                }
            ]
        }
    }
]