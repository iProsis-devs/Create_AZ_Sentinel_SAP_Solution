[
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - Medium - Security Audit Log Configuration Change",
        "Description": "Idenitifes changes for configuration in Securiy Audit Log\n\nSource Action: change any  Security Audit Log Configuration using SM19/RSAU_CONFIG. (Filters/Status/Recording mode etc..)\n\n*Data Sources: SAPcon -  Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057268895)/",
        "Query": "// Audit Log Classes - Audit Log Configuration Events\r\nlet AuditClasses = dynamic(['AUE','AUF','AUI','AUJ','FU0','E05']); // Relevant messages\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| project \r\n// Details\r\nTimeGenerated, SystemID_s, User_s, MessageText_s,\r\nAccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s",
        "QueryFrequency": {
            "Ticks": 216000000000,
            "Days": 0,
            "Hours": 6,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.25,
            "TotalHours": 6,
            "TotalMilliseconds": 21600000,
            "TotalMinutes": 360,
            "TotalSeconds": 21600
        },
        "QueryPeriod": {
            "Ticks": 216000000000,
            "Days": 0,
            "Hours": 6,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.25,
            "TotalHours": 6,
            "TotalMilliseconds": 21600000,
            "TotalMinutes": 360,
            "TotalSeconds": 21600
        },
        "Severity": "Medium",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "Persistence",
            "Exfiltration",
            "DefenseEvasion"
        ],
        "Name": "20c0dc12-e228-4caf-bbac-1ce5f9ab54da",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"100057ba-0000-0d00-0000-60dc67f50000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - High - Deactivation of Security Audit Log",
        "Description": "Identifies deactivation of Security Audit Log\n\nSource Action: Disable secruity Audit Log using SM19/RSAU_CONFIG.\n\n*Data Sources: SAPcon -  Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057271984)/",
        "Query": "// Audit Log Classes - Audit Log Active Status Events\r\nlet AuditClasses = dynamic(['AUJ']);\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| where Variable1_s == '0' // Audit Active Status = 0\r\n| project \r\n// Details\r\nTimeGenerated, SystemID_s, User_s, MessageText_s, AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s",
        "QueryFrequency": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "QueryPeriod": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "Severity": "High",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "Exfiltration",
            "DefenseEvasion",
            "Persistence"
        ],
        "Name": "0b85a077-8ba5-4cb5-90f7-1e882afe10c1",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"100065ba-0000-0d00-0000-60dc67f80000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - Medium - Transaction is unlocked",
        "Description": "Identifies unlocking of a transaction. \n\nSource Action: Unlock a transaction code using SM01/SM01_DEV/SM01_CUS.\n\n*Data Sources: SAPcon -  Audit Log*\n",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057276020)/",
        "Query": "// Audit Log Classes - Transaction UnLock Events\r\n// AUP - Transaction Locked\r\nlet AuditClasses = dynamic(['AUQ']); // AUQ - Transaction Unlocked\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| project-rename TransactionCode = Variable1_s\r\n| parse TransactionCode with \"( TR ) \" _TCODE \" - \" ClientTR // Parse to _TCODE and ClientTR\r\n// Specific Client Action (SM01_CUS) / Cross Client (SM01_DEV)\r\n| extend TransactionCode = iif(_TCODE != \"\",_TCODE, TransactionCode) // Check if _TCODE is not empty\r\n| extend ClientTR = iif(ClientTR != \"\",ClientTR, \"CrossClient\") // Check if ClientTR is not empty\r\n| project \r\n// Details\r\nTimeGenerated, SystemID_s, User_s, MessageText_s,TransactionCode, ClientTR,\r\nAccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s\r\n\r\n",
        "QueryFrequency": {
            "Ticks": 864000000000,
            "Days": 1,
            "Hours": 0,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 1,
            "TotalHours": 24,
            "TotalMilliseconds": 86400000,
            "TotalMinutes": 1440,
            "TotalSeconds": 86400
        },
        "QueryPeriod": {
            "Ticks": 864000000000,
            "Days": 1,
            "Hours": 0,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 1,
            "TotalHours": 24,
            "TotalMilliseconds": 86400000,
            "TotalMinutes": 1440,
            "TotalSeconds": 86400
        },
        "Severity": "Medium",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "Persistence",
            "Execution"
        ],
        "Name": "d9cbe2ba-7fe4-47b7-8e07-3903fb296951",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"100076ba-0000-0d00-0000-60dc67fc0000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - Medium - Assignment of a sensitive profile",
        "Description": "Identifies new assignments of a sensitive profile to a user.\n\nSource Action: Assign a profile to a User using SU01.\n\nSensitive profiles should be maintained in watchlist \"SAP - Sensitive Profiles\"\n\n*Data Sources: SAPcon -  Change Documents Log*\n",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057279018)/",
        "Query": "// Define Variables\r\n// Audit Log Classes - Authorizations for user changed\r\nlet Identity = 'IDENTITY';\r\nlet ProfileChangeDoc = 'SUSR_UST04';\r\nlet Insert = \"I\";\r\nlet logsThreshold = 10; // 10 seconds\r\nlet AuditClasses = dynamic(['AUB']); // Authorizations for user &A changed.\r\n// Maintain these if WatchList is not available\r\nlet SensitiveProfiles =  _GetWatchlist('SAP - Sensitive Profiles');\r\nlet fixedProfile = datatable(Profile:string)['SAP_ALL','SAP_NEW'];\r\n// Maintain these if System doesn't have CR's\r\nlet fixedChangeDocs = datatable(User_s : string, ObjectClass_s : string, TableName_s : string, TypeofChange_Item_s : string , ChangedTableKey_s : string, ObjectID_s : string, TimeGenerated : datetime, ValueNew_s : string, SystemID_s : string)[];\r\nlet ChangeDocs = \r\nunion isfuzzy=true table(\"ABAPChangeDocsLog_CL\"), fixedChangeDocs;\r\nlet IdentityChangeDocuments =\r\n// Identity Change documents which represents profiles assignment\r\n    ChangeDocs  \r\n    | where ObjectClass_s == Identity // Identity\r\n    and TableName_s == ProfileChangeDoc // Profile Change Doc\r\n    and TypeofChange_Item_s == Insert // Insert \r\n    | extend Profile = ChangedTableKey_s\r\n    | extend UserAssigned = ObjectID_s;\r\nlet UnitedProfiles =\r\ntoscalar(union fixedProfile, SensitiveProfiles\r\n| summarize Profiles = make_list(Profile));\r\n// Query logic\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| summarize by TimeGenerated, TerminalIPv6_s, User_s, Host_s, Email_s\r\n| lookup kind = leftouter (IdentityChangeDocuments) on User_s\r\n| where Profile in (UnitedProfiles)\r\n| project-rename  TimeGenAudit = TimeGenerated1    \r\n| where abs(datetime_diff('second',TimeGenerated,TimeGenAudit)) <= logsThreshold\r\nor isnull(TimeGenAudit)\r\n| project \r\n// Details\r\nTimeGenerated, SystemID_s, ClientID_s, Profile, User_s,  UserAssigned,\r\nAccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s",
        "QueryFrequency": {
            "Ticks": 432000000000,
            "Days": 0,
            "Hours": 12,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.5,
            "TotalHours": 12,
            "TotalMilliseconds": 43200000,
            "TotalMinutes": 720,
            "TotalSeconds": 43200
        },
        "QueryPeriod": {
            "Ticks": 432000000000,
            "Days": 0,
            "Hours": 12,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.5,
            "TotalHours": 12,
            "TotalMilliseconds": 43200000,
            "TotalMinutes": 720,
            "TotalSeconds": 43200
        },
        "Severity": "Medium",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "PrivilegeEscalation"
        ],
        "Name": "ab207396-7e9b-4075-8402-68e4275659f2",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"10008eba-0000-0d00-0000-60dc67ff0000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - High - Sensitive privileged user logged in",
        "Description": "Identifies Dialog logon of a sensitive privileged user. \n\nSource Action: Logon to the backend system using SAP* or anoter privileged user.\n\nPriveleged users should be maintained in \"SAP - Privileged Users\" Watchlist\n\n*Data Sources: SAPcon -  Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057281749)/",
        "Query": "// Define Variables\r\n// Audit Log Classes - Dialog Logon Successful\r\nlet AuditClassesSuccess = dynamic(['AU1']);\r\nlet AuditClassesFail = dynamic(['BU1']);\r\nlet AuditRFCSuccess = dynamic(['AU5']);\r\nlet AuditRFCFail = dynamic(['AU6']);\r\nlet LogonTypes = dynamic(['A','H', 'R', 'S']); // Dialog / HTTP\r\n// Get Relevant User from WatchList\r\nlet PrivelegedUsers = _GetWatchlist('SAP - Privileged Users');\r\nlet fixedUsers = datatable(User:string)\r\n// Maintain these if WatchList is not available    \r\n    [\"SAP*\",\"DDIC\"]\r\n;\r\nlet UnitedPrivileged = union PrivelegedUsers, fixedUsers\r\n| summarize by User;\r\n// Query logic\r\nABAPAuditLog_CL \r\n| where (MessageID_s in (AuditClassesSuccess) and Variable1_s in (LogonTypes)) or // Success login\r\nMessageID_s in (AuditClassesFail) or // Failed login\r\n(MessageID_s in (AuditRFCSuccess) and Variable1_s in (LogonTypes)) or // Success RFC login\r\nMessageID_s in (AuditRFCFail) // Failed RFC login\r\n| where User_s in (UnitedPrivileged)\r\n| project-rename LogonType = Variable1_s\r\n| project TimeGenerated, SystemID_s, ClientID_s, LogonType, User_s, MessageText_s, \r\nAccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s\r\n",
        "QueryFrequency": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "QueryPeriod": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "Severity": "High",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "InitialAccess",
            "CredentialAccess"
        ],
        "Name": "38a4fbde-c84d-4497-968a-159d07b6df9c",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"1000bcba-0000-0d00-0000-60dc68030000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - Medium - Assignment of a sensitive role",
        "Description": "Identifies new assignments for a sensitive role to a user.\n\nSource Action: Assign a role to a User using SU01 / PFCG.\n\nSensitive roles should be maintained in watchlist \"SAP -  Sensitive Roles\"\n\n*Data Sources: SAPcon -  Change Documents Log, Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057285776)/",
        "Query": "// Define Variables\r\nlet Roles = 'PFCG';\r\nlet UsersRoles = 'AGR_USERS';\r\nlet Insert = \"I\";\r\nlet logsThreshold = 10; // 10 seconds\r\n// Audit Log Classes - Authorizations for user changed\r\nlet AuditClasses = dynamic(['AUB', 'AUD']); // Authorizations for user &A changed.\r\n// Maintain these if WatchList is not available\r\nlet SensitiveRoles =  _GetWatchlist('SAP - Sensitive Roles');\r\nlet fixedRoles = datatable(Role: string)['SAP_BC_BASIS_ADMIN', 'SAP_BC_AUTH_PROFILE_ADMIN'];\r\n// Maintain these if System doesn't have CR's\r\nlet fixedChangeDocs = datatable(User_s : string, ObjectClass_s : string, TableName_s : string, TypeofChange_Item_s : string ,\r\nChangedTableKey_s : string, ObjectID_s : string, TimeGenerated : datetime, ValueNew_s : string, SystemID_s : string)[];\r\nlet ChangeDocs = \r\nunion isfuzzy=true table(\"ABAPChangeDocsLog_CL\"), fixedChangeDocs;\r\nlet ChangeCheck =\r\nChangeDocs  \r\n| where ObjectClass_s == Roles // Roles\r\n    and TableName_s == UsersRoles // Users Roles\r\n    and TypeofChange_Item_s == Insert // Insert \r\n| extend UserAssigned = extract(@\"^.{1,33}\\s*?(.{1,12})\\s*?\\d{16}\", 1, ChangedTableKey_s)\r\n| extend Role = ObjectID_s;\r\nlet UnitedRoles =\r\ntoscalar(union fixedRoles, SensitiveRoles\r\n| summarize Roles = make_list(Role));\r\n// Query logic\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| summarize by TimeGenerated, TerminalIPv6_s, User_s, Host_s, Email_s\r\n| lookup kind = leftouter (ChangeCheck) on User_s\r\n| where Role in (UnitedRoles)\r\n| project-rename TimeGenAudit = TimeGenerated1\r\n| where abs(datetime_diff('second', TimeGenerated, TimeGenAudit)) <= logsThreshold\r\nor isnull(TimeGenAudit)\r\n| project \r\n    // Details\r\n    TimeGenerated, SystemID_s, ClientID_s, Role, User_s, UserAssigned,\r\n    AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s",
        "QueryFrequency": {
            "Ticks": 432000000000,
            "Days": 0,
            "Hours": 12,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.5,
            "TotalHours": 12,
            "TotalMilliseconds": 43200000,
            "TotalMinutes": 720,
            "TotalSeconds": 43200
        },
        "QueryPeriod": {
            "Ticks": 432000000000,
            "Days": 0,
            "Hours": 12,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.5,
            "TotalHours": 12,
            "TotalMilliseconds": 43200000,
            "TotalMinutes": 720,
            "TotalSeconds": 43200
        },
        "Severity": "Medium",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "PrivilegeEscalation"
        ],
        "Name": "c7df7fa6-306b-46bd-b850-69421c8158a7",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"1000fdba-0000-0d00-0000-60dc68070000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - High - Execution of a Sensitive ABAP Program",
        "Description": "Identifies direct execution of a sensitive ABAP program. \n\nSource Action: Execute a program directly using SE38/SA38/SE80.\n\n**Recommended for Production only**\n\nABAP Programs should be maintained in watchlist \"SAP - Sensitive ABAP Programs\"\n\n*Data Sources: SAPcon -  Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057290136)/",
        "Query": "// Define Variables\r\nlet Role = \"Production\";\r\nlet AuditClasses = dynamic(['AUW']); // Audit Log Classes - Report Started\r\nlet allSystemRoles = dynamic(['Sandbox','Developement','QualityAssurance','Training','Production']); // Available System Roles\r\nlet allSystemUsage = dynamic (['ERP','CRM','BW','Solman','Gateway','Enterprise Portal']); // Available System Usages\r\n// Get Relevant Systems from WatchList\r\nlet systemID = _GetWatchlist('SAP - Systems');\r\nlet fixedSID = datatable(SystemID:string, SystemRole:string, SystemUsage:string)\r\n// Maintain these if WatchList is not available    \r\n    [\"S4H\",\"Production\",\"ERP\",\r\n    \"XXX\",\"Sandbox\",\"BW\"]\r\n; \r\n// Get Relevant ABAP Programs\r\nlet SensitiveABAPReports = _GetWatchlist('SAP - Sensitive ABAP Programs');\r\nlet fixedABAPReports = datatable(ABAPProgram:string)\r\n// Maintain these if WatchList is not available    \r\n    [\"RSPFLDOC\"]\r\n; \r\nlet UnionAbap = \r\n    union SensitiveABAPReports, fixedABAPReports\r\n    | summarize by ABAPProgram;\r\nlet UnitedSystem =\r\nunion systemID, fixedSID\r\n| summarize by SystemID, SystemRole, SystemUsage\r\n| where SystemRole == Role; // Reccommended is Production only\r\n//| where SystemRole in (allSystemRoles); // Use this for all system roles\r\n// Query logic\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| where ABAPProgramName_s in (UnionAbap)\r\n| project-rename SystemID = SystemID_s\r\n| lookup kind = inner (UnitedSystem) on SystemID\r\n| order by TimeGenerated asc\r\n| project TimeGenerated, SystemID, ClientID_s, User_s, ABAPProgramName_s, MessageText_s, TransactionCode_s, MessageID_s, AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s",
        "QueryFrequency": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "QueryPeriod": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "Severity": "High",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "Exfiltration",
            "LateralMovement",
            "Execution"
        ],
        "Name": "dc40a634-49ef-4df3-a860-fa791937be79",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"100041bb-0000-0d00-0000-60dc680a0000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - High - Execution of a Sensitive Transaction Code",
        "Description": "Identifies execution of a sensitive Transaction Code.\n\nSource Action: Execute a sensitive Transaction Code.\n\n**Recommended for Production only**\n\nTransaction Codes should be maintained in watchlist \"\"SAP - Sensitive Transaction Codes\"\"\n\n*Data Sources: SAPcon -  Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057293573)/",
        "Query": "// Define Variables\r\nlet Role = 'Production';\r\nlet AuditClasses = dynamic(['AU3']); // Audit Log Classes - Transaction Started\r\nlet allSystemRoles = dynamic(['Sandbox','Developement','QualityAssurance','Training','Production']); // Available System Roles\r\nlet allSystemUsage = dynamic (['ERP','CRM','BW','Solman','Gateway','Enterprise Portal']); // Available System Usages\r\n// Get Relevant Systems from WatchList\r\nlet systemID = _GetWatchlist('SAP - Systems');\r\nlet fixedSID = datatable(SystemID:string, SystemRole:string, SystemUsage:string)\r\n// Maintain these if WatchList is not available    \r\n    [\"S4H\",\"Production\",\"ERP\",\r\n    \"XXX\",\"Sandbox\",\"BW\"]\r\n; \r\n// Get Relevant Transaction Codes\r\nlet SensitiveTcode = _GetWatchlist('SAP - Sensitive Transactions');\r\nlet fixedTcode = datatable(TransactionCode:string)\r\n// Maintain these if WatchList is not available    \r\n    [\"RSAU_CONFIG\",\"RZ11\",\"SM19\"]\r\n; \r\nlet UnitedCodes = \r\n    union SensitiveTcode, fixedTcode\r\n    | summarize by TransactionCode;\r\nlet UnitedSystem =\r\nunion systemID, fixedSID\r\n| summarize by SystemID, SystemRole, SystemUsage\r\n| where SystemRole == Role; // Recommended  is Production only\r\n//| where SystemRole in (allSystemRoles); // Use this for all system roles\r\n// Query logic\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| where TransactionCode_s in (UnitedCodes)\r\n| project-rename SystemID = SystemID_s\r\n| lookup kind = inner (UnitedSystem) on SystemID\r\n| order by TimeGenerated asc\r\n| project TimeGenerated, SystemID, ClientID_s, User_s, TransactionCode_s, MessageText_s, MessageID_s, AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s",
        "QueryFrequency": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "QueryPeriod": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "Severity": "High",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "Discovery",
            "Execution"
        ],
        "Name": "1fb2a21f-14e5-4e3d-9180-ad9ef6854924",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"10006dbb-0000-0d00-0000-60dc680e0000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - Low - Sensitive Tables Direct Access By Dialog Logon",
        "Description": "Identifies generic table access by dialog logon\n\nSource Action: Open table contents using SE11/SE16/SE16N.\n\n**Recommended for Production only**\n\nTables should be maintained in \"\"SAP - Sensitive Tables\"\" Watchlist.\n\n*Data Sources: SAPcon -  Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057297819)/",
        "Query": "// Define variables\r\nlet Role = \"Production\";\r\nlet AuditClasses = dynamic(['DU9']); // Dialog, Audit Log Classes - Generic Table Access \r\nlet allSystemRoles = dynamic(['Sandbox','Developement','QualityAssurance','Training','Production']); // Available System Roles\r\nlet allSystemUsage = dynamic (['ERP','CRM','BW','Solman','Gateway','Enterprise Portal']); // Available System Usages\r\n// Get Relevant Systems from WatchList\r\nlet systemID = _GetWatchlist('SAP - Systems');\r\nlet fixedSID = datatable(SystemID:string, SystemRole:string, SystemUsage:string)\r\n// Maintain these if WatchList is not available    \r\n    [\"S4H\",\"Production\",\"ERP\",\r\n    \"XXX\",\"Sandbox\",\"BW\"]\r\n; \r\n// Get Relevant Tables\r\nlet SensitiveTables = _GetWatchlist('SAP - Sensitive Tables');\r\nlet fixedTables = datatable(Table:string)\r\n// Maintain these if WatchList is not available    \r\n    [\"USR02\"]\r\n; \r\nlet RelSystemID = union systemID, fixedSID // Create a variable that stores relevant Systems\r\n| where SystemRole == Role // Recommended  is Production only\r\n//| where SystemRole in (allSystemRoles); // Use this for all system roles\r\n| summarize by SystemID;\r\nlet SensitiveUnionTables = union SensitiveTables, fixedTables // Create a variable that stores relevant sensitive tables\r\n    | summarize by Table;\r\n// Query logic\r\nABAPAuditLog_CL \r\n    | project-rename Table = Variable1_s, Activity = Variable2_s\r\n    | where MessageID_s in (AuditClasses)\r\n    | where SystemID_s in (RelSystemID)\r\n    | where Table in (SensitiveUnionTables)\r\n    | order by TimeGenerated asc\r\n    | project TimeGenerated, SystemID_s, ClientID_s, User_s, TransactionCode_s, ABAPProgramName_s, Table,   Activity, MessageText_s, MessageID_s,\r\nAccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s",
        "QueryFrequency": {
            "Ticks": 432000000000,
            "Days": 0,
            "Hours": 12,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.5,
            "TotalHours": 12,
            "TotalMilliseconds": 43200000,
            "TotalMinutes": 720,
            "TotalSeconds": 43200
        },
        "QueryPeriod": {
            "Ticks": 432000000000,
            "Days": 0,
            "Hours": 12,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.5,
            "TotalHours": 12,
            "TotalMilliseconds": 43200000,
            "TotalMinutes": 720,
            "TotalSeconds": 43200
        },
        "Severity": "Low",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "Discovery"
        ],
        "Name": "34179973-7a7a-42c9-88d0-7f12c82cbd29",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"10009fbb-0000-0d00-0000-60dc68120000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - Medium - Multiple Logons by User",
        "Description": "Identifies logon of the same user from several terminals within scheduled time interval.\n\nSource Action: Logon using the same user thorugh different IP's.\n\n*Data Sources: SAPcon -  Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057301833)/",
        "Query": "// Define variables\r\n// Audit Log Classes - Dialog Logon Successful, RFC Logon Successful\r\nlet AuditClasses = dynamic(['AU1','AU5']);\r\n// Dialog / CPIC / RFC Int / RFC Ext / SRFC / User Switch / HTTP / Restore Session / API Call\r\nlet DialogLogonTypes = dynamic(['A', 'C', 'F', 'R', 'S', 'U', 'H', 'u', ' ']);\r\nlet excUsers = _GetWatchlist('SAP - Excluded Users'); // Users that should be removed from query\r\nlet fixedExcUsers = datatable(User:string)\r\n// Maintain these if WatchList is not available    \r\n    [\"SYSWF\"]\r\n; \r\nlet UnitedExcUsers =\r\ntoscalar(union excUsers, fixedExcUsers\r\n| summarize Users = make_set(User));\r\nlet IPThreshold = 1;\r\n// Query Logic\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| where Variable1_s in (DialogLogonTypes)\r\n| where User_s !in (UnitedExcUsers)\r\n| summarize CountIP = dcount(TerminalIPv6_s), IPs = make_set(TerminalIPv6_s), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by SystemID_s, ClientID_s, User_s, Email_s\r\n| where CountIP > IPThreshold // Count of IP logins from the user is higher than threshold\r\n| mv-expand IPs to typeof(string ) // Show for each IP\r\n| project SystemID_s, ClientID_s, User_s, StartTime, EndTime,\r\n    AccountCustomEntity = Email_s, IPCustomEntity = IPs",
        "QueryFrequency": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "QueryPeriod": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "Severity": "Medium",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "PreAttack",
            "CredentialAccess",
            "InitialAccess",
            "Collection"
        ],
        "Name": "b89e8260-1e81-4edb-b8dd-5011d92e4d50",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"1000c3bb-0000-0d00-0000-60dc68160000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - Medium - Multiple Logons by IP",
        "Description": "Identifies logon of several users from same IP within scheduled time interval.\n\nSource Action: Logon using several users thorugh the same IP.\n\n*Data Sources: SAPcon -  Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057305426)/",
        "Query": "// Define variables\r\nlet AuditClasses = dynamic(['AU1', 'AU5']); // Audit Log Classes - Dialog Logon Successful, RFC Logon Successful\r\nlet DialogLogonTypes = dynamic(['A', 'C', 'F', 'R', 'S', 'U', 'H', 'u', ' ']); // Dialog / CPIC / RFC Int / RFC Ext / SRFC / User Switch / HTTP / Restore Session / API Call\r\nlet excNetworks = _GetWatchlist('SAP - Excluded Networks'); // Networks that should be removed from query\r\nlet fixedNetworks =\r\ndatatable(Network:string)\r\n// Maintain these if WatchList is not available    \r\n    [\"111.68.128.0/1\", \"123.68.128.0/1\", \"\"]\r\n; \r\nlet UnitedNetworks =\r\ntoscalar(union excNetworks, fixedNetworks\r\n| summarize Networks = make_set(Network));\r\nlet UsersperIP = 1;\r\n// Query logic\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| where Variable1_s in (DialogLogonTypes)\r\n| where TerminalIPv6_s !in (UnitedNetworks)\r\n| extend UserandEmail = pack(\"ID\", User_s, \"Email\", Email_s)\r\n| summarize CountUsers = dcount(strcat(User_s, \"_&_\", Email_s)), Users = make_set(UserandEmail), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) \r\n    by SystemID_s, ClientID_s, TerminalIPv6_s\r\n| where CountUsers > UsersperIP\r\n| mv-expand Users \r\n| evaluate bag_unpack(Users, \"User_\")\r\n| project SystemID_s, ClientID_s, IPCustomEntity = TerminalIPv6_s, StartTime, EndTime,\r\n    column_ifexists(\"User_ID\", \"\"),    \r\n    AccountCustomEntity = column_ifexists(\"User_Email\", \"\")\r\n",
        "QueryFrequency": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "QueryPeriod": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "Severity": "Medium",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "InitialAccess"
        ],
        "Name": "fa36840a-afb3-413c-a18f-b5f49fdb9264",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"1000e7bb-0000-0d00-0000-60dc681a0000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - High - Login from unexpected network",
        "Description": "Identifies logons from an unexpected network.\n\nSource Action: Logon to the backend system from an IP address which is not assigned to one of the netwroks.\n\nNetworks should be maintained in watchlist \"SAP - Networks\"\n\n*Data Sources: SAPcon -  Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057308677)/",
        "Query": "let AuditClasses = dynamic(['AU1','AU5']); // Audit Log Classes - Dialog Logon Successful, RFC Logon Successful\r\n// Dialog / CPIC / RFC Int / RFC Ext / SRFC / User Switch / HTTP / Restore Session / API Call\r\nlet DialogLogonTypes = dynamic(['A', 'C', 'F', 'R', 'S', 'U', 'H', 'u', ' ']);\r\nlet Networks = _GetWatchlist('SAP - Networks'); \r\nlet fixedNetworks = datatable(Network: string)['111.68.128.0/17']; // Maintain these if watchlist is not available\r\nlet allNetworks = union Networks, fixedNetworks\r\n    | summarize by Network;\r\nABAPAuditLog_CL\r\n// Add audit classes\r\n| where MessageID_s in (AuditClasses)\r\n| where Variable1_s in (DialogLogonTypes) // Is a dialog logon type from the list\r\n| where isnotempty(TerminalIPv6_s) // There is a Ipv6 address\r\n| evaluate ipv4_lookup(allNetworks, TerminalIPv6_s, Network, return_unmatched = true)\r\n// Similar to regular lookup, by ipv4 address, unmatched is like left join\r\n| where isempty(Network) // Network is not familiar\r\n// Details\r\n| project TimeGenerated, SystemID_s, ClientID_s, User_s, TransactionCode_s, MessageText_s, AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s",
        "QueryFrequency": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "QueryPeriod": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "Severity": "High",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "InitialAccess"
        ],
        "Name": "6cd58183-51a9-4585-9929-e5380f8c38ad",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"1000fcbb-0000-0d00-0000-60dc681d0000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - High - RFC Execution of a Sensitive Function Module",
        "Description": "Identifies execution of a sensitive function module using RFC.\n\nSource Action: Execute a function module using RFC.\n\n**Recommended for Production only**\n\nFunction Modules should be maintained in watchlist \"SAP - Sensitive Function Modules\"\n\n*Data Sources: SAPcon -  Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057311444)/",
        "Query": "let Role = \"Production\";\r\nlet AuditClasses = dynamic(['AUK']); // Audit Log Classes - Successful RFC call &C (function group = &A)\r\nlet allSystemRoles = dynamic(['Sandbox', 'Developement', 'QualityAssurance', 'Training', 'Production']); // Available System Roles\r\nlet allSystemUsage = dynamic (['ERP', 'CRM', 'BW', 'Solman', 'Gateway', 'Enterprise Portal']); // Available System Usages\r\n// Get Relevant Systems from WatchList\r\nlet systemID = _GetWatchlist('SAP - Systems');\r\nlet fixedSID = datatable(SystemID: string, SystemRole: string, SystemUsage: string)\r\n    // Maintain these if WatchList is not available    \r\n    [\"S4H\", \"Production\", \"ERP\",\r\n    \"XXX\", \"Sandbox\", \"BW\"]\r\n; \r\n// Get Relevant Function Modules\r\nlet SensitiveFM = _GetWatchlist('SAP - Sensitive Function Modules');\r\nlet fixedFM = datatable(FunctionModule: string)\r\n    // Maintain these if WatchList is not available    \r\n    [\"RSAU_CLEAR_AUDIT_LOG\"]\r\n; \r\nlet UnitedSystems = union systemID, fixedSID\r\n| where SystemRole == Role // Recommended  is Production only\r\n| summarize by SystemID;\r\n//| where SystemRole in (allSystemRoles); // Use this for all system roles\r\nlet UnitedSensitive =  union SensitiveFM, fixedFM\r\n| summarize by FunctionModule;\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| project-rename FunctionModule = Variable3_s, FunctionGroup = Variable1_s\r\n| where SystemID_s in (UnitedSystems) // The systemID is in this list\r\n| where FunctionModule in (UnitedSensitive) // Function module is sensitive\r\n| order by TimeGenerated asc\r\n| project TimeGenerated, User_s, SystemID_s, ClientID_s, MessageText_s, FunctionGroup, FunctionModule, MessageID_s,\r\n    AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s",
        "QueryFrequency": {
            "Ticks": 72000000000,
            "Days": 0,
            "Hours": 2,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.08333333333333333,
            "TotalHours": 2,
            "TotalMilliseconds": 7200000,
            "TotalMinutes": 120,
            "TotalSeconds": 7200
        },
        "QueryPeriod": {
            "Ticks": 72000000000,
            "Days": 0,
            "Hours": 2,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.08333333333333333,
            "TotalHours": 2,
            "TotalMilliseconds": 7200000,
            "TotalMinutes": 120,
            "TotalSeconds": 7200
        },
        "Severity": "High",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "Execution",
            "LateralMovement",
            "Discovery"
        ],
        "Name": "5eba5b1a-b105-470d-b80b-0aafd440bf32",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"10001abc-0000-0d00-0000-60dc68200000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - High - Function Module tested",
        "Description": "Identifies testing of a function module.\n\nSource Action: Test a function module using  SE37 / SE80.\n\n**Recommended for Production only**\n\n*Data Sources: SAPcon -  Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057314952)/",
        "Query": "let Role = 'Production';\r\nlet ProgramName = 'RS_TESTFRAME_CALL';\r\nlet AuditClasses = dynamic(['AUW']); // Audit Log Classes - Report Started\r\nlet allSystemRoles = dynamic(['Sandbox', 'Developement', 'QualityAssurance', 'Training', 'Production']); // Available System Roles\r\nlet allSystemUsage = dynamic (['ERP', 'CRM', 'BW', 'Solman', 'Gateway', 'Enterprise Portal']); // Available System Usages\r\n// Get Relevant Systems from WatchList\r\nlet systemID = _GetWatchlist('SAP - Systems');\r\nlet fixedSID = datatable(SystemID: string, SystemRole: string, SystemUsage: string)\r\n    // Maintain these if WatchList is not available    \r\n    [\"S4H\", \"Production\", \"ERP\",\r\n    \"XXX\", \"Sandbox\", \"BW\"]\r\n; \r\nlet UnitedSystem = \r\nunion systemID, fixedSID\r\n| summarize by SystemID, SystemRole, SystemUsage\r\n| where SystemRole == Role; // Reccommended is Production only\r\n//| where SystemRole in (allSystemRoles); // Use this for all system roles\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| where ABAPProgramName_s == ProgramName\r\n| project-rename SystemID = SystemID_s\r\n| lookup kind = inner (UnitedSystem) on SystemID\r\n| order by TimeGenerated asc\r\n| project TimeGenerated, User_s, SystemID, ClientID_s, MessageText_s, MessageID_s,\r\n    AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s ",
        "QueryFrequency": {
            "Ticks": 216000000000,
            "Days": 0,
            "Hours": 6,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.25,
            "TotalHours": 6,
            "TotalMilliseconds": 21600000,
            "TotalMinutes": 360,
            "TotalSeconds": 21600
        },
        "QueryPeriod": {
            "Ticks": 216000000000,
            "Days": 0,
            "Hours": 6,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.25,
            "TotalHours": 6,
            "TotalMilliseconds": 21600000,
            "TotalMinutes": 360,
            "TotalSeconds": 21600
        },
        "Severity": "High",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "Collection",
            "DefenseEvasion",
            "LateralMovement"
        ],
        "Name": "520713e4-a72e-4cfd-9b12-ca5049a71df4",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"10002dbc-0000-0d00-0000-60dc68250000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - High - Change in Sensitive privileged user",
        "Description": "Identifies changes  of sensitive privileged users. \n\nSource Action: Change user details / authorizations using SU01.\n\nPriveleged users should be maintained in \"SAP - Privileged Users\" Watchlist\n\n*Data Sources: SAPcon -  Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057319593)/",
        "Query": "// Audit Log Classes - User Master Changes\r\nlet AuditClasses = dynamic(['AU7', 'BUV', 'BUW', 'AU8', 'AU9', 'AUA', 'AUB', 'AUD', 'DUH', 'BU2']);\r\n// Get Relevant User from WatchList\r\nlet PrivelegedUsers = _GetWatchlist('SAP - Privileged Users');\r\nlet fixedUsers = datatable(User: string)\r\n    // Maintain these if WatchList is not available    \r\n    [\"SAP*\", \"DDIC\"]\r\n;\r\nlet UnitedPrivleged = union PrivelegedUsers, fixedUsers\r\n| summarize by User;\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| where Variable1_s in (UnitedPrivleged) // The user that we are making change in is a sensitive privileged user\r\n| project TimeGenerated, SystemID_s, ClientID_s, User_s, MessageText_s, MessageID_s,\r\n    AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s\r\n",
        "QueryFrequency": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "QueryPeriod": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "Severity": "High",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "PrivilegeEscalation",
            "CredentialAccess"
        ],
        "Name": "0a7f972b-55b9-492c-8fe4-ac04a8dc3aec",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"10006bbc-0000-0d00-0000-60dc68270000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - Medium - Brute force attacks",
        "Description": "Identifies brute force attacks on SAP system according to failed logon attempts for the backend system.\n\nSource Action: Attempt to login from the same IP to several systems/clients within the scheduled time interval.\n\n*Data Sources: SAPcon -  Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057322497)/",
        "Query": "// Define variables\r\n// Audit Log Classes - Failed Logons / Password Check\r\nlet AuditClasses = dynamic(['AUO', 'AU2', 'AU6', 'BU1']);\r\nlet perIPLimit = 6;\r\n// Query logic\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| extend DetailsBy = pack(\"User\", User_s, \"Email\", Email_s, \"SystemID\", SystemID_s, \"ClientID\", ClientID_s)\r\n| summarize LoginbyIPAttempts = count(), Details = make_set(DetailsBy), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) \r\n    by TerminalIPv6_s\r\n// Check if number of login attempts per IP is higher than limit\r\n| where LoginbyIPAttempts > perIPLimit \r\n| mv-expand Details\r\n| evaluate bag_unpack(Details, \"Details_\")\r\n| project \r\n    StartTime, EndTime, IPCustomEntity = TerminalIPv6_s,\r\n    AccountCustomEntity = column_ifexists(\"Details_Email\", \"\"), column_ifexists(\"Details_User\", \"\"),\r\n    column_ifexists(\"Details_SystemID\", \"\"),\r\n    column_ifexists(\"Details_ClientID\", \"\")",
        "QueryFrequency": {
            "Ticks": 216000000000,
            "Days": 0,
            "Hours": 6,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.25,
            "TotalHours": 6,
            "TotalMilliseconds": 21600000,
            "TotalMinutes": 360,
            "TotalSeconds": 21600
        },
        "QueryPeriod": {
            "Ticks": 216000000000,
            "Days": 0,
            "Hours": 6,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.25,
            "TotalHours": 6,
            "TotalMilliseconds": 21600000,
            "TotalMinutes": 360,
            "TotalSeconds": 21600
        },
        "Severity": "Medium",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "CredentialAccess"
        ],
        "Name": "e9b38331-0b37-4428-988d-b5c07fa617f0",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"10008bbc-0000-0d00-0000-60dc682a0000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - Low - Multiple Password Changes by User",
        "Description": "Identifies multiple password changes by user.\n\nSource Action: Change user password\n\n*Data Sources: SAPcon -  Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057325118)/",
        "Query": "// Define variables\r\nlet systemsPerUser = 3; // Systems Clients per User\r\nlet AuditClasses = dynamic(['BU2']); // Audit Log Classes - Password Changed\r\n// Query logic\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| project-rename UserReset = Variable2_s\r\n| extend DetailsBy = pack(\"SystemID\", SystemID_s, \"ClientID\", ClientID_s)\r\n| summarize CountSysClient = dcount(strcat(SystemID_s, ClientID_s)), Details = make_set(DetailsBy), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) \r\n    by UserReset, User_s, Email_s, TerminalIPv6_s\r\n| where CountSysClient > systemsPerUser // Number of passwords changed by user\r\n| mv-expand Details\r\n| evaluate bag_unpack(Details, \"Details_\") // Unpack the details to a couple of fields\r\n| project \r\n    StartTime, EndTime, UserReset, User_s, AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s,\r\n    column_ifexists(\"Details_SystemID\", \"\"),\r\n    column_ifexists(\"Details_ClientID\", \"\")",
        "QueryFrequency": {
            "Ticks": 108000000000,
            "Days": 0,
            "Hours": 3,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.125,
            "TotalHours": 3,
            "TotalMilliseconds": 10800000,
            "TotalMinutes": 180,
            "TotalSeconds": 10800
        },
        "QueryPeriod": {
            "Ticks": 108000000000,
            "Days": 0,
            "Hours": 3,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.125,
            "TotalHours": 3,
            "TotalMilliseconds": 10800000,
            "TotalMinutes": 180,
            "TotalSeconds": 10800
        },
        "Severity": "Low",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "CredentialAccess"
        ],
        "Name": "9e159c93-4c1f-4b40-9a78-8a562fde7dbc",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"100096bc-0000-0d00-0000-60dc682d0000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - High - HANA DB - Assign Admin Authorizations",
        "Description": "Identifies admin privileges/roles assignment.\n\nSource Action: Assign a user with any Admin role / privileges.\n\n*Data Sources: Linux Agent - Syslog*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057327827)/",
        "Query": "Syslog \r\n| where ProcessName startswith \"HDB\"\r\n| where SyslogMessage contains \"ADMIN\" and (SyslogMessage contains \"GRANT PRIVILEGE\" or SyslogMessage contains \"GRANT ROLE\")",
        "QueryFrequency": {
            "Ticks": 108000000000,
            "Days": 0,
            "Hours": 3,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.125,
            "TotalHours": 3,
            "TotalMilliseconds": 10800000,
            "TotalMinutes": 180,
            "TotalSeconds": 10800
        },
        "QueryPeriod": {
            "Ticks": 108000000000,
            "Days": 0,
            "Hours": 3,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.125,
            "TotalHours": 3,
            "TotalMilliseconds": 10800000,
            "TotalMinutes": 180,
            "TotalSeconds": 10800
        },
        "Severity": "High",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "PrivilegeEscalation"
        ],
        "Name": "03c0f7bf-45d5-4102-a1bb-d47d14338ba2",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"1000a2bc-0000-0d00-0000-60dc68300000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - High - HANA DB - User Admin actions",
        "Description": "Identifies user administration actions.\n\nSouirce Action: Create/Update/Delete a DB User.\n\n*Data Sources: Linux Agent - Syslog*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057330336)/",
        "Query": "Syslog \r\n| where ProcessName startswith \"HDB\"\r\n| where SyslogMessage contains \"CREATE USER\" or \r\n    SyslogMessage contains 'ALTER USER' or \r\n    SyslogMessage contains 'DROP USER' or \r\n    SyslogMessage contains 'DROP SCHEMA'",
        "QueryFrequency": {
            "Ticks": 108000000000,
            "Days": 0,
            "Hours": 3,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.125,
            "TotalHours": 3,
            "TotalMilliseconds": 10800000,
            "TotalMinutes": 180,
            "TotalSeconds": 10800
        },
        "QueryPeriod": {
            "Ticks": 108000000000,
            "Days": 0,
            "Hours": 3,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.125,
            "TotalHours": 3,
            "TotalMilliseconds": 10800000,
            "TotalMinutes": 180,
            "TotalSeconds": 10800
        },
        "Severity": "High",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "PrivilegeEscalation"
        ],
        "Name": "491fb852-b8c4-4eca-828c-af4f714557c4",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"1000b0bc-0000-0d00-0000-60dc68320000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - High - HANA DB - Audit Trail Policy Changes",
        "Description": "Identifies changes for HANA DB audit trail policies.\n\nSource Action: Create / update existing audit policy in security definitions.\n\n*Data Sources: Linux Agent - Syslog*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057333052)/",
        "Query": "Syslog \r\n| where ProcessName startswith \"HDB\"\r\n| where SyslogMessage contains \"AUDIT POLICY\" ",
        "QueryFrequency": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "QueryPeriod": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "Severity": "High",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "LateralMovement",
            "DefenseEvasion",
            "Persistence"
        ],
        "Name": "15959eb6-7350-42bc-acd2-d2aace805da1",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"1000b4bc-0000-0d00-0000-60dc68350000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - High - HANA DB - Deactivation of Audit Trail",
        "Description": "Identifies deactivation of HANA DB audit log.\n\nSource Action: Deactivate Audit Log in HANA DB security defnitions.\n\n*Data Sources: Linux Agent - Syslog*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057335793)/",
        "Query": "Syslog \r\n| where ProcessName startswith \"HDB\"\r\n| where SyslogMessage contains \"AUDIT CONFIGURATION\" and \r\n    SyslogMessage contains 'global_auditing_state' and \r\n    SyslogMessage contains 'False'",
        "QueryFrequency": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "QueryPeriod": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "Severity": "High",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "Persistence",
            "LateralMovement",
            "DefenseEvasion"
        ],
        "Name": "5b160a76-3cbf-4fad-a510-d0a095e08c16",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"1000c3bc-0000-0d00-0000-60dc68370000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - Medium - Debugging Activities",
        "Description": "Identifies all debugging related activities.\n\nSource Action: Activate Debug (\"/h\") in system, debug an active process, add breakpoint to source code etc.\n\n**Recommended for Production only**\n\n*Data Sources: SAPcon -  Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057338224)/",
        "Query": "let Role = 'Production';\r\nlet DebuggerProgram = 'RSTPDAMAIN';\r\nlet AuditClasses = dynamic(['CUK','CUL','CUM','CUN','CUO','CUP']); // Audit Log Classes - Debug Activities\r\nlet allSystemRoles = dynamic(['Sandbox','Developement','QualityAssurance','Training','Production']); // Available System Roles\r\nlet allSystemUsage = dynamic (['ERP','CRM','BW','Solman','Gateway','Enterprise Portal']); // Available System Usages\r\n// Get Relevant Systems from WatchList\r\nlet systemID = _GetWatchlist('SAP - Systems')\r\n| where SystemRole == Role; // Reccommended is Production only\r\nlet fixedSID = datatable(SystemID:string, SystemRole:string, SystemUsage:string)\r\n// Maintain these if WatchList is not available    \r\n    [\"S4H\",\"Production\",\"ERP\",\r\n    \"XXX\",\"Sandbox\",\"BW\"]\r\n    | where SystemRole == Role // Reccommended is Production only\r\n; \r\nlet SystemUnited = union systemID, fixedSID\r\n| summarize by SystemID, SystemRole, SystemUsage;\r\n//| where SystemRole in (allSystemRoles); // Use this for all system roles\r\nABAPAuditLog_CL \r\n    | where MessageID_s in (AuditClasses) or ABAPProgramName_s == DebuggerProgram // Get logs by messege ID or program name\r\n    | extend Object = extract(@\":\\s\\(?(\\w{1,}\\s?-?\\w{1,})\", 1, MessageText_s, typeof(string)) // Extract Object\r\n    | extend Action = extract(@\":\\s\\(?(\\w{1,}\\s?-?\\w{1,}.{1,}?)\\)?\\(\", 1, MessageText_s, typeof(string)) // Extract Action\r\n    | extend Program = extract(@\"Prgm:(\\w{1,})\", 1, MessageText_s, typeof(string)) // Extract Program\r\n    | extend Function = extract(@\"Funct:(\\w{1,})\", 1, MessageText_s, typeof(string)) // Extract Function\r\n    | extend Include = extract(@\"Incl:(\\w{1,})\", 1, MessageText_s, typeof(string)) // Extract Include\r\n    | extend Line = extract(@\"Line:(\\w{1,})\", 1, MessageText_s, typeof(string)) // Extract Line\r\n    | project-rename SystemID = SystemID_s\r\n    | lookup kind=inner (SystemUnited) on SystemID\r\n    | order by TimeGenerated asc\r\n    | project TimeGenerated, User_s, MessageText_s, ABAPProgramName_s, TransactionCode_s, SystemID, SystemRole, SystemUsage,MessageID_s, AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s, Object , Action, Program, Function, Include, Line",
        "QueryFrequency": {
            "Ticks": 108000000000,
            "Days": 0,
            "Hours": 3,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.125,
            "TotalHours": 3,
            "TotalMilliseconds": 10800000,
            "TotalMinutes": 180,
            "TotalSeconds": 10800
        },
        "QueryPeriod": {
            "Ticks": 108000000000,
            "Days": 0,
            "Hours": 3,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.125,
            "TotalHours": 3,
            "TotalMilliseconds": 10800000,
            "TotalMinutes": 180,
            "TotalSeconds": 10800
        },
        "Severity": "Medium",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "Discovery"
        ],
        "Name": "1afd36e2-379e-4002-8642-41a3e0a161ee",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"10000fbe-0000-0d00-0000-60dc68550000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - High - Data has Changed during Debugging Activity",
        "Description": "Identifies changes for runtime data during a debugging activity.\nSource Action: Activate Debug (\"/h\"), Select a field for change and update it's value.\n\n**Recommended for Production only**\n\n*Data Sources: SAPcon -  Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057368295)/",
        "Query": "let Role = 'Production';\r\nlet AuditClasses = dynamic(['CUL']); // Audit Log Classes - Debug Change\r\nlet allSystemRoles = dynamic(['Sandbox','Developement','QualityAssurance','Training','Production']); // Available System Roles\r\nlet allSystemUsage = dynamic (['ERP','CRM','BW','Solman','Gateway','Enterprise Portal']); // Available System Usages\r\n// Get Relevant Systems from WatchList\r\nlet systemID = _GetWatchlist('SAP - Systems');\r\nlet fixedSID = datatable(SystemID:string, SystemRole:string, SystemUsage:string)\r\n// Maintain these if WatchList is not available    \r\n    [\"S4H\",\"Production\",\"ERP\",\r\n    \"XXX\",\"Sandbox\",\"BW\"]\r\n;\r\nlet UnitedSystem = \r\nunion systemID, fixedSID\r\n| summarize by SystemID, SystemRole, SystemUsage\r\n| where SystemRole == Role; // Recommended  is Production only\r\n//| where SystemRole in (allSystemRoles); // Use this for all system roles\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| project-rename SystemID = SystemID_s\r\n| lookup kind = inner (UnitedSystem) on SystemID\r\n| project TimeGenerated, User_s, MessageText_s, ABAPProgramName_s, TransactionCode_s, SystemID, SystemRole, SystemUsage,\r\nAccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s\r\n",
        "QueryFrequency": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "QueryPeriod": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "Severity": "High",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "Execution",
            "LateralMovement"
        ],
        "Name": "907f4978-7b8d-4d1b-a2d6-3bf5b06438b8",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"100028be-0000-0d00-0000-60dc68580000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - High - System Configuration Change",
        "Description": "Identifies changes for system configuration. \n\nSource Action:  Adapt system change options or software components modifcation using SE06 transaction code.\n\n*Data Sources: SAPcon -  Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057371784)/",
        "Query": "// Audit Log Classes - System Change Configuration\r\nlet AuditClasses = dynamic(['EU1']); // Relevant message\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| project \r\n// Details\r\nTimeGenerated, SystemID_s, User_s, TransactionCode_s, SoftwareComponent = Variable1_s, NewModifiabilityStatus = Variable2_s, MessageText_s,\r\nAccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s\r\n",
        "QueryFrequency": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "QueryPeriod": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "Severity": "High",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "Exfiltration",
            "DefenseEvasion",
            "Persistence"
        ],
        "Name": "1a760847-14b0-45bc-876e-2fa47bdccbd6",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"10003dbe-0000-0d00-0000-60dc685b0000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - High - Client Configuration Change",
        "Description": "Identifies changes for client configuration such as: Client role, Changes recording mode. \n\nSource Action:  Perofrm client configurations changes using SCC4 transaction code. \n\n*Data Sources: SAPcon -  Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057374620)/",
        "Query": "// Audit Log Classes - Client Change Configuration\r\nlet AuditClasses = dynamic(['EU2']); // Relevent message\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| project-rename  ClientID = Variable1_s \r\n| parse Variable2_s with Currency \"|\" ClientRole \"|\" RecordingChanges \"|\" CrossClientObjectChanges \"|\" ClientCopyProtectionLevel \"|\" ProtectionSAPUpgrade \"|\" CATTeCATT \"|\"  LockedforCopy // Parse every object before the | char \r\n| project TimeGenerated, SystemID_s, User_s, ClientID, \r\nCurrency,ClientRole,RecordingChanges,CrossClientObjectChanges,ClientCopyProtectionLevel,CATTeCATT,LockedforCopy,ProtectionSAPUpgrade,\r\nMessageText_s,\r\nAccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s\r\n",
        "QueryFrequency": {
            "Ticks": 180000000000,
            "Days": 0,
            "Hours": 5,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.20833333333333331,
            "TotalHours": 5,
            "TotalMilliseconds": 18000000,
            "TotalMinutes": 300,
            "TotalSeconds": 18000
        },
        "QueryPeriod": {
            "Ticks": 180000000000,
            "Days": 0,
            "Hours": 5,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.20833333333333331,
            "TotalHours": 5,
            "TotalMilliseconds": 18000000,
            "TotalMinutes": 300,
            "TotalSeconds": 18000
        },
        "Severity": "High",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "DefenseEvasion",
            "Exfiltration",
            "Persistence"
        ],
        "Name": "9f26d131-a227-4ad2-b4d9-b1e9cf402939",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"100064be-0000-0d00-0000-60dc685e0000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - High - Sensitive privileged user makes a change in other user",
        "Description": "Identifies changes  of sensitive privileged users in other users.\n\nSource Action: Change user details / authorizations using SU01.\n\nPriveleged users should be maintained in \"SAP - Privileged Users\" Watchlist\n\n*Data Sources: SAPcon -  Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057377555)/",
        "Query": "// Audit Log Classes - User Master Changes\r\nlet AuditClasses = dynamic(['AU7', 'BUV', 'BUW', 'AU8', 'AU9', 'AUA', 'AUB', 'AUD', 'DUH', 'BU2']);\r\n// Get Relevant User from WatchList\r\nlet PrivelegedUsers = _GetWatchlist('SAP - Privileged Users');\r\nlet fixedUsers = datatable(User: string)\r\n    // Maintain these if WatchList is not available    \r\n    [\"SAP*\", \"DDIC\"]\r\n;\r\nlet UnitedPrivleged = union PrivelegedUsers, fixedUsers\r\n| summarize by User;\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| where User_s in (UnitedPrivleged) // The user that makes a change is a sensitive privileged user\r\n| project TimeGenerated, SystemID_s, ClientID_s, User_s, MessageText_s, MessageID_s,\r\n    AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s\r\n",
        "QueryFrequency": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "QueryPeriod": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "Severity": "High",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "PrivilegeEscalation",
            "CredentialAccess"
        ],
        "Name": "d766e2b9-c836-423f-9fe7-d63c2ae135dc",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"100074be-0000-0d00-0000-60dc68620000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - Medium - Critical authorizations assignment - New User Assignment",
        "Description": "Identifies assignment of a critical authorization object value to a new user.\n\nSource Action: Assign a new user to a role which holds critical authorization values using SU01/PFCG.\n\nCritical authorization objects should be maintained in watchlist \"\"SAP - Critical Authorization Objects\"\"\n\n*Data Sources: SAPcon -  Change Documents Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057380735)/",
        "Query": "// New Assigned Users\r\nlet ObjectClassRoles = 'PFCG';\r\nlet TableName = 'CD1251';\r\nlet UsersRoles = 'AGR_USERS';\r\nlet Insert = \"I\";\r\nlet NotInUse = 'NOT_IN_USE';\r\nlet logsThreshold = 3; // 3 seconds\r\n// Audit Log Classes - Authorizations for user changed\r\nlet AuditClasses = dynamic(['AUB','AUD']); // Authorizations for user &A changed. User Master Record Changed\r\n// Roles Change Documents - Extract Auth Object and Obj Field\r\nlet allHistory = ago(0d);\r\nlet alertSched = ago(6h); // Please maintain according to schedule\r\n// Maintain these if System doesn't have CR's\r\nlet fixedChangeDocs = datatable(User_s : string, ObjectClass_s : string, TableName_s : string, TypeofChange_Item_s : string , ChangedTableKey_s : string, ObjectID_s : string, TimeGenerated : datetime, ValueNew_s : string, SystemID_s : string)[];\r\nlet ChangeDocs = \r\nunion isfuzzy=true table(\"ABAPChangeDocsLog_CL\"), fixedChangeDocs;\r\nlet RolesAuthObject = ChangeDocs  \r\n    | where TimeGenerated <= allHistory\r\n    | where ObjectClass_s == ObjectClassRoles and TableName_s == TableName // Role-Obj-Profile-ObjField\r\n    | where TypeofChange_Item_s in ('J', 'I', 'U') //  Insert\r\n    | extend RoleObjProfileObjFieldVer = ChangedTableKey_s, Role = ObjectID_s\r\n    | extend ObjFieldValue = ValueNew_s    \r\n    | extend ObjField = trim(@\"\\s*?\", extract(@\"(^.{1,30})\\s*?(.{1,10})\\s*?(.{1,12})\\s*?(.{1,10})\\s*?\\d{6}\", 4, RoleObjProfileObjFieldVer, typeof(string)))\r\n    | extend AuthObject = trim(@\"\\s*?\", extract(@\"(^.{1,30})\\s*?(.{1,10})\\s*?(.{1,12})\\s*?(.{1,10})\\s*?\\d{6}\", 2, RoleObjProfileObjFieldVer, typeof(string)))\r\n    | summarize by SystemID_s, Role, AuthObject, ObjField, ObjFieldValue;\r\nlet ComplexAuth = _GetWatchlist('SAP - Critical Authorizations');\r\nlet SimpleAuth = _GetWatchlist('SAP - Critical Authorizations');\r\nlet fixedComplexAuth = datatable(AuthorizationObject: string, AuthorizationField: string, AuthorizationValue: string, ActivityField: string, Activity: string)\r\n    ['S_DEVELOP', 'OBJTYPE', 'DEBUG', 'ACTVT', '*',\r\n    'S_DEVELOP', 'OBJTYPE', 'DEBUG', 'ACTVT', '02']; // Maintain these if WatchList is not available\r\nlet fixedSimpleAuth = datatable(AuthorizationObject: string, AuthorizationField: string, AuthorizationValue: string, ActivityField: string, Activity: string)\r\n    ['S_TCODE', 'TCD', '*', 'NOT_IN_USE', '',\r\n    'S_TZONE', 'ACTVT', '*', 'NOT_IN_USE', '']; // Maintain these if WatchList is not available\r\nlet usersinRole = \r\n    ChangeDocs  \r\n    | where TimeGenerated >= alertSched\r\n    | where ObjectClass_s == ObjectClassRoles // Roles\r\n        and TableName_s == UsersRoles // Users Roles\r\n        and TypeofChange_Item_s == Insert // Insert \r\n    | extend UserAssigned = extract(@\"^.{1,33}\\s*?(.{1,12})\\s*?\\d{16}\", 1, ChangedTableKey_s)\r\n    | extend Role = ObjectID_s\r\n    | extend TimeGenUserinRole = TimeGenerated;\r\n    //| summarize by TimeGenerated, SystemID_s, ClientID_s, Role, UserAssigned, User_s\r\nlet RolesAuthObjectCheck =     \r\n        RolesAuthObject     \r\n        | extend ObjFieldVal = ObjFieldValue\r\n        | lookup kind = leftouter \r\n            (RolesAuthObject \r\n            | extend ActivityVal = ObjFieldValue)\r\n            on Role, AuthObject;\r\nlet complexScenario = \r\n    union ComplexAuth, fixedComplexAuth\r\n    | where ActivityField != NotInUse\r\n    | summarize by AuthorizationObject, AuthorizationField, AuthorizationValue, ActivityField, Activity\r\n    | lookup kind = inner (RolesAuthObjectCheck)\r\n        on $left.AuthorizationObject == $right.AuthObject \r\n        and $left.AuthorizationField == $right.ObjField \r\n        and $left.AuthorizationValue == $right.ObjFieldValue\r\n        and $left.ActivityField == $right.ObjField1\r\n        and $left.Activity == $right.ActivityVal;\r\nlet simpleScenario = \r\n    union SimpleAuth, fixedSimpleAuth\r\n    | where ActivityField == NotInUse\r\n    | summarize by AuthorizationObject, AuthorizationField, AuthorizationValue, ActivityField, Activity \r\n    | lookup kind = inner (RolesAuthObject)\r\n        on $left.AuthorizationObject == $right.AuthObject \r\n        and $left.AuthorizationField == $right.ObjField \r\n        and $left.AuthorizationValue == $right.ObjFieldValue;\r\nlet GetEntites =     \r\n    ABAPAuditLog_CL \r\n    | where TimeGenerated >= alertSched\r\n    | where MessageID_s in (AuditClasses)\r\n    | summarize by TimeGenerated, TerminalIPv6_s, ClientID_s, User_s, Host_s, Email_s\r\n    | extend TimeGenAudit = TimeGenerated;  \r\nunion complexScenario, simpleScenario\r\n| lookup kind = inner (usersinRole) on SystemID_s, Role\r\n| lookup kind = leftouter (GetEntites) on User_s\r\n| where abs(datetime_diff('second', TimeGenUserinRole, TimeGenAudit)) <= logsThreshold or\r\nisnull(TimeGenAudit)\r\n| project \r\n    // Details\r\nTimeGenUserinRole, SystemID_s, ClientID_s, Role, User_s, UserAssigned, AuthorizationObject, AuthorizationField, AuthorizationValue, ActivityField, Activity,\r\nAccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s",
        "QueryFrequency": {
            "Ticks": 216000000000,
            "Days": 0,
            "Hours": 6,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.25,
            "TotalHours": 6,
            "TotalMilliseconds": 21600000,
            "TotalMinutes": 360,
            "TotalSeconds": 21600
        },
        "QueryPeriod": {
            "Ticks": 216000000000,
            "Days": 0,
            "Hours": 6,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.25,
            "TotalHours": 6,
            "TotalMilliseconds": 21600000,
            "TotalMinutes": 360,
            "TotalSeconds": 21600
        },
        "Severity": "Medium",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "PrivilegeEscalation"
        ],
        "Name": "a75221fb-0a3c-4754-8202-cd11785116d1",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"10008dbe-0000-0d00-0000-60dc68650000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - Medium - Critical authorizations assignment - New Authorization Value",
        "Description": "Identifies assignment of a critical authorization object value to a new user.\n\nSource Action: Assign a new authorization object / update existing one in a role using PFCG.\n\nCritical authorization objects should be maintained in watchlist \"\"SAP - Critical Authorization Objects\"\"\n\n*Data Sources: SAPcon -  Change Documents Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057383506)/",
        "Query": "// New Assigned Objects\r\nlet ObjectClassRoles = 'PFCG';\r\nlet TableName = 'CD1251';\r\nlet UsersRoles = 'AGR_USERS';\r\nlet Insert = \"I\";\r\nlet NotInUse = 'NOT_IN_USE';\r\nlet logsThreshold = 3; // 3 seconds\r\n// Audit Log Classes - Authorizations for user changed\r\nlet AuditClasses = dynamic(['AUR','AUT']); // Authorization/Authorization Profile &B created / changed.\r\n// Roles Change Documents - Extract Auth Object and Obj Field\r\nlet allHistory = ago(0d);\r\nlet alertSched = ago(6h); // Please maintain according to schedule\r\n// Maintain these if System doesn't have CR's\r\nlet fixedChangeDocs = datatable(User_s : string, ObjectClass_s : string, TableName_s : string, TypeofChange_Item_s : string , ChangedTableKey_s : string, ObjectID_s : string, TimeGenerated : datetime, ValueNew_s : string, SystemID_s : string)[];\r\nlet ChangeDocs = \r\nunion isfuzzy=true table(\"ABAPChangeDocsLog_CL\"), fixedChangeDocs;\r\nlet RolesAuthObject = ChangeDocs  \r\n    | where TimeGenerated >= alertSched\r\n    | where ObjectClass_s == ObjectClassRoles and TableName_s == TableName // Role-Obj-Profile-ObjField\r\n    | where TypeofChange_Item_s in ('J', 'I', 'U') //  Insert\r\n    | extend RoleObjProfileObjFieldVer = ChangedTableKey_s, Role = ObjectID_s\r\n    | extend ObjFieldValue = ValueNew_s    \r\n    | extend ObjField = trim(@\"\\s*?\", extract(@\"(^.{1,30})\\s*?(.{1,10})\\s*?(.{1,12})\\s*?(.{1,10})\\s*?\\d{6}\", 4, RoleObjProfileObjFieldVer, typeof(string)))\r\n    | extend AuthObject = trim(@\"\\s*?\", extract(@\"(^.{1,30})\\s*?(.{1,10})\\s*?(.{1,12})\\s*?(.{1,10})\\s*?\\d{6}\", 2, RoleObjProfileObjFieldVer, typeof(string)))\r\n    | extend TimeGenRoleAuth = TimeGenerated;\r\nlet ComplexAuth = _GetWatchlist('SAP - Critical Authorizations');\r\nlet SimpleAuth = _GetWatchlist('SAP - Critical Authorizations');\r\nlet fixedComplexAuth = datatable(AuthorizationObject: string, AuthorizationField: string, AuthorizationValue: string, ActivityField: string, Activity: string)\r\n    ['S_DEVELOP', 'OBJTYPE', 'DEBUG', 'ACTVT', '*',\r\n    'S_DEVELOP', 'OBJTYPE', 'DEBUG', 'ACTVT', '02']; // Maintain these if WatchList is not available\r\nlet fixedSimpleAuth = datatable(AuthorizationObject: string, AuthorizationField: string, AuthorizationValue: string, ActivityField: string, Activity: string)\r\n    ['S_TCODE', 'TCD', '*', 'NOT_IN_USE', '',\r\n    'S_TZONE', 'ACTVT', '*', 'NOT_IN_USE', '']; // Maintain these if WatchList is not available\r\nlet usersinRole = \r\n    ChangeDocs  \r\n    | where TimeGenerated <= allHistory\r\n    | where ObjectClass_s == ObjectClassRoles // Roles\r\n        and TableName_s == UsersRoles // Users Roles\r\n        and TypeofChange_Item_s == Insert // Insert \r\n    | extend UserAssigned = extract(@\"^.{1,33}\\s*?(.{1,12})\\s*?\\d{16}\", 1, ChangedTableKey_s)\r\n    | extend Role = ObjectID_s\r\n    | summarize by SystemID_s, Role, UserAssigned;\r\nlet RolesAuthObjectCheck =     \r\n        RolesAuthObject     \r\n        | extend ObjFieldVal = ObjFieldValue\r\n        | lookup kind = leftouter \r\n            (RolesAuthObject \r\n            | extend ActivityVal = ObjFieldValue)\r\n            on Role, AuthObject;\r\nlet complexScenario = union ComplexAuth, fixedComplexAuth\r\n    | where ActivityField != NotInUse\r\n    | summarize by AuthorizationObject, AuthorizationField, AuthorizationValue, ActivityField, Activity\r\n    | lookup kind = inner (RolesAuthObjectCheck)\r\n        on $left.AuthorizationObject == $right.AuthObject \r\n        and $left.AuthorizationField == $right.ObjField \r\n        and $left.AuthorizationValue == $right.ObjFieldValue\r\n        and $left.ActivityField == $right.ObjField1\r\n        and $left.Activity == $right.ActivityVal;\r\nlet simpleScenario = \r\n    union SimpleAuth, fixedSimpleAuth\r\n    | where ActivityField == NotInUse\r\n    | summarize by AuthorizationObject, AuthorizationField, AuthorizationValue, ActivityField, Activity \r\n    | lookup  kind = inner (RolesAuthObject)\r\n        on $left.AuthorizationObject == $right.AuthObject \r\n        and $left.AuthorizationField == $right.ObjField \r\n        and $left.AuthorizationValue == $right.ObjFieldValue;\r\nlet GetEntities =\r\n    ABAPAuditLog_CL \r\n    | where MessageID_s in (AuditClasses)\r\n    | summarize by TimeGenerated, ClientID_s, TerminalIPv6_s, User_s, Host_s, Email_s\r\n    | extend TimeGenAudit = TimeGenerated;\r\nunion complexScenario, simpleScenario\r\n| lookup kind = inner (usersinRole) on SystemID_s, Role\r\n| lookup kind = leftouter (GetEntities) on User_s\r\n| where abs(datetime_diff('second', TimeGenRoleAuth, TimeGenAudit)) <= logsThreshold or\r\nisnull(TimeGenAudit)\r\n| project \r\n    // Details\r\nTimeGenRoleAuth, SystemID_s, ClientID_s, Role, User_s, UserAssigned, AuthorizationObject, AuthorizationField, AuthorizationValue, ActivityField, Activity,AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s",
        "QueryFrequency": {
            "Ticks": 216000000000,
            "Days": 0,
            "Hours": 6,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.25,
            "TotalHours": 6,
            "TotalMilliseconds": 21600000,
            "TotalMinutes": 360,
            "TotalSeconds": 21600
        },
        "QueryPeriod": {
            "Ticks": 216000000000,
            "Days": 0,
            "Hours": 6,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.25,
            "TotalHours": 6,
            "TotalMilliseconds": 21600000,
            "TotalMinutes": 360,
            "TotalSeconds": 21600
        },
        "Severity": "Medium",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "PrivilegeEscalation"
        ],
        "Name": "013468cd-89ec-4074-b1d7-71d00655274d",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"1000a9be-0000-0d00-0000-60dc68680000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - Medium - Multiple Files Download",
        "Description": "Identifies multiple files downloads for a user within a specific timerange.\n\nSource Action: Download multiple files while using SAPGui to Excel/Lists etc.\n\n*Data Sources: SAPcon -  Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057386384)/",
        "Query": "// Define variables\r\nlet NumberOfDownloads = 10; // Number of downloads of user as threshold\r\nlet HoursBucket = 2h; // How much time between buckets\r\nlet AuditClasses = dynamic([\"AUY\"]); // Relevant message\r\n// Query logic\r\nABAPAuditLog_CL // Get all downloads\r\n| where MessageID_s in (AuditClasses)\r\n| summarize DownloadsByUser = count() by bin(TimeGenerated, HoursBucket), SystemID_s, ClientID_s, User_s, TerminalIPv6_s, Email_s, Host_s\r\n| where DownloadsByUser >= NumberOfDownloads // User downloaded more than threshold\r\n| project SystemID_s, ClientID_s, User_s, AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s,DownloadsByUser",
        "QueryFrequency": {
            "Ticks": 432000000000,
            "Days": 0,
            "Hours": 12,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.5,
            "TotalHours": 12,
            "TotalMilliseconds": 43200000,
            "TotalMinutes": 720,
            "TotalSeconds": 43200
        },
        "QueryPeriod": {
            "Ticks": 432000000000,
            "Days": 0,
            "Hours": 12,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.5,
            "TotalHours": 12,
            "TotalMilliseconds": 43200000,
            "TotalMinutes": 720,
            "TotalSeconds": 43200
        },
        "Severity": "Medium",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "Collection",
            "Exfiltration",
            "CredentialAccess"
        ],
        "Name": "208a4a87-75b5-4e67-bc0a-41f3f3a8bcb2",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"1000d4be-0000-0d00-0000-60dc686a0000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - Medium - Multiple Spool Executions",
        "Description": "Identifies multiple spools for a user within a specific timerange.\n\nSource Action: Create and execute multiple Spool Jobs from any type by a user. (SP01)\n\n*Data Sources: SAPcon -  Spool Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057389010)/",
        "Query": "// Define variables\r\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user\r\nlet NumberOfRequests = 3; // Number of requests as threshold\r\nlet HoursBucket = 2h; // // How much time between buckets\r\n// Query logic\r\nlet LastLogin = \r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditLogIn)\r\n| summarize TimeGenerated = arg_max(TimeGenerated, *) by SystemID_s, ClientID_s, User_s; // Get last connection date for user\r\nABAPSpoolLog_CL // Get all spool requests\r\n| summarize UserRequests = count() by bin(TimeGenerated, HoursBucket), SystemID_s, ClientID_s, User_s\r\n| where UserRequests >= NumberOfRequests // User requested to print more than threshold\r\n| lookup kind=inner LastLogin on User_s // Check IP of last login\r\n| project TimeGenerated, SystemID_s, ClientID_s, User_s, AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s, UserRequests",
        "QueryFrequency": {
            "Ticks": 432000000000,
            "Days": 0,
            "Hours": 12,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.5,
            "TotalHours": 12,
            "TotalMilliseconds": 43200000,
            "TotalMinutes": 720,
            "TotalSeconds": 43200
        },
        "QueryPeriod": {
            "Ticks": 432000000000,
            "Days": 0,
            "Hours": 12,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.5,
            "TotalHours": 12,
            "TotalMilliseconds": 43200000,
            "TotalMinutes": 720,
            "TotalSeconds": 43200
        },
        "Severity": "Medium",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "CredentialAccess",
            "Collection",
            "Exfiltration"
        ],
        "Name": "7b450b18-4279-461c-9193-e8d95a76cdd0",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"1000f0be-0000-0d00-0000-60dc686d0000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - Medium - Multiple Spool Output Executions",
        "Description": "Identifies multiple spools for a user within a specific timerange.\n\nSource Action: Create and execute multiple Spool Jobs from any type by a user. (SP01)\n\n*Data Sources: SAPcon -  Spool Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057391533)/",
        "Query": "// Define variables\r\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messeges of connect with user\r\nlet NumberOfPrints = 3; // Number of prints as threshold\r\nlet HoursBucket = 2h; // // How much time between buckets\r\n// Query logic\r\nlet LastLogin =\r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditLogIn)\r\n| summarize arg_max(TimeGenerated, *) by SystemID_s, ClientID_s, User_s; // Get last connection date for user\r\nABAPSpoolOutputLog_CL // Get all spool outputs\r\n| summarize UserPrints = count() by bin(TimeGenerated, HoursBucket), SystemID_s, ClientID_s, User_s\r\n| where UserPrints >= NumberOfPrints // User requested to print more than threshold\r\n| lookup kind=inner LastLogin on User_s // Get IP of last login\r\n| project TimeGenerated, SystemID_s, ClientID_s, User_s, AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s, UserPrints",
        "QueryFrequency": {
            "Ticks": 432000000000,
            "Days": 0,
            "Hours": 12,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.5,
            "TotalHours": 12,
            "TotalMilliseconds": 43200000,
            "TotalMinutes": 720,
            "TotalSeconds": 43200
        },
        "QueryPeriod": {
            "Ticks": 432000000000,
            "Days": 0,
            "Hours": 12,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.5,
            "TotalHours": 12,
            "TotalMilliseconds": 43200000,
            "TotalMinutes": 720,
            "TotalSeconds": 43200
        },
        "Severity": "Medium",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "CredentialAccess",
            "Collection",
            "Exfiltration"
        ],
        "Name": "e4e6a5ff-d25c-46b6-a3c9-b82212f741e3",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"100004bf-0000-0d00-0000-60dc686f0000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - Medium - Spool Takeover",
        "Description": "Identifies a user printing a spool request which was created by someone else.\n\nSource Action: Create a Spool Request using one user, Output it in using another user.\n\n*Data Sources: SAPcon -  Spool Log*\n*Data Sources: SAPcon -  Spool Output Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057394587)/",
        "Query": "// Define variables\r\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user\r\n// Query logic\r\nlet LastLogin = \r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditLogIn)\r\n| summarize TimeGenerated = arg_max(TimeGenerated, *) by SystemID_s, ClientID_s, User_s; // Get last connection date for user\r\n// Query Logic\r\nABAPSpoolOutputLog_CL // Get all spool outputs\r\n| lookup kind=inner ABAPSpoolLog_CL on SpoolRequestNumber_d\r\n| lookup kind=inner LastLogin on User_s\r\n| where User_s != User_s1 // The user that created the request is not the one that printed it\r\n| project TimeGenerated, SystemID_s, ClientID_s, UserCreated = User_s1, UserPrinted = User_s, SpoolRequestNumber_d, AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s",
        "QueryFrequency": {
            "Ticks": 432000000000,
            "Days": 0,
            "Hours": 12,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.5,
            "TotalHours": 12,
            "TotalMilliseconds": 43200000,
            "TotalMinutes": 720,
            "TotalSeconds": 43200
        },
        "QueryPeriod": {
            "Ticks": 432000000000,
            "Days": 0,
            "Hours": 12,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.5,
            "TotalHours": 12,
            "TotalMilliseconds": 43200000,
            "TotalMinutes": 720,
            "TotalSeconds": 43200
        },
        "Severity": "Medium",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "Collection",
            "Exfiltration",
            "CommandAndControl"
        ],
        "Name": "06d1cd5b-0b5e-4043-9f11-bc6f62267fbd",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"100038bf-0000-0d00-0000-60dc68730000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - High - User Creates and uses new user",
        "Description": "Identifies a user creating and using other users.\n\nSource Action: Create a user using SU01. Login using the newly created user from the same IP.\n\n*Data Sources: SAPcon -  Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057397859)/",
        "Query": "// Define Variables\r\nlet MinutesThreshold = 15; // Difference by minutes between Create and Connect\r\nlet AuditUserCreated = dynamic(['AU7']); // Message of create user\r\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user\r\n// Query Logic\r\nlet UserCreated = // Get users created\r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditUserCreated)\r\n| project-rename UserCreationTimeGenerated = TimeGenerated, UserCreated = Variable1_s;\r\nABAPAuditLog_CL // Get users connections\r\n| where MessageID_s in (AuditLogIn)\r\n| lookup kind=inner UserCreated on TerminalIPv6_s,$left.User_s == $right.UserCreated // Lookup of user created to user log in\r\n| where abs(datetime_diff('Minute', TimeGenerated, UserCreationTimeGenerated)) <= MinutesThreshold // Connect after creation\r\n| summarize by TimeGenerated, SystemID_s, ClientID_s, UserAction = User_s1, UserCreated = User_s, AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s",
        "QueryFrequency": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "QueryPeriod": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "Severity": "High",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "Discovery",
            "PreAttack",
            "InitialAccess"
        ],
        "Name": "a49025ef-df61-48fc-8817-716c29a7d718",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"10006bbf-0000-0d00-0000-60dc68760000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - High - User Unlocks and uses other users",
        "Description": "Identifies a user unlock and usage by other users.\n\nSource Action: Unlock a user using SU01. Login using the unlocked user from the same IP.\n\n*Data Sources: SAPcon -  Audit Log*\n*Data Sources: SAPcon -  Change Documents Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057400604)/",
        "Query": "// Define variables\r\nlet MinutesThreshold = 15; // Difference by minutes between Unlock and Connect\r\nlet AuditUserUnlocked = dynamic(['AUA']); // Message of unlock user\r\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user\r\n// Query Logic\r\nlet UserUnlocked = // Get users unlocked\r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditUserUnlocked)\r\n| project-rename UserUnlockTimeGenerated = TimeGenerated, UserUnlocked = Variable1_s;\r\nABAPAuditLog_CL // Get users connections\r\n| where MessageID_s in (AuditLogIn)\r\n| lookup kind=inner UserUnlocked on TerminalIPv6_s, $left.User_s == $right.UserUnlocked // Lookup of user unlocked to user log in\r\n| where abs(datetime_diff('Minute', TimeGenerated, UserUnlockTimeGenerated)) <= MinutesThreshold // Connect after unlock\r\n| summarize by TimeGenerated, SystemID_s, ClientID_s, UserAction = User_s1, UserUnlocked = User_s, AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s",
        "QueryFrequency": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "QueryPeriod": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "Severity": "High",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "PreAttack",
            "InitialAccess",
            "Discovery",
            "LateralMovement"
        ],
        "Name": "a81fcdca-3e80-4c9d-9ea5-4a6172aaeb47",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"100083bf-0000-0d00-0000-60dc68790000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - Medium - Sensitive Tables Direct Access By RFC Logon",
        "Description": "Identifies generic table access by RFC logon\n\nSource Action: Open table contents using SE11/SE16/SE16N.\n\n**Recommended for Production only**\n\nTables should be maintained in \"SAP - Sensitive Tables\" Watchlist.\n\n*Data Sources: SAPcon -  Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057403935)/",
        "Query": "// Define variables\r\nlet Role = \"Production\";\r\nlet AuditClasses = dynamic(['CUZ']); // RFC, Audit Log Classes - Generic Table Access \r\nlet allSystemRoles = dynamic(['Sandbox','Developement','QualityAssurance','Training','Production']); // Available System Roles\r\nlet allSystemUsage = dynamic (['ERP','CRM','BW','Solman','Gateway','Enterprise Portal']); // Available System Usages\r\n// Get Relevant Systems from WatchList\r\nlet systemID = _GetWatchlist('SAP - Systems');\r\nlet fixedSID = datatable(SystemID:string, SystemRole:string, SystemUsage:string)\r\n// Maintain these if WatchList is not available    \r\n    [\"S4H\",\"Production\",\"ERP\",\r\n    \"XXX\",\"Sandbox\",\"BW\"]\r\n; \r\n// Get Relevant Tables\r\nlet SensitiveTables = _GetWatchlist('SAP - Sensitive Tables');\r\nlet fixedTables = datatable(Table:string)\r\n// Maintain these if WatchList is not available    \r\n    [\"USR02\"]\r\n; \r\nlet RelSystemID = union systemID, fixedSID // Create a variable that stores relevent Systems\r\n| where SystemRole == Role // Reccommended is Production only\r\n//| where SystemRole in (allSystemRoles); // Use this for all system roles\r\n| summarize by SystemID;\r\nlet SensitiveUnionTables = union SensitiveTables, fixedTables // Create a variable that stores relevent sensitive tables\r\n    | summarize by Table;\r\n// Query logic\r\nABAPAuditLog_CL \r\n    | project-rename Table = Variable1_s, Activity = Variable2_s\r\n    | where MessageID_s in (AuditClasses)\r\n    | where SystemID_s in (RelSystemID)\r\n    | where Table in (SensitiveUnionTables)\r\n    | order by TimeGenerated asc\r\n    | project TimeGenerated, SystemID_s, ClientID_s, User_s, TransactionCode_s, ABAPProgramName_s, Table,   Activity, MessageText_s, MessageID_s,\r\nAccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s",
        "QueryFrequency": {
            "Ticks": 432000000000,
            "Days": 0,
            "Hours": 12,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.5,
            "TotalHours": 12,
            "TotalMilliseconds": 43200000,
            "TotalMinutes": 720,
            "TotalSeconds": 43200
        },
        "QueryPeriod": {
            "Ticks": 432000000000,
            "Days": 0,
            "Hours": 12,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.5,
            "TotalHours": 12,
            "TotalMilliseconds": 43200000,
            "TotalMinutes": 720,
            "TotalSeconds": 43200
        },
        "Severity": "Medium",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "Collection",
            "Exfiltration",
            "CredentialAccess"
        ],
        "Name": "5bc6037b-c775-4d22-b6cb-bb03aeed04ad",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"1000a3bf-0000-0d00-0000-60dc687c0000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - High - Sensitive Users Password Change and Login",
        "Description": "Identifies password changes for privileged users.\n\nSource Action: Change Password for a user and login to the system.\n\nPriveleged users should be maintained in \"SAP - Privileged Users\" Watchlist\n\n*Data Sources: SAPcon -  Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057406814)/",
        "Query": "// Define variables\r\nlet ChangeAndLoginThreshold = 5; // Difference by minutes between Change in user to connect\r\nlet LoginAndRestThreshold = 3; // Difference by minutes between Connect and password reset\r\nlet AuditUserChange = dynamic(['AUD']); // Message of change in user\r\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user\r\nlet AuditUserPassReset = dynamic(['BU2']); // Message of user password change\r\nlet PrivUsers = _GetWatchlist(\"SAP - Privileged Users\");\r\nlet fixedUsers = datatable(User: string)\r\n    // Maintain these if WatchList is not available    \r\n    [\"SAP*\", \"DDIC\"]\r\n;\r\nlet UnitedPrivleged = toscalar(union PrivUsers, fixedUsers\r\n| summarize Users = make_list(User));\r\n// Query Logic\r\nlet UserChange = // Get users change activity\r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditUserChange)\r\n| where Variable1_s in (UnitedPrivleged) // The user with the changed password is privileged user\r\n| project-rename UserChangeTimeGenerated = TimeGenerated, UserPassChanged = Variable1_s;\r\nlet UserLogIn = // Get users connections\r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditLogIn)\r\n| project-rename UserLogInTimeGenerated = TimeGenerated;\r\nABAPAuditLog_CL // Get users password reset\r\n| where MessageID_s in (AuditUserPassReset)\r\n| where User_s in (UnitedPrivleged) // The user with the changed password is privileged user\r\n| lookup kind=inner UserLogIn on TerminalIPv6_s, User_s // Lookup of user reset to user login\r\n| lookup kind=inner UserChange on TerminalIPv6_s, $left.User_s == $right.UserPassChanged // Lookup of user reset to user change\r\n| where abs(datetime_diff('Minute', UserChangeTimeGenerated, UserLogInTimeGenerated)) <= ChangeAndLoginThreshold // Connect after a change in user\r\n| where abs(datetime_diff('Minute', TimeGenerated, UserLogInTimeGenerated)) <= LoginAndRestThreshold // Change password after connection\r\n| summarize by TimeGenerated, SystemID_s, ClientID_s, UserAction = User_s1, PrivUserPassChanged = User_s, AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s\r\n",
        "QueryFrequency": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "QueryPeriod": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "Severity": "High",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "Impact",
            "CommandAndControl",
            "PrivilegeEscalation"
        ],
        "Name": "ff24daf5-2b40-4e76-aea5-96c36b4a6cc9",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"1000bbbf-0000-0d00-0000-60dc687f0000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - Medium - Insecure FTP servers configuration",
        "Description": " Identifies Insecure FTP servers configuration - FTP Whitelist is empty / Contains Placeholders.\n\nSource Action: Do not maintain / maintain values which contains placeholders in table SAPFTP_SERVERS using maintenance view SAPFTP_SERVERS_V. (SM30)\n\n*Data Sources: SAPcon -  Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057409585)/",
        "Query": "// Define variables\r\nlet AuditClasses = dynamic(['DU1', 'DU2']); // Messages of FTP Whitelist is empty / Contains Placeholders\r\n// Query logic\r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditClasses)\r\n| project TimeGenerated, SystemID_s, ClientID_s, AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s, Reason = MessageText_s",
        "QueryFrequency": {
            "Ticks": 216000000000,
            "Days": 0,
            "Hours": 6,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.25,
            "TotalHours": 6,
            "TotalMilliseconds": 21600000,
            "TotalMinutes": 360,
            "TotalSeconds": 21600
        },
        "QueryPeriod": {
            "Ticks": 216000000000,
            "Days": 0,
            "Hours": 6,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.25,
            "TotalHours": 6,
            "TotalMilliseconds": 21600000,
            "TotalMinutes": 360,
            "TotalSeconds": 21600
        },
        "Severity": "Medium",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "InitialAccess",
            "CommandAndControl"
        ],
        "Name": "ff5a6a0a-aabb-49b0-b78b-51bc1cc749c6",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"1000cdbf-0000-0d00-0000-60dc68810000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - Medium - FTP for non authorized servers",
        "Description": "Identifies FTP connection for non authorized server.\nMaintain new Watchlist, similar to SAPFTP_SERVERS \nSource Action: Create a new FTP connection e.g. by using Function Module FTP_CONNECT.\n\n*Data Sources: SAPcon -  Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057412283)/",
        "Query": "// Define variables\r\nlet AuditClasses = dynamic(['DU8']); // Message of Successfull FTP Connection\r\nlet FTPSafeConnections = _GetWatchlist(\"SAP - FTP Servers\");\r\nlet fixedConnections = datatable(Client: string, Description: string,\r\nFTP_Server_Name: string, FTP_Server_Port: string)\r\n    // Maintain these if WatchList is not available    \r\n    [100, \"description\", \"http://ourorgftpserver.com/\", 22]\r\n;\r\nlet UnitedConnections = toscalar(union kind=inner FTPSafeConnections, fixedConnections | summarize Connections = make_set(FTP_Server_Name));\r\n// Query logic\r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditClasses)\r\n| where TerminalIPv6_s !in (UnitedConnections) // The IP is unknown\r\n| project TimeGenerated, SystemID_s, ClientID_s,AccountCustomEntity = Email_s,IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s",
        "QueryFrequency": {
            "Ticks": 216000000000,
            "Days": 0,
            "Hours": 6,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.25,
            "TotalHours": 6,
            "TotalMilliseconds": 21600000,
            "TotalMinutes": 360,
            "TotalSeconds": 21600
        },
        "QueryPeriod": {
            "Ticks": 216000000000,
            "Days": 0,
            "Hours": 6,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.25,
            "TotalHours": 6,
            "TotalMilliseconds": 21600000,
            "TotalMinutes": 360,
            "TotalSeconds": 21600
        },
        "Severity": "Medium",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "Discovery",
            "InitialAccess",
            "CommandAndControl"
        ],
        "Name": "a29e4080-08c4-4815-80d1-156e452931ae",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"1000f4bf-0000-0d00-0000-60dc68850000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - Low - Dynamic ABAP Program",
        "Description": "Identifies execution of dynamic ABAP programming. For example, ABAP code was dynamically created/changed/deleted. Source Action: Create an ABAP Report which uses ABAP program generation commands such as \"INSERT REPORT\" and execute it. Excluded Transaction Codes can be maintained in \"SAP - Transactions for ABAP Generations\" watchlist. *Data Sources: SAPcon - Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057415633)/",
        "Query": "// Define variables\r\nlet AuditClasses = dynamic(['BU4']); // Message of dynamic ABAP program\r\nlet TranForABAPGen = _GetWatchlist(\"SAP - Transactions for ABAP Generations\"); // Transactions to exclude\r\n// Maintain if watchlist is not available\r\nlet fixedTran = datatable(TransactionCode:string)['SE11','SE12', \"SE16\", \"SE16N\"];\r\nlet UnitedTransactions =\r\ntoscalar(union TranForABAPGen, fixedTran\r\n| summarize Transactions = make_set(TransactionCode));\r\n// Query logic\r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditClasses)\r\n| where TransactionCode_s !in (UnitedTransactions) // Exclude transactions\r\n| project TimeGenerated, SystemID_s, ClientID_s, AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s, ABAPProgramName_s",
        "QueryFrequency": {
            "Ticks": 216000000000,
            "Days": 0,
            "Hours": 6,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.25,
            "TotalHours": 6,
            "TotalMilliseconds": 21600000,
            "TotalMinutes": 360,
            "TotalSeconds": 21600
        },
        "QueryPeriod": {
            "Ticks": 216000000000,
            "Days": 0,
            "Hours": 6,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.25,
            "TotalHours": 6,
            "TotalMilliseconds": 21600000,
            "TotalMinutes": 360,
            "TotalSeconds": 21600
        },
        "Severity": "Low",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "Discovery",
            "CommandAndControl",
            "Impact"
        ],
        "Name": "a5995af7-9d04-4665-892c-81b16b9f0d03",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"100007c0-0000-0d00-0000-60dc68870000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - Low - Dynamic RFC Destination",
        "Description": "Identifies execution of RFC using dynamic destinations. Source Action: Execute an ABAP report which is using dynamic destinations (cl_dynamic_destination). Sample report: DEMO_RFC_DYNAMIC_DEST. *Data Sources: SAPcon - Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625984966924)/",
        "Query": "// Define variables\r\nlet AuditClasses = dynamic(['FU1']); // Message of dynamic RFC execution using dynamic destination\r\n// Query logic\r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditClasses)\r\n| parse Variable3_s with \"id=\" Created_RFC_Name\r\n| project TimeGenerated, SystemID_s, ClientID_s, User_s, AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s, ABAPProgramName_s, ExecutedProgram = Variable2_s, Created_RFC_Name",
        "QueryFrequency": {
            "Ticks": 216000000000,
            "Days": 0,
            "Hours": 6,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.25,
            "TotalHours": 6,
            "TotalMilliseconds": 21600000,
            "TotalMinutes": 360,
            "TotalSeconds": 21600
        },
        "QueryPeriod": {
            "Ticks": 216000000000,
            "Days": 0,
            "Hours": 6,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.25,
            "TotalHours": 6,
            "TotalMilliseconds": 21600000,
            "TotalMinutes": 360,
            "TotalSeconds": 21600
        },
        "Severity": "Low",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "Collection",
            "Exfiltration"
        ],
        "Name": "8ce3473d-5e4b-4590-a86e-7770f0de42f5",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"6b00568e-0000-0d00-0000-60ea8fc70000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - High - SPNego Attack",
        "Description": "Identifies SPNego Replay Attack.\n\n*Data Sources: SAPcon -  Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057421138)/",
        "Query": "// Define variables\r\nlet AuditClasses = dynamic(['BUI']); // Message of SPNego\r\n// Query logic\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| project TimeGenerated, SystemID_s, ClientID_s,  AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s",
        "QueryFrequency": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "QueryPeriod": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "Severity": "High",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "Impact",
            "LateralMovement"
        ],
        "Name": "da6cbab6-0928-4674-bebd-47acbb8ec309",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"10001fc0-0000-0d00-0000-60dc688d0000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - Medium - Sensitive Roles Changes",
        "Description": "Identifies changes in sensitive roles. \nSource Action: Change a role using PFCG.\nSensitive roles should be maintained in \"SAP - Sensitive Roles\" Watchlist\n\n*Data Sources: SAPcon - Change Documents Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057424012)/",
        "Query": "// Define variables\r\nlet RoleObjectClass = \"PFCG\";\r\nlet ChangeType = \"U\";\r\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user\r\nlet SensitiveRoles = _GetWatchlist(\"SAP - Sensitive Roles\");\r\n// Maintain if watchlist is not available\r\nlet fixedRoles = datatable(Role: string)['SAP_BC_BASIS_ADMIN', 'SAP_BC_AUTH_PROFILE_ADMIN'];\r\nlet UnitedRoles =\r\ntoscalar(union fixedRoles, SensitiveRoles\r\n| summarize Roles = make_list(Role));\r\n// Query logic\r\nlet LastLogin = \r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditLogIn)\r\n| summarize TimeGenerated = arg_max(TimeGenerated, *) by SystemID_s, ClientID_s, User_s; // Get last connection date for user\r\nABAPChangeDocsLog_CL\r\n| where ObjectClass_s == RoleObjectClass // Relevant role object class\r\n| where ObjectID_s in (UnitedRoles) // Role is sensitive\r\n| where TypeofChange_Item_s == ChangeType\r\n| extend AuthorizationObj = extract(@\"\\S+\\s+(\\S+)\\s+\", 1, ChangedTableKey_s, typeof(string)) // Extract Authorization Object\r\n| extend Authorization = extract(@\"\\S+\\s+\\S+\\s+(\\S+\\d+)\", 1, ChangedTableKey_s, typeof(string)) // Extract Authorization\r\n| lookup kind=inner LastLogin on User_s // Get IP\r\n| project TimeGenerated, SystemID_s, ClientID_s, AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s, Role = ObjectID_s, FieldName_s , AuthorizationObj, Authorization, OldValue = ValueOld_s, NewValue = ValueNew_s",
        "QueryFrequency": {
            "Ticks": 432000000000,
            "Days": 0,
            "Hours": 12,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.5,
            "TotalHours": 12,
            "TotalMilliseconds": 43200000,
            "TotalMinutes": 720,
            "TotalSeconds": 43200
        },
        "QueryPeriod": {
            "Ticks": 432000000000,
            "Days": 0,
            "Hours": 12,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.5,
            "TotalHours": 12,
            "TotalMilliseconds": 43200000,
            "TotalMinutes": 720,
            "TotalSeconds": 43200
        },
        "Severity": "Medium",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "Impact",
            "PrivilegeEscalation",
            "Persistence"
        ],
        "Name": "5b090f0e-1a9e-409a-9478-d9db88876420",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"100043c0-0000-0d00-0000-60dc68900000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - Medium - Execution of Obsolete/Insecure Program",
        "Description": "Identifies execution of an obsolete/insecure ABAP program.\nSource Action: Execute a program directly using SE38/SA38/SE80 or by using a background job.\n**Recommended for Production only**\nObsolete programs should be maintained in \"SAP - Obsolete Programs\" Watchlist\n*Data Sources: SAPcon -  Audit Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057427431)/",
        "Query": "// Define Variables\r\nlet AuditClasses = dynamic(['AUW']); // Audit Log Classes - Report Started\r\nlet ObsoletePrograms = _GetWatchlist(\"SAP - Obsolete Programs\");\r\n// Maintain if watchlist is not available\r\nlet fixedObPrograms = datatable(ABAPProgram:string)['RSAU_READ_LOG'];\r\nlet UnitedPrograms =\r\ntoscalar(union fixedObPrograms, ObsoletePrograms\r\n| summarize Programs = make_set(ABAPProgram));\r\n// Query logic\r\nABAPAuditLog_CL \r\n| where MessageID_s in (AuditClasses)\r\n| where ABAPProgramName_s in (UnitedPrograms) // The program is obsolete\r\n| project TimeGenerated, SystemID_s, ClientID_s, User_s, ABAPProgramName_s, MessageText_s, TransactionCode_s, MessageID_s, AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s",
        "QueryFrequency": {
            "Ticks": 72000000000,
            "Days": 0,
            "Hours": 2,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.08333333333333333,
            "TotalHours": 2,
            "TotalMilliseconds": 7200000,
            "TotalMinutes": 120,
            "TotalSeconds": 7200
        },
        "QueryPeriod": {
            "Ticks": 72000000000,
            "Days": 0,
            "Hours": 2,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.08333333333333333,
            "TotalHours": 2,
            "TotalMilliseconds": 7200000,
            "TotalMinutes": 120,
            "TotalSeconds": 7200
        },
        "Severity": "Medium",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "Discovery",
            "CommandAndControl"
        ],
        "Name": "bea62349-d449-4a26-b523-c7d3fb17fb08",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"10005ec0-0000-0d00-0000-60dc68930000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - Medium - Execution of Obsolete or Insecure Function Module",
        "Description": "Identifies execution of an obsolete/insecure ABAP Function Module.\n\nSource Action: Execute an obsolete/insecure function module directly using SE37.\n\n**Recommended for Production only**\n\nObsolete functions should be maintained in \"SAP - Obsolete Function Modules\" Watchlist.\nTable logging changes should be activated for table \"EUFUNC\" in backend. (SE13)\n\n*Data Sources: SAPcon -  Table Data Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057430435)/",
        "Query": "// Define variables\r\nlet RelTable = \"EUFUNC\"; // Relevant table\r\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user\r\nlet ObsoleteModules =  _GetWatchlist('SAP - Obsolete Function Modules');\r\n// Maintain if watchlist is not available\r\nlet fixedModules = datatable(FunctionModule:string)['TH_SAPREL','TH_SAPREL2', 'TH_SAPREL3','SUSR_RFC_USER_INTERFACE','RFC_ABAP_INSTALL_AND_RUN']; \r\nlet UnitedModules =\r\ntoscalar(union fixedModules, ObsoleteModules\r\n| summarize FunctionModules =  make_set(FunctionModule));\r\n// Query logic\r\nlet LastLogin = \r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditLogIn)\r\n| summarize TimeGenerated = arg_max(TimeGenerated, *) by SystemID_s, ClientID_s, User_s; // Get last connection date for user\r\nABAPTableDataLog_CL\r\n| where TableName_s == RelTable\r\n| extend Module = extract(@\"\\s+(.{1,}\\b)\\s+\", 1, LogKey_s, typeof(string)) // Extract Function Module\r\n| extend FunctionGroup = extract(@\"^FL([^\\s]*)\\s\", 1, LogKey_s, typeof(string)) // Extract Function Group\r\n| extend ExecutionVariant = extract(@\"\\b(\\w+)$\", 1, LogKey_s, typeof(string)) // Extract Execution Varient\r\n| where Module in (UnitedModules) // Module is obsolete\r\n| lookup kind=inner LastLogin on $left.UserName_s == $right.User_s\r\n| project TimeGenerated, SystemID_s, ClientID_s,  AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s, Module, FunctionGroup, ExecutionVariant",
        "QueryFrequency": {
            "Ticks": 72000000000,
            "Days": 0,
            "Hours": 2,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.08333333333333333,
            "TotalHours": 2,
            "TotalMilliseconds": 7200000,
            "TotalMinutes": 120,
            "TotalSeconds": 7200
        },
        "QueryPeriod": {
            "Ticks": 72000000000,
            "Days": 0,
            "Hours": 2,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.08333333333333333,
            "TotalHours": 2,
            "TotalMilliseconds": 7200000,
            "TotalMinutes": 120,
            "TotalSeconds": 7200
        },
        "Severity": "Medium",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "Discovery",
            "CommandAndControl"
        ],
        "Name": "25183b6a-5340-44a8-8830-b5b2ecd75d57",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"100072c0-0000-0d00-0000-60dc68970000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - High - Execution of Sensitive Function Module",
        "Description": "Identifies execution of a sensitive ABAP Function Module.\n\nSource Action: Execute a sensitive function module directly using SE37.\n\n**Recommended for Production only**\n\nSensitive functions should be maintained in \"SAP - Sensitive Function Modules\" Watchlist.\nTable logging changes should be activated for table \"EUFUNC\" in backend. (SE13)\n\n*Data Sources: SAPcon -  Table Data Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625122207856)/",
        "Query": "// Define variables\r\nlet RelTable = \"EUFUNC\"; // Relevant table\r\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user\r\nlet SenseModules =  _GetWatchlist('SAP - Sensitive Function Modules');\r\nlet fixedModules = datatable(FunctionModule:string)['RSAU_CLEAR_AUDIT_LOG','BAPI_USER_CREATE', 'RFC_GET_TABLE_ENTRIES']; \r\nlet UnitedModules =\r\ntoscalar(union fixedModules, SenseModules\r\n| summarize FunctionModules =  make_set(FunctionModule));\r\n// Query logic\r\nlet LastLogin = \r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditLogIn)\r\n| summarize TimeGenerated = arg_max(TimeGenerated, *) by SystemID_s, ClientID_s, User_s; // Get last connection date for user\r\nABAPTableDataLog_CL\r\n| where TableName_s == RelTable \r\n| extend Module = extract(@\"\\s+(.{1,}\\b)\\s+\", 1, LogKey_s, typeof(string)) // Extract Function Module\r\n| extend FunctionGroup = extract(@\"^FL([^\\s]*)\\s\", 1, LogKey_s, typeof(string)) // Extract Function Group\r\n| extend ExecutionVariant = extract(@\"\\b(\\w+)$\", 1, LogKey_s, typeof(string)) // Extract Execution Varient\r\n| where Module in (UnitedModules) // Module is sensitive\r\n| lookup kind=inner LastLogin on $left.UserName_s == $right.User_s\r\n| project TimeGenerated, SystemID_s, ClientID_s,  AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s, Module, FunctionGroup, ExecutionVariant",
        "QueryFrequency": {
            "Ticks": 72000000000,
            "Days": 0,
            "Hours": 2,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.08333333333333333,
            "TotalHours": 2,
            "TotalMilliseconds": 7200000,
            "TotalMinutes": 120,
            "TotalSeconds": 7200
        },
        "QueryPeriod": {
            "Ticks": 72000000000,
            "Days": 0,
            "Hours": 2,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.08333333333333333,
            "TotalHours": 2,
            "TotalMilliseconds": 7200000,
            "TotalMinutes": 120,
            "TotalSeconds": 7200
        },
        "Severity": "High",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "Discovery",
            "CommandAndControl"
        ],
        "Name": "fc618e81-94f2-49b4-aefc-010b30dcc56a",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"17001f46-0000-0d00-0000-60dd65a00000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - High - Activation or Deactivation of ICF Service",
        "Description": "Identifies activation or deactivation of ICF Services.\nSource Action: Activate or deactivate a service using SICF.\n*Data Sources: SAPcon - Table Data Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057436071)/",
        "Query": "let ActivatedICF =\r\nABAPTableDataLog_CL\r\n| where TableName_s == \"ICFSERVLOC\"\r\n| lookup ABAPTableDataLog_CL on TimeGenerated, LogKey_s, DBLogID_s // Lookup for combining the data\r\n| where TableField_s == \"ICF_NAME\" // Service name\r\n| where TableField_s1 == \"ICFACTIVE\" // Active status\r\n| where OldValue_s == NewValue_s and OldValue_s != \"\" \r\n| where NewValue_s1 == \"X\" // Status is activated\r\n| project TimeGenerated, Service = NewValue_s, ICFServiceStatus = \"Activated\";\r\nABAPTableDataLog_CL\r\n| where TableName_s == \"ICFSERVLOC\"\r\n| lookup ABAPTableDataLog_CL on TimeGenerated, LogKey_s, DBLogID_s // Lookup for combining the data\r\n| where TableField_s == \"ICF_NAME\" // Service name\r\n| where TableField_s1 == \"ICFACTIVE\" // Active status\r\n| where OldValue_s1 == \"X\" // Was activated\r\n| where NewValue_s1 == \"\" // Not activated now\r\n| where OldValue_s == NewValue_s and OldValue_s != \"\"\r\n| project TimeGenerated, Service = NewValue_s, ICFServiceStatus = \"Deactivated\"\r\n| union ActivatedICF\r\n",
        "QueryFrequency": {
            "Ticks": 72000000000,
            "Days": 0,
            "Hours": 2,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.08333333333333333,
            "TotalHours": 2,
            "TotalMilliseconds": 7200000,
            "TotalMinutes": 120,
            "TotalSeconds": 7200
        },
        "QueryPeriod": {
            "Ticks": 72000000000,
            "Days": 0,
            "Hours": 2,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.08333333333333333,
            "TotalHours": 2,
            "TotalMilliseconds": 7200000,
            "TotalMinutes": 120,
            "TotalSeconds": 7200
        },
        "Severity": "High",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "CommandAndControl",
            "LateralMovement",
            "Persistence"
        ],
        "Name": "f1056f8d-f3b0-49e2-a50f-94b9ea26f0b9",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"100092c0-0000-0d00-0000-60dc689c0000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - High - New ICF Services",
        "Description": "Identifies creation of ICF Services.\nSource Action: Create a service using SICF.\n*Data Sources: SAPcon - Table Data Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057439026)/",
        "Query": "ABAPTableDataLog_CL\r\n| where TableName_s == \"ICFSERVLOC\"\r\n| where TableField_s == \"ICF_NAME\" // Service name\r\n| where OldValue_s == \"\" and NewValue_s != \"\" // New value is inserted in name -> new service\r\n| order by TimeGenerated desc\r\n| project TimeGenerated, Service = NewValue_s",
        "QueryFrequency": {
            "Ticks": 72000000000,
            "Days": 0,
            "Hours": 2,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.08333333333333333,
            "TotalHours": 2,
            "TotalMilliseconds": 7200000,
            "TotalMinutes": 120,
            "TotalSeconds": 7200
        },
        "QueryPeriod": {
            "Ticks": 72000000000,
            "Days": 0,
            "Hours": 2,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.08333333333333333,
            "TotalHours": 2,
            "TotalMilliseconds": 7200000,
            "TotalMinutes": 120,
            "TotalSeconds": 7200
        },
        "Severity": "High",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "CommandAndControl",
            "Persistence",
            "LateralMovement"
        ],
        "Name": "6e8dee6b-d018-4298-bbd1-27a4eb435a8b",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"10009fc0-0000-0d00-0000-60dc689f0000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - High - New ICF Service Handlers",
        "Description": "Identifies creation of ICF Handlers.\nSource Action: Assign a new handler to a service using SICF.\n*Data Sources: SAPcon - Table Data Log*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057442145)/",
        "Query": "ABAPTableDataLog_CL\r\n| where TableName_s == \"ICFHANDLER\"\r\n| where TableField_s == \"ICF_NAME\" // Service name\r\n| where OldValue_s == \"\" and NewValue_s != \"\" // New value is inserted in name -> new service\r\n| order by TimeGenerated desc\r\n| project TimeGenerated, Service = NewValue_s",
        "QueryFrequency": {
            "Ticks": 72000000000,
            "Days": 0,
            "Hours": 2,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.08333333333333333,
            "TotalHours": 2,
            "TotalMilliseconds": 7200000,
            "TotalMinutes": 120,
            "TotalSeconds": 7200
        },
        "QueryPeriod": {
            "Ticks": 72000000000,
            "Days": 0,
            "Hours": 2,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.08333333333333333,
            "TotalHours": 2,
            "TotalMilliseconds": 7200000,
            "TotalMinutes": 120,
            "TotalSeconds": 7200
        },
        "Severity": "High",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": [
            "Persistence",
            "LateralMovement",
            "CommandAndControl"
        ],
        "Name": "db0fe39e-4e2c-4452-bbd7-f3d836f296d7",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"1000b4c0-0000-0d00-0000-60dc68a20000\"",
        "Kind": "Scheduled"
    },
    {
        "AlertRuleTemplateName": null,
        "DisplayName": "(Preview) SAP - Informational - Lifecycle - SAP Notes were implemented in system",
        "Description": "Identifies SAP Notes implementation in the system.\n\nSource Action: Implement SAP Note using SNOTE/TCI.\n\n*Data Sources: SAPcon -  Change Requests*",
        "Enabled": true,
        "LastModifiedUtc": "/Date(1625057445723)/",
        "Query": "// Define variables\r\nlet VarNote = \"NOTE\";\r\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user\r\n// Query logic\r\nlet LastLogin = \r\nABAPAuditLog_CL\r\n| where MessageID_s in (AuditLogIn)\r\n| summarize TimeGenerated = arg_max(TimeGenerated, *) by SystemID_s, ClientID_s, User_s; // Get last connection date for user\r\nABAPCRLog_CL \r\n| where ObjectType_s == VarNote // Type is NOTE\r\n| lookup kind=inner LastLogin on $left.Owner_s == $right.User_s // Get last login details\r\n| summarize by TimeGenerated, SystemID_s, SystemNumber_s, ClientID_s, Owner_s, Request_s, Description_s, ObjectName_s, Category, Status_s, AccountCustomEntity = Email_s, IPCustomEntity = TerminalIPv6_s, HostCustomEntity = Host_s",
        "QueryFrequency": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "QueryPeriod": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "Severity": "Informational",
        "SuppressionDuration": {
            "Ticks": 36000000000,
            "Days": 0,
            "Hours": 1,
            "Milliseconds": 0,
            "Minutes": 0,
            "Seconds": 0,
            "TotalDays": 0.041666666666666664,
            "TotalHours": 1,
            "TotalMilliseconds": 3600000,
            "TotalMinutes": 60,
            "TotalSeconds": 3600
        },
        "SuppressionEnabled": false,
        "TriggerOperator": 0,
        "TriggerThreshold": 0,
        "Tactics": null,
        "Name": "b868a034-5ec1-44ba-8ad7-6dfde186221d",
        "Type": "Microsoft.SecurityInsights/alertRules",
        "Etag": "\"1000bdc0-0000-0d00-0000-60dc68a60000\"",
        "Kind": "Scheduled"
    }
]